<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio do Professor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìñ</text></svg>">
    
    <!-- Scripts do Google API -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisInitialized()"></script>

    <!-- IN√çCIO DO CSS (style.css) -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .hidden,
        .view.hidden {
            display: none;
        }

        .view {
            width: 100%;
            max-width: 600px; /* Reduzido de 800px para deixar a interface mais estreita */
        }
        
        #dashboard-view {
            text-align: center;
        }

        #year-selection-view,
        #main-menu-view,
        #class-registration-view,
        #student-registration-view,
        #period-selection-view,
        #notes-view,
        #activities-view,
        #favorites-view,
        #reports-view,
        #backup-view {
            max-width: 95%; 
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .1);
        }

        .institution-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .institution-buttons button {
            padding: 20px;
            font-size: 1.2em;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color .2s, box-shadow .2s;
            flex-grow: 1;
            min-width: 200px;
        }

        .institution-buttons button:hover {
            background-color: #e9e9e9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
        }

        .management-buttons {
            margin-top: 40px;
        }

        .management-buttons button {
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            border: 1px solid #007bff;
            background-color: #fff;
            color: #007bff;
            border-radius: 5px;
            margin: 0 5px;
        }

        .management-buttons button:hover {
            background-color: #007bff;
            color: #fff;
        }

        .star-icon {
            color: #ffc107;
        }

        .manager-panel {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: left;
        }

        .form-institution,
        #year-form,
        #class-form,
        #assessment-form,
        #import-notes-form,
        #recovery-form,
        #favorite-form,
        #report-filters-form {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: stretch;
            margin-bottom: 20px;
        }

        #visto-form, #continuous-assessment-form, #visto-calc-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        #visto-form .form-row {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }


        .form-institution input,
        .form-institution select,
        .form-institution button,
        #year-form input,
        #year-form button,
        #class-form input,
        #class-form button,
        #assessment-form input,
        #assessment-form button,
        #visto-form input,
        #visto-form button,
        #visto-calc-form input,
        #visto-calc-form button,
        #continuous-assessment-form input,
        #continuous-assessment-form button,
        #import-notes-form input,
        #import-notes-form select,
        #import-notes-form button,
        #recovery-form select,
        #recovery-form button,
        #favorite-form input,
        #favorite-form select,
        #favorite-form button,
        #report-filters-form select,
        #report-filters-form button {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        #visto-description {
            flex-grow: 1;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .list-container .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 5px;
            background-color: #fff;
        }
        
        .list-item.inactive .item-name {
            color: #999;
            text-decoration: line-through;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ccc;
            margin-right: 15px;
        }

        .item-name {
            font-weight: 700;
            flex-grow: 1;
        }

        .item-actions button {
            margin-left: 5px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.2em;
        }

        .global-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between; /* Alterado para espa√ßar os bot√µes e a autentica√ß√£o */
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .header-button-group {
            display: flex;
            gap: 15px;
        }

        .header-bottom-row {
            width: 100%;
        }

        .global-header h2 {
            margin: 0;
            font-size: 1.5em;
            text-align: center;
        }

        .header-btn {
            font-size: 1.5em;
            background: 0 0;
            border: none;
            cursor: pointer;
            padding: 0 5px;
            color: #333;
        }

        /* Estilos para os bot√µes de autentica√ß√£o do Google */
        .auth-container {
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .signin-btn, .signout-btn {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f8f8;
            cursor: pointer;
        }
        .signout-btn {
            background-color: #f44336;
            color: white;
            border-color: #d32f2f;
        }
        
        .header-btn.star-icon {
            color: #ffc107;
        }

        #year-selection-view main,
        #main-menu-view main,
        #class-registration-view main,
        #student-registration-view main,
        #period-selection-view main,
        #notes-view main,
        #activities-view main,
        #favorites-view main,
        #reports-view main,
        #backup-view main {
            text-align: center;
        }

        #year-select,
        #class-selection-for-students,
        #import-from-class-select,
        #period-select,
        #period-class-select {
            width: 100%;
            padding: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .main-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .main-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
        }

        .menu-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menu-button {
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
            border: 1px solid #ddd;
            background-color: #f7f7f7;
            border-radius: 8px;
        }

        .menu-button:hover {
            background-color: #e9e9e9;
        }

        #student-names-textarea,
        #student-list-edit-textarea {
            width: 95%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #student-list-edit-textarea {
            height: 150px;
        }

        /* ESTILOS UNIFICADOS PARA TABELAS */
        .table-container {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: auto;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
        
        .data-table tbody tr:nth-child(even) td {
            background-color: #f9f9f9;
        }
        
        /* NOVO CSS PARA FILTRO */
        .data-table .filter-hidden {
            display: none;
        }
        .student-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Coluna NOME DO ALUNO */
        .data-table th.student-name-header {
            min-width: 200px;
            position: sticky;
            left: 0;
            background-color: #f2f2f2;
            z-index: 2;
        }
        .data-table td:first-child {
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 1;
        }
        .data-table tbody tr:nth-child(even) td:first-child {
            background-color: #f9f9f9;
        }
        
        .data-table tr.inactive-student-row td {
            background-color: #f0f0f0;
            color: #aaa;
        }
        .data-table tr.inactive-student-row td:first-child {
             background-color: #e9e9e9;
        }


        /* Coluna TOTAL / M√âDIA */
        .data-table th.result-header {
            width: 100px;
            min-width: 100px;
            position: sticky;
            left: 200px; 
            background-color: #e9ecef;
            z-index: 2;
        }
        .data-table td.result-cell {
            position: sticky;
            left: 200px; 
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
            z-index: 1;
        }
         .data-table tbody tr:nth-child(even) td.result-cell {
            background-color: #f1f3f5;
        }

        /* Coluna SITUA√á√ÉO */
        .data-table th.situation-col {
            width: 120px;
            min-width: 120px;
        }
        .data-table td.situation-cell {
            text-align: center;
        }

        .col-header {
            text-align: center;
            width: 1%;
        }
        .col-header > div:first-child {
            font-weight: bold;
        }
        .col-header-actions {
            font-size: 0.8em;
            margin-top: 5px;
        }
        .col-header-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 1.2em;
        }
        .data-table .data-cell {
            text-align: center;
        }
        .data-cell input[type="number"], .data-cell select {
            width: 80px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }
        .data-cell .grade-text {
            display: inline-block;
        }
        .data-cell .grade-input {
            display: none;
        }
        .data-cell.editing .grade-text {
            display: none;
        }
        .data-cell.editing .grade-input {
            display: inline-block;
        }
        
        /* Estilos para compactar a tabela de relat√≥rio */
        #report-output-container .report-content h3,
        #report-output-container .report-content h4 {
            text-align: center;
        }
        #report-output-container .report-content.align-left { text-align: left; }
        #report-output-container .report-content.align-center { text-align: center; }
        #report-output-container .report-content.align-right { text-align: right; }

        #report-output-container .data-table {
            width: auto; 
            display: inline-block;
        }
        #report-output-container .data-table th {
            padding: 4px 6px; 
            font-size: 0.9em; 
            text-align: center;
        }
        #report-output-container .data-table td {
            padding: 4px 6px; 
            font-size: 0.9em; 
            text-align: center;
        }
        #report-output-container .data-table td:first-child {
            text-align: left;
        }
        .report-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }
        .align-controls button {
            padding: 5px 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .align-controls button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* CSS para o Modal Customizado */
        #custom-modal-overlay, #import-notes-modal-overlay, #recovery-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #custom-modal-overlay.hidden, #import-notes-modal-overlay.hidden, #recovery-modal-overlay.hidden {
            display: none;
        }

        .custom-modal-content {
            background-color: white;
            padding: 25px 35px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            text-align: center;
            max-width: 90%;
            width: 400px;
        }

        #custom-modal-message {
            margin: 0;
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.5;
        }

        #custom-modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
            font-weight: bold;
        }

        #modal-confirm-btn {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        #modal-cancel-btn {
            background-color: #f0f0f0;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .report-content, .report-content * {
                visibility: visible;
            }
            .report-content {
                page-break-after: always;
            }
            .report-content:last-of-type {
                page-break-after: auto;
            }
            #report-output-container hr {
                display: none;
            }
            #report-output-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 10px;
                box-shadow: none;
                border: none;
            }
            #report-output-container h3, #report-output-container h4 {
                text-align: center;
                color: black;
            }
            #report-output-container table {
                width: auto; /* Alterado de 100% para auto para impress√£o */
                font-size: 8pt; /* Fonte menor para caber mais colunas */
                color: black;
                border-collapse: collapse; 
                border: 1px solid #333; 
            }
            #report-output-container.align-left { justify-content: flex-start; }
            #report-output-container.align-center { justify-content: center; }
            #report-output-container.align-right { justify-content: flex-end; }
            #report-output-container th, #report-output-container td {
                border: 1px solid #333 !important;
                background-color: white !important;
                position: static !important;
            }
            .report-controls { 
                display: none; 
            }
        }

    </style>
    <!-- FIM DO CSS -->
</head>
<body>

    <!-- IN√çCIO DO HTML (index.html) -->
    <div id="dashboard-view" class="view">
        <header class="dashboard-header"><h1>Di√°rio do Professor</h1></header>
        <main class="dashboard-main">
            <div id="institution-buttons-container" class="institution-buttons"></div>
            <div class="management-buttons">
                <button id="manage-institutions-btn">Gerenciar Institui√ß√µes</button>
                <button id="favorites-btn"><span class="star-icon">‚òÖ</span> Favoritos</button>
                <button class="reports-main-btn">üñ®Ô∏è Relat√≥rios</button>
                <button class="backup-btn">‚ÜïÔ∏è Backup</button>
            </div>
             <div id="auth-section" class="manager-panel" style="margin-top: 30px;">
                <h4>Sincroniza√ß√£o com Google Drive</h4>
                <div id="api-status">Inicializando...</div>
                <div class="auth-container" style="justify-content: center; margin-top: 10px;">
                    <span class="auth-status"></span>
                    <button class="signin-btn hidden">Fazer login com Google</button>
                    <button class="signout-btn hidden">Sair</button>
                </div>
            </div>
        </main>
        <div id="institution-manager-panel" class="manager-panel hidden">
            <h2>Gerenciar Institui√ß√µes</h2>
            <form id="institution-form" class="form-institution">
                <input type="hidden" id="institution-id">
                <input type="text" id="institution-name" placeholder="Nome da Institui√ß√£o" required>
                <select id="institution-period-type" required>
                    <option value="" disabled selected>Selecione o Per√≠odo</option>
                    <option value="Bimestral">Bimestral</option>
                    <option value="Trimestral">Trimestral</option>
                    <option value="Semestral">Semestral</option>
                </select>
                <input type="number" step="0.1" id="institution-passing-grade" placeholder="M√©dia" required>
                <div class="color-picker-wrapper">
                    <label for="institution-main-color">Cor:</label>
                    <input type="color" id="institution-main-color" value="#007bff">
                    <input type="text" id="institution-main-color-text" placeholder="#007bff" size="7">
                </div>
                <button type="submit">Salvar Institui√ß√£o</button>
                <button type="button" id="cancel-edit-btn" class="hidden">Cancelar Edi√ß√£o</button>
            </form>
            <hr>
            <h3>Institui√ß√µes Cadastradas</h3>
            <div id="institution-list" class="list-container"></div>
        </div>
    </div>

    <div id="year-selection-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="year-sel-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="home-btn" class="header-btn">üè†</button>
                    <button id="favorites-header-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-year" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2 id="year-selection-title"></h2>
            </div>
        </header>
        <main>
            <h3>Selecione o Ano Letivo</h3>
            <select id="year-select"><option>Nenhum ano letivo cadastrado</option></select>
            <div class="main-buttons">
                <button id="confirm-year-btn">Confirmar Ano Selecionado</button>
                <button id="manage-years-btn">Gerenciar Anos Letivos</button>
            </div>
            <div id="year-manager-panel" class="manager-panel hidden">
                <hr>
                <h4>Gerenciar Anos Letivos</h4>
                <form id="year-form">
                    <input type="number" id="year-input" placeholder="Digite o ano (ex: 2025)" required>
                    <button type="submit">Adicionar Ano</button>
                </form>
                <div id="year-list" class="list-container"></div>
            </div>
        </main>
    </div>

    <div id="main-menu-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="main-menu-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="main-menu-home-btn" class="header-btn">üè†</button>
                    <button id="main-menu-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-main" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2 id="main-menu-title"></h2>
            </div>
        </header>
        <main>
            <div class="menu-buttons-container">
                <button id="goto-class-registration-btn" class="menu-button">Cadastro de Turmas</button>
                <button id="goto-student-registration-btn" class="menu-button">Cadastro de Alunos</button>
                <button id="goto-period-selection-btn" class="menu-button">Selecionar Per√≠odo</button>
            </div>
        </main>
    </div>

    <div id="class-registration-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="class-reg-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="class-reg-home-btn" class="header-btn">üè†</button>
                    <button id="class-reg-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-class" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2 id="class-reg-title">Cadastro de Turmas</h2>
            </div>
        </header>
        <main>
            <div class="manager-panel">
                <form id="class-form" class="form-institution">
                    <input type="hidden" id="class-id">
                    <input type="text" id="class-name-input" placeholder="Nome da Turma (ex: 6¬∫ Ano A)" required>
                    <input type="text" id="class-subject-input" placeholder="Mat√©ria (ex: L√≠ngua Portuguesa)" required>
                    <button type="submit">Salvar Turma</button>
                </form>
                <hr>
                <h3>Turmas Cadastradas</h3>
                <div id="class-list-container" class="list-container"></div>
            </div>
        </main>
    </div>

    <div id="student-registration-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="student-reg-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="student-reg-home-btn" class="header-btn">üè†</button>
                    <button id="student-reg-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-student" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2 id="student-reg-title">Cadastro de Alunos</h2>
            </div>
        </header>
        <main>
            <div class="manager-panel">
                <label for="class-selection-for-students">Selecione uma turma para gerenciar os alunos:</label>
                <select id="class-selection-for-students"></select>
            </div>
            <div id="student-entry-container" class="manager-panel hidden">
                <h4>Adicionar Novos Alunos</h4>
                <p>Digite um nome por linha. Eles ser√£o numerados automaticamente.</p>
                <textarea id="student-names-textarea" rows="10" placeholder="Ana Silva&#10;Bruno Costa&#10;Carla Dias"></textarea>
                <div class="main-buttons">
                    <button id="add-students-btn">Adicionar Alunos</button>
                    <button id="edit-student-list-btn">Editar Lista</button>
                    <button id="import-students-btn">Importar Alunos</button>
                    <button id="inactivate-students-btn">Inativar Alunos</button>
                </div>
                
                <div id="student-list-edit-panel" class="manager-panel hidden">
                    <h4>Editando a Lista de Alunos</h4>
                    <p>Ajuste os nomes, adicione ou remova linhas. A lista ser√° salva e renumerada.</p>
                    <textarea id="student-list-edit-textarea" rows="15"></textarea>
                    <div class="main-buttons">
                        <button id="save-student-list-btn">Salvar Lista</button>
                        <button type="button" id="cancel-student-list-edit-btn">Cancelar</button>
                    </div>
                </div>

                <div id="inactivate-student-list-panel" class="manager-panel hidden">
                    <h4>Gerenciar Status dos Alunos</h4>
                    <p>Desmarque os alunos que foram transferidos ou sa√≠ram.</p>
                    <div id="inactivate-list-container" class="list-container" style="max-height: 300px; overflow-y: auto;"></div>
                    <div class="main-buttons">
                        <button id="save-inactivate-list-btn">Salvar Status</button>
                        <button type="button" id="cancel-inactivate-list-btn">Cancelar</button>
                    </div>
                </div>

                <div id="student-import-panel" class="manager-panel hidden">
                    <h4>Importar Alunos de outra Turma</h4>
                    <label for="import-from-class-select">Importar da turma:</label>
                    <select id="import-from-class-select"></select>
                    <div class="main-buttons">
                        <button id="confirm-import-btn">Confirmar Importa√ß√£o</button>
                        <button type="button" id="cancel-import-btn">Cancelar</button>
                    </div>
                </div>

                <hr>
                <h3>Alunos na Turma</h3>
                <div id="student-list-container" class="list-container"></div>
            </div>
        </main>
    </div>

    <div id="period-selection-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="period-sel-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="period-sel-home-btn" class="header-btn">üè†</button>
                    <button id="period-sel-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-period" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                 <h2 id="period-sel-title"></h2>
            </div>
        </header>
        <main>
            <div class="manager-panel">
                <label for="period-select">Selecione o Per√≠odo:</label>
                <select id="period-select"></select>
            </div>
            <div id="period-class-selection-container" class="manager-panel hidden">
                 <label for="period-class-select">Selecione a Turma:</label>
                 <select id="period-class-select"></select>
            </div>
            <div id="period-actions-container" class="main-buttons hidden"></div>
        </main>
    </div>

    <div id="notes-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="notes-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="notes-home-btn" class="header-btn">üè†</button>
                    <button id="notes-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-notes" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                 <h2 id="notes-title">Lan√ßamento de Notas</h2>
            </div>
        </header>
        <main>
            <div class="main-buttons">
                <button id="add-assessment-btn">Adicionar Avalia√ß√£o</button>
                <button id="import-notes-btn">Importar Notas</button>
                <button id="recovery-btn">Recupera√ß√£o</button>
                <button id="calculate-notes-btn">Calcular</button>
                <button id="calculate-final-grades-btn" class="hidden">Calcular</button>
                <button id="add-annual-recovery-btn" class="hidden">Recupera√ß√£o Anual</button>
            </div>
            <div id="assessment-panel" class="manager-panel hidden">
                <form id="assessment-form">
                    <input type="hidden" id="assessment-id">
                    <input type="text" id="assessment-name" placeholder="Nome da Avalia√ß√£o (ex: P1)" required>
                    <input type="number" id="assessment-value" placeholder="Valor (ex: 10.0)" step="0.1" required>
                    <button type="submit">Salvar Avalia√ß√£o</button>
                    <button type="button" id="cancel-assessment-edit-btn">Cancelar</button>
                </form>
            </div>
            <div class="table-container">
                <table id="notes-table" class="data-table">
                    <thead>
                        <tr id="notes-table-header">
                            <th class="student-name-header">Aluno</th>
                        </tr>
                    </thead>
                    <tbody id="notes-table-body">
                    </tbody>
                </table>
            </div>
             <div id="edit-all-notes-container" class="main-buttons">
                <button id="edit-all-notes-btn">Editar Todas as Notas</button>
            </div>
        </main>
    </div>

    <div id="activities-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="activities-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="activities-home-btn" class="header-btn">üè†</button>
                    <button id="activities-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-activities" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                 <h2 id="activities-title">Atividades</h2>
            </div>
        </header>
        <main>
            <div class="main-buttons">
                <button id="toggle-vistos-panel-btn">Vistos</button>
                <button id="toggle-continuous-assessment-panel-btn">Avalia√ß√µes Cont√≠nuas</button>
            </div>

            <div id="vistos-panel" class="manager-panel hidden">
                <div class="main-buttons">
                    <button id="add-visto-btn" style="font-size: 1.5em; padding: 5px 12px;">+</button>
                    <button id="calculate-vistos-btn">Calcular</button>
                </div>
                <div id="visto-form-panel" class="manager-panel hidden">
                    <form id="visto-form">
                        <div class="form-row">
                            <input type="date" id="visto-date" required>
                            <input type="text" id="visto-description" placeholder="Descri√ß√£o da atividade" required>
                        </div>
                        <div class="form-row">
                            <input type="hidden" id="visto-id">
                            <button type="submit">Salvar</button>
                            <button type="button" id="cancel-visto-edit-btn">Cancelar</button>
                        </div>
                    </form>
                </div>
                <div id="visto-calc-panel" class="manager-panel hidden">
                    <form id="visto-calc-form">
                        <input type="number" id="visto-calc-total-value" placeholder="Valor Total (ex: 4,0)" step="0.1" required>
                        <button type="submit">OK</button>
                        <button type="button" id="cancel-visto-calc-btn">Cancelar</button>
                    </form>
                </div>
                <div class="table-container">
                    <table id="vistos-table" class="data-table">
                        <thead>
                            <tr id="vistos-table-header">
                                <th class="student-name-header">Aluno</th>
                            </tr>
                        </thead>
                        <tbody id="vistos-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="continuous-assessment-panel" class="manager-panel hidden">
                <div class="main-buttons">
                    <button id="add-continuous-assessment-btn" style="font-size: 1.5em; padding: 5px 12px;">+</button>
                    <button id="calculate-continuous-assessment-btn">Calcular</button>
                </div>
                <div id="continuous-assessment-form-panel" class="manager-panel hidden">
                    <form id="continuous-assessment-form">
                        <input type="hidden" id="continuous-assessment-id">
                        <input type="date" id="continuous-assessment-date" required>
                        <button type="submit">Salvar</button>
                        <button type="button" id="cancel-continuous-assessment-edit-btn">Cancelar</button>
                    </form>
                </div>
                <div class="table-container">
                    <table id="continuous-assessment-table" class="data-table">
                        <thead>
                            <tr id="continuous-assessment-table-header">
                                <th class="student-name-header">Aluno</th>
                            </tr>
                        </thead>
                        <tbody id="continuous-assessment-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="main-buttons">
                    <button id="edit-all-continuous-assessments-btn">Editar Todas as Notas</button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="favorites-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="favorites-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="favorites-home-btn" class="header-btn">üè†</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2>Favoritos</h2>
            </div>
        </header>
        <main>
            <div class="main-buttons">
                <button id="add-favorite-btn">Adicionar Favorito</button>
            </div>
            <div id="favorite-form-panel" class="manager-panel hidden">
                <h4>Novo Atalho Favorito</h4>
                <form id="favorite-form">
                    <input type="text" id="favorite-name-input" placeholder="Nome do Atalho" required>
                    <select id="favorite-institution-select" required>
                        <option value="">Selecione uma Institui√ß√£o</option>
                    </select>
                    <select id="favorite-year-select" required>
                        <option value="">Selecione um Ano Letivo</option>
                    </select>
                    <select id="favorite-period-select" required>
                        <option value="">Selecione um Per√≠odo</option>
                    </select>
                    <button type="submit">Salvar Favorito</button>
                </form>
            </div>
            <hr>
            <h3>Meus Atalhos</h3>
            <div id="favorite-list-container" class="list-container"></div>
        </main>
    </div>

    <div id="reports-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="reports-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="reports-home-btn" class="header-btn">üè†</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2>Relat√≥rios</h2>
            </div>
        </header>
        <main>
            <div class="manager-panel">
                <h4>Filtros do Relat√≥rio</h4>
                <form id="report-filters-form">
                    <select id="report-institution-select" required>
                        <option value="">Selecione uma Institui√ß√£o</option>
                    </select>
                    <select id="report-year-select" required>
                        <option value="">Selecione um Ano Letivo</option>
                    </select>
                    <select id="report-class-select" required>
                        <option value="">Selecione uma Turma</option>
                    </select>
                    <select id="report-period-select" required>
                        <option value="">Selecione um Per√≠odo</option>
                    </select>
                    <select id="report-type-select" required>
                        <option value="">Selecione um Tipo de Relat√≥rio</option>
                    </select>
                    <button type="submit">Gerar Relat√≥rio</button>
                </form>
            </div>
            <div id="report-output-container">
                <!-- O relat√≥rio gerado aparecer√° aqui -->
            </div>
        </main>
    </div>

    <div id="backup-view" class="view hidden">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="backup-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="backup-home-btn" class="header-btn">üè†</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2>Backup / Restaura√ß√£o</h2>
            </div>
        </header>
        <main>
            <div class="menu-buttons-container">
                <button id="export-backup-btn" class="menu-button">Exportar Backup</button>
                <button id="import-backup-btn" class="menu-button">Importar Backup</button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
        </main>
    </div>

    <div id="custom-modal-overlay" class="hidden">
      <div id="custom-modal" class="custom-modal-content">
        <p id="custom-modal-message"></p>
        <div id="custom-modal-buttons">
          <button id="modal-confirm-btn">OK</button>
          <button id="modal-cancel-btn">Cancelar</button>
        </div>
      </div>
    </div>

    <div id="import-notes-modal-overlay" class="hidden">
      <div id="import-notes-modal" class="custom-modal-content">
        <h4>Importar Notas de Atividades</h4>
        <form id="import-notes-form">
            <label for="import-notes-name">Nome da Nova Avalia√ß√£o:</label>
            <input type="text" id="import-notes-name" required>
            
            <label for="import-notes-source">Fonte dos Dados:</label>
            <select id="import-notes-source" required></select>
            
            <div class="main-buttons">
                <button type="submit">Importar</button>
                <button type="button" id="cancel-import-notes-btn">Cancelar</button>
            </div>
        </form>
      </div>
    </div>

    <div id="recovery-modal-overlay" class="hidden">
      <div id="recovery-modal" class="custom-modal-content">
        <h4>Selecione o Tipo de Recupera√ß√£o</h4>
        <form id="recovery-form">
            <select id="recovery-type-select">
                <option value="">-- Selecione --</option>
                <option value="assessment">Recupera√ß√£o de Avalia√ß√£o</option>
                <option value="period">Recupera√ß√£o do Per√≠odo</option>
            </select>
            <div id="recovery-assessment-selection" class="hidden">
                <label for="recovery-assessment-select">Selecione a Avalia√ß√£o:</label>
                <select id="recovery-assessment-select"></select>
            </div>
            <div class="main-buttons">
                <button type="submit">Criar</button>
                <button type="button" id="cancel-recovery-btn">Cancelar</button>
            </div>
        </form>
      </div>
    </div>
    <!-- FIM DO HTML -->

    <!-- IN√çCIO DO JAVASCRIPT (script.js) -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURA√á√ÉO DA API DO GOOGLE ---
        // IMPORTANTE: Substitua os valores abaixo pelas suas pr√≥prias chaves
        const API_KEY = 'AIzaSyBmGYAe3TPI7Gs0zwINQLKqenXHRbR61Ec';
        const CLIENT_ID = '909505950040-8ggrg5mtrf05vip1tr8hi07p9f39tsd5.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // --- BANCO DE DADOS (localStorage) ---
        let institutions = JSON.parse(localStorage.getItem('institutions_db')) || [];
        let anosLetivos = JSON.parse(localStorage.getItem('anos_letivos_db')) || [];
        let turmas = JSON.parse(localStorage.getItem('turmas_db')) || [];
        let alunos = JSON.parse(localStorage.getItem('alunos_db')) || [];
        let avaliacoes = JSON.parse(localStorage.getItem('avaliacoes_db')) || [];
        let vistos = JSON.parse(localStorage.getItem('vistos_db')) || [];
        let vistosResults = JSON.parse(localStorage.getItem('vistos_results_db')) || [];
        let continuousAssessments = JSON.parse(localStorage.getItem('continuous_assessments_db')) || [];
        let continuousAssessmentsResults = JSON.parse(localStorage.getItem('continuous_assessments_results_db')) || [];
        let notesResults = JSON.parse(localStorage.getItem('notes_results_db')) || [];
        let favorites = JSON.parse(localStorage.getItem('favorites_db')) || [];
        let annualRecoveryState = JSON.parse(localStorage.getItem('annual_recovery_state_db')) || {};

        // --- ESTADO DA APLICA√á√ÉO ---
        let selectedInstitutionId = null;
        let selectedYearId = null;
        let selectedClassId = null;
        let selectedPeriod = null;
        let viewHistory = [];

        // --- FUN√á√ïES DE SALVAMENTO ---
        const saveInstitutions = () => localStorage.setItem('institutions_db', JSON.stringify(institutions));
        const saveAnosLetivos = () => localStorage.setItem('anos_letivos_db', JSON.stringify(anosLetivos));
        const saveTurmas = () => localStorage.setItem('turmas_db', JSON.stringify(turmas));
        const saveAlunos = () => localStorage.setItem('alunos_db', JSON.stringify(alunos));
        const saveAvaliacoes = () => localStorage.setItem('avaliacoes_db', JSON.stringify(avaliacoes));
        const saveVistos = () => localStorage.setItem('vistos_db', JSON.stringify(vistos));
        const saveVistosResults = () => localStorage.setItem('vistos_results_db', JSON.stringify(vistosResults));
        const saveContinuousAssessments = () => localStorage.setItem('continuous_assessments_db', JSON.stringify(continuousAssessments));
        const saveContinuousAssessmentsResults = () => localStorage.setItem('continuous_assessments_results_db', JSON.stringify(continuousAssessmentsResults));
        const saveNotesResults = () => localStorage.setItem('notes_results_db', JSON.stringify(notesResults));
        const saveFavorites = () => localStorage.setItem('favorites_db', JSON.stringify(favorites));
        const saveAnnualRecoveryState = () => localStorage.setItem('annual_recovery_state_db', JSON.stringify(annualRecoveryState));

        // --- ELEMENTOS DO DOM ---
        const allReportsBtns = document.querySelectorAll('[id^="reports-header-btn-"], .reports-main-btn');
        const allFavoritesBtns = document.querySelectorAll('#favorites-btn, #favorites-header-btn, #main-menu-favorites-btn, #class-reg-favorites-btn, #student-reg-favorites-btn, #period-sel-favorites-btn, #notes-favorites-btn, #activities-favorites-btn');
        const homeBtns = document.querySelectorAll('#home-btn, #main-menu-home-btn, #class-reg-home-btn, #student-reg-home-btn, #period-sel-home-btn, #notes-home-btn, #activities-home-btn, #favorites-home-btn, #reports-home-btn, #backup-home-btn');
        const backBtns = document.querySelectorAll('#year-sel-back-btn, #main-menu-back-btn, #class-reg-back-btn, #student-reg-back-btn, #period-sel-back-btn, #notes-back-btn, #activities-back-btn, #favorites-back-btn, #reports-back-btn, #backup-back-btn');
        const backupBtns = document.querySelectorAll('.backup-btn');
        const gotoStudentRegistrationBtn = document.getElementById('goto-student-registration-btn');
        const gotoPeriodSelectionBtn = document.getElementById('goto-period-selection-btn');
        const classSelectionForStudents = document.getElementById('class-selection-for-students');
        const studentEntryContainer = document.getElementById('student-entry-container');
        const addStudentsBtn = document.getElementById('add-students-btn');
        const studentListContainer = document.getElementById('student-list-container');
        const editStudentListBtn = document.getElementById('edit-student-list-btn');
        const studentListEditPanel = document.getElementById('student-list-edit-panel');
        const cancelStudentListEditBtn = document.getElementById('cancel-student-list-edit-btn');
        const saveStudentListBtn = document.getElementById('save-student-list-btn');
        const importStudentsBtn = document.getElementById('import-students-btn');
        const studentImportPanel = document.getElementById('student-import-panel');
        const importFromClassSelect = document.getElementById('import-from-class-select');
        const confirmImportBtn = document.getElementById('confirm-import-btn');
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const inactivateStudentsBtn = document.getElementById('inactivate-students-btn');
        const inactivateStudentListPanel = document.getElementById('inactivate-student-list-panel');
        const inactivateListContainer = document.getElementById('inactivate-list-container');
        const saveInactivateListBtn = document.getElementById('save-inactivate-list-btn');
        const cancelInactivateListBtn = document.getElementById('cancel-inactivate-list-btn');
        const periodSelect = document.getElementById('period-select');
        const periodClassSelectionContainer = document.getElementById('period-class-selection-container');
        const periodClassSelect = document.getElementById('period-class-select');
        const periodActionsContainer = document.getElementById('period-actions-container');
        const institutionButtonsContainer = document.getElementById('institution-buttons-container');
        const manageInstitutionsBtn = document.getElementById('manage-institutions-btn');
        const institutionManagerPanel = document.getElementById('institution-manager-panel');
        const institutionForm = document.getElementById('institution-form');
        const institutionListContainer = document.getElementById('institution-list');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const colorPicker = document.getElementById('institution-main-color');
        const colorText = document.getElementById('institution-main-color-text');
        const confirmYearBtn = document.getElementById('confirm-year-btn');
        const yearSelectDropdown = document.getElementById('year-select');
        const manageYearsBtn = document.getElementById('manage-years-btn');
        const yearManagerPanel = document.getElementById('year-manager-panel');
        const yearForm = document.getElementById('year-form');
        const yearListContainer = document.getElementById('year-list');
        const gotoClassRegistrationBtn = document.getElementById('goto-class-registration-btn');
        const classForm = document.getElementById('class-form');
        const classListContainer = document.getElementById('class-list-container');
        
        const notesView = document.getElementById('notes-view');
        const calculateFinalGradesBtn = document.getElementById('calculate-final-grades-btn');
        const addAnnualRecoveryBtn = document.getElementById('add-annual-recovery-btn');
        const addAssessmentBtn = document.getElementById('add-assessment-btn');
        const importNotesBtn = document.getElementById('import-notes-btn');
        const assessmentPanel = document.getElementById('assessment-panel');
        const assessmentForm = document.getElementById('assessment-form');
        const cancelAssessmentEditBtn = document.getElementById('cancel-assessment-edit-btn');
        const notesTableBody = document.getElementById('notes-table-body');
        const notesTableHeader = document.getElementById('notes-table-header');
        const editAllNotesContainer = document.getElementById('edit-all-notes-container');
        const editAllNotesBtn = document.getElementById('edit-all-notes-btn');
        const calculateNotesBtn = document.getElementById('calculate-notes-btn');
        const recoveryBtn = document.getElementById('recovery-btn');

        const activitiesView = document.getElementById('activities-view');
        const toggleVistosPanelBtn = document.getElementById('toggle-vistos-panel-btn');
        const vistosPanel = document.getElementById('vistos-panel');
        const addVistoBtn = document.getElementById('add-visto-btn');
        const vistoFormPanel = document.getElementById('visto-form-panel');
        const vistoForm = document.getElementById('visto-form');
        const cancelVistoEditBtn = document.getElementById('cancel-visto-edit-btn');
        const vistosTableHeader = document.getElementById('vistos-table-header');
        const vistosTableBody = document.getElementById('vistos-table-body');
        const calculateVistosBtn = document.getElementById('calculate-vistos-btn');
        const vistoCalcPanel = document.getElementById('visto-calc-panel');
        const vistoCalcForm = document.getElementById('visto-calc-form');
        const cancelVistoCalcBtn = document.getElementById('cancel-visto-calc-btn');

        const toggleContinuousAssessmentPanelBtn = document.getElementById('toggle-continuous-assessment-panel-btn');
        const continuousAssessmentPanel = document.getElementById('continuous-assessment-panel');
        const addContinuousAssessmentBtn = document.getElementById('add-continuous-assessment-btn');
        const continuousAssessmentFormPanel = document.getElementById('continuous-assessment-form-panel');
        const continuousAssessmentForm = document.getElementById('continuous-assessment-form');
        const cancelContinuousAssessmentEditBtn = document.getElementById('cancel-continuous-assessment-edit-btn');
        const continuousAssessmentTableHeader = document.getElementById('continuous-assessment-table-header');
        const continuousAssessmentTableBody = document.getElementById('continuous-assessment-table-body');
        const calculateContinuousAssessmentBtn = document.getElementById('calculate-continuous-assessment-btn');
        const editAllContinuousAssessmentsBtn = document.getElementById('edit-all-continuous-assessments-btn');

        const importNotesModalOverlay = document.getElementById('import-notes-modal-overlay');
        const importNotesForm = document.getElementById('import-notes-form');
        const cancelImportNotesBtn = document.getElementById('cancel-import-notes-btn');
        const importNotesSourceSelect = document.getElementById('import-notes-source');

        const recoveryModalOverlay = document.getElementById('recovery-modal-overlay');
        const recoveryForm = document.getElementById('recovery-form');
        const recoveryTypeSelect = document.getElementById('recovery-type-select');
        const recoveryAssessmentSelection = document.getElementById('recovery-assessment-selection');
        const recoveryAssessmentSelect = document.getElementById('recovery-assessment-select');
        const cancelRecoveryBtn = document.getElementById('cancel-recovery-btn');

        const addFavoriteBtn = document.getElementById('add-favorite-btn');
        const favoriteFormPanel = document.getElementById('favorite-form-panel');
        const favoriteForm = document.getElementById('favorite-form');
        const favoriteInstitutionSelect = document.getElementById('favorite-institution-select');
        const favoriteYearSelect = document.getElementById('favorite-year-select');
        const favoritePeriodSelect = document.getElementById('favorite-period-select');
        const favoriteListContainer = document.getElementById('favorite-list-container');

        const reportFiltersForm = document.getElementById('report-filters-form');
        const reportInstitutionSelect = document.getElementById('report-institution-select');
        const reportYearSelect = document.getElementById('report-year-select');
        const reportClassSelect = document.getElementById('report-class-select');
        const reportPeriodSelect = document.getElementById('report-period-select');
        const reportTypeSelect = document.getElementById('report-type-select');
        const reportOutputContainer = document.getElementById('report-output-container');

        const exportBackupBtn = document.getElementById('export-backup-btn');
        const importBackupBtn = document.getElementById('import-backup-btn');
        const importFileInput = document.getElementById('import-file-input');

        // --- MODAL CUSTOMIZADO ---
        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalMessage = document.getElementById('custom-modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let resolvePromise;

        function showModal(message, isConfirm = false) {
            return new Promise((resolve) => {
                resolvePromise = resolve;
                modalMessage.textContent = message;
                modalCancelBtn.style.display = isConfirm ? 'inline-block' : 'none';
                modalConfirmBtn.textContent = isConfirm ? 'Confirmar' : 'OK';
                modalOverlay.classList.remove('hidden');
            });
        }

        function hideModal(result) {
            modalOverlay.classList.add('hidden');
            if (resolvePromise) {
                resolvePromise(result);
            }
        }
        modalConfirmBtn.addEventListener('click', () => hideModal(true));
        modalCancelBtn.addEventListener('click', () => hideModal(false));

        // --- FUN√á√ïES DE NAVEGA√á√ÉO ---
        function navigateTo(viewId, context = null, isNavigatingBack = false) {
            const currentView = document.querySelector('.view:not(.hidden)');
            if (currentView && !isNavigatingBack) {
                viewHistory.push(currentView.id);
            }
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            if (viewId === 'dashboard-view') {
                viewHistory = [];
                renderInstitutionButtons();
            }

            // Busca os dados necess√°rios dentro de cada bloco condicional para garantir que os IDs estejam atualizados
            if (viewId === 'year-selection-view' && context) {
                selectedInstitutionId = context.institutionId;
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                if (institution) {
                    document.getElementById('year-selection-title').textContent = institution.name;
                }
                renderAnosLetivos();
            } else if (viewId === 'main-menu-view') {
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                const anoLetivo = anosLetivos.find(a => a.id === selectedYearId);
                if (institution && anoLetivo) {
                    document.getElementById('main-menu-title').textContent = `${institution.name} - ${anoLetivo.year}`;
                }
            } else if (viewId === 'class-registration-view') {
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                const anoLetivo = anosLetivos.find(a => a.id === selectedYearId);
                if (institution && anoLetivo) {
                    document.getElementById('class-reg-title').textContent = `${institution.name} - ${anoLetivo.year} - Turmas`;
                }
                renderTurmas();
            } else if (viewId === 'student-registration-view') {
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                const anoLetivo = anosLetivos.find(a => a.id === selectedYearId);
                if (institution && anoLetivo) {
                    document.getElementById('student-reg-title').textContent = `${institution.name} - ${anoLetivo.year} - Alunos`;
                }
                renderClassSelectionForStudents();
            } else if (viewId === 'period-selection-view') {
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                const anoLetivo = anosLetivos.find(a => a.id === selectedYearId);
                if (institution && anoLetivo) {
                    document.getElementById('period-sel-title').textContent = `${institution.name} - ${anoLetivo.year} - Per√≠odos`;
                }
                renderPeriodSelection();

                if ((isNavigatingBack && selectedPeriod) || (context && context.fromFavorite)) {
                    periodSelect.value = selectedPeriod;
                    periodSelect.dispatchEvent(new Event('change'));

                    if (selectedClassId) {
                        periodClassSelect.value = selectedClassId;
                        periodClassSelect.dispatchEvent(new Event('change'));
                    }
                }
            } else if (viewId === 'notes-view') {
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                const anoLetivo = anosLetivos.find(a => a.id === selectedYearId);
                const turma = turmas.find(t => t.id === selectedClassId);
                if (institution && anoLetivo && turma) {
                    document.getElementById('notes-title').textContent = `${institution.name} - ${anoLetivo.year} - ${turma.name} - ${selectedPeriod} - ${turma.subject}`;
                }
                if (selectedPeriod === 'M√©dias Finais') {
                    addAssessmentBtn.style.display = 'none';
                    importNotesBtn.style.display = 'none';
                    recoveryBtn.style.display = 'none';
                    calculateNotesBtn.style.display = 'none';
                    calculateFinalGradesBtn.style.display = 'inline-block';
                    addAnnualRecoveryBtn.style.display = 'inline-block';
                    editAllNotesContainer.style.display = 'none';

                    if (!annualRecoveryState[selectedClassId]) {
                        annualRecoveryState[selectedClassId] = { added: false, editing: false, grades: [] };
                    }
                    addAnnualRecoveryBtn.disabled = annualRecoveryState[selectedClassId].added;
                    renderFinalGradesView();
                } else {
                    addAssessmentBtn.style.display = 'inline-block';
                    importNotesBtn.style.display = 'inline-block';
                    recoveryBtn.style.display = 'inline-block';
                    calculateNotesBtn.style.display = 'inline-block';
                    calculateFinalGradesBtn.style.display = 'none';
                    addAnnualRecoveryBtn.style.display = 'none';
                    editAllNotesContainer.style.display = 'flex';
                    renderNotesView();
                }
            } else if (viewId === 'activities-view') {
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                const anoLetivo = anosLetivos.find(a => a.id === selectedYearId);
                const turma = turmas.find(t => t.id === selectedClassId);
                if (institution && anoLetivo && turma) {
                    document.getElementById('activities-title').textContent = `${institution.name} - ${anoLetivo.year} - ${turma.name} - ${selectedPeriod} - ${turma.subject}`;
                }
                vistosPanel.classList.add('hidden');
                continuousAssessmentPanel.classList.add('hidden');
            } else if (viewId === 'favorites-view') {
                renderFavorites();
            } else if (viewId === 'reports-view') {
                renderReportFilters();
            }
        }
        const navigateBack = () => { if (viewHistory.length > 0) { const previousViewId = viewHistory.pop(); navigateTo(previousViewId, null, true); } };

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
        function renderInstitutionButtons() {
            institutionButtonsContainer.innerHTML = '';
            const sortedInstitutions = [...institutions].sort((a, b) => a.name.localeCompare(b.name));
            if (sortedInstitutions.length === 0) { 
                institutionButtonsContainer.innerHTML = '<p>Nenhuma institui√ß√£o cadastrada.</p>';
            } else {
                sortedInstitutions.forEach(inst => {
                    const button = document.createElement('button'); button.className = 'institution-btn'; button.textContent = inst.name;
                    button.dataset.id = inst.id; button.style.borderColor = inst.mainColor; button.style.borderWidth = '2px';
                    institutionButtonsContainer.appendChild(button);
                });
            }
        }
        function renderInstitutionsInManager() {
            institutionListContainer.innerHTML = '';
            const sortedInstitutions = [...institutions].sort((a, b) => a.name.localeCompare(b.name));
            if (sortedInstitutions.length === 0) { institutionListContainer.innerHTML = '<p>Nenhuma institui√ß√£o cadastrada.</p>'; }
            sortedInstitutions.forEach(inst => {
                const item = document.createElement('div'); item.className = 'list-item'; item.dataset.id = inst.id;
                item.innerHTML = `<span class="color-swatch" style="background-color: ${inst.mainColor};"></span><span class="item-name">${inst.name}</span><div class="item-actions"><button class="edit-btn">Editar</button><button class="remove-btn">Remover</button></div>`;
                institutionListContainer.appendChild(item);
            });
        }
        function renderAnosLetivos() {
            const anosDaInstituicao = anosLetivos.filter(ano => ano.institutionId === selectedInstitutionId).sort((a, b) => b.year - a.year);
            yearListContainer.innerHTML = ''; yearSelectDropdown.innerHTML = '';
            if (anosDaInstituicao.length === 0) {
                yearListContainer.innerHTML = '<p>Nenhum ano cadastrado.</p>';
                yearSelectDropdown.innerHTML = '<option disabled selected>Cadastre um ano letivo</option>';
                return;
            }
            anosDaInstituicao.forEach(ano => {
                const listItem = document.createElement('div'); listItem.className = 'list-item'; listItem.dataset.id = ano.id;
                listItem.innerHTML = `<span class="item-name">${ano.year}</span><div class="item-actions"><button class="remove-year-btn">Remover</button></div>`;
                yearListContainer.appendChild(listItem);
                const optionItem = document.createElement('option'); optionItem.value = ano.id; optionItem.textContent = ano.year;
                yearSelectDropdown.appendChild(optionItem);
            });
        }
        function renderTurmas() {
            classListContainer.innerHTML = '';
            const turmasDoAno = turmas.filter(t => t.yearId === selectedYearId).sort((a, b) => `${a.name} - ${a.subject}`.localeCompare(`${b.name} - ${b.subject}`));
            if(turmasDoAno.length === 0) { classListContainer.innerHTML = '<p>Nenhuma turma cadastrada para este ano letivo.</p>'; return; }
            turmasDoAno.forEach(turma => {
                const item = document.createElement('div'); item.className = 'list-item'; item.dataset.id = turma.id;
                item.innerHTML = `<span class="item-name">${turma.name} - ${turma.subject}</span><div class="item-actions"><button class="edit-class-btn" data-id="${turma.id}">Editar</button><button class="remove-class-btn" data-id="${turma.id}">Remover</button></div>`;
                classListContainer.appendChild(item);
            });
        }
        function renderClassSelection(selectElement, yearId, excludeClassId = null) {
            selectElement.innerHTML = '<option value="">-- Selecione uma Turma --</option>';
            let turmasDoAno = turmas.filter(t => t.yearId === yearId);
            
            if (excludeClassId) {
                turmasDoAno = turmasDoAno.filter(t => t.id !== excludeClassId);
            }
            
            turmasDoAno.sort((a,b) => `${a.name} - ${a.subject}`.localeCompare(`${b.name} - ${b.subject}`));
            
            turmasDoAno.forEach(turma => {
                const option = document.createElement('option');
                option.value = turma.id;
                option.textContent = `${turma.name} - ${turma.subject}`;
                selectElement.appendChild(option);
            });

            return turmasDoAno.length > 0;
        }
        function renderClassSelectionForStudents() {
            renderClassSelection(classSelectionForStudents, selectedYearId);
            studentEntryContainer.classList.add('hidden');
            studentListEditPanel.classList.add('hidden');
            studentImportPanel.classList.add('hidden');
            inactivateStudentListPanel.classList.add('hidden');
        }
        function renderAlunos() {
            studentListContainer.innerHTML = '';
            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            if (alunosDaTurma.length === 0) { studentListContainer.innerHTML = '<p>Nenhum aluno cadastrado nesta turma.</p>'; return; }
            alunosDaTurma.forEach(aluno => {
                const item = document.createElement('div');
                item.className = 'list-item';
                if (aluno.active === false) { // Adicionado para lidar com o estado inativo
                    item.classList.add('inactive');
                }
                item.dataset.id = aluno.id;
                item.innerHTML = `<span class="item-name">${aluno.number}. ${aluno.name}</span>`;
                studentListContainer.appendChild(item);
            });
        }
        function renderPeriodSelection() {
            periodSelect.innerHTML = '<option value="">-- Selecione --</option>';
            periodClassSelectionContainer.classList.add('hidden');
            periodActionsContainer.classList.add('hidden');
            periodActionsContainer.innerHTML = '';
            
            const institution = institutions.find(i => i.id === selectedInstitutionId);
            if (!institution) return;

            let periodOptions = [];
            switch (institution.periodType) {
                case 'Bimestral':
                    periodOptions = ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre', 'M√©dias Finais'];
                    break;
                case 'Trimestral':
                    periodOptions = ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre', 'M√©dias Finais'];
                    break;
                case 'Semestral':
                    periodOptions = ['1¬∫ Semestre', '2¬∫ Semestre', 'M√©dias Finais'];
                    break;
            }

            periodOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                periodSelect.appendChild(option);
            });
        }

        function roundToOneDecimal(num) {
            // Arredonda para 1 casa decimal (ex: 1.25 -> 1.3)
            return Math.round(num * 10) / 10;
        }

        function renderNotesView(editingColumnId = null, isEditingAll = false) {
            notesTableHeader.innerHTML = '<th class="student-name-header">Aluno</th>';
            notesTableBody.innerHTML = '';
            assessmentPanel.classList.add('hidden');
            assessmentForm.reset();
            document.getElementById('assessment-id').value = '';

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            const avaliacoesDaTurma = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod && !av.isRecovery);
            const recuperacoes = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod && av.isRecovery);
            const institution = institutions.find(i => i.id === selectedInstitutionId);

            const resultId = `notes-${selectedClassId}-${selectedPeriod}`;
            const currentResult = notesResults.find(r => r.id === resultId);

            if (currentResult) {
                const th = document.createElement('th');
                th.className = 'result-header col-header';
                th.innerHTML = `Total`;
                notesTableHeader.appendChild(th);

                const situationTh = document.createElement('th');
                situationTh.className = 'col-header situation-col';
                situationTh.textContent = 'Situa√ß√£o';
                notesTableHeader.appendChild(situationTh);
            }

            const periodRecovery = recuperacoes.find(r => r.recoveryType === 'period');
            if (periodRecovery) {
                const recTh = document.createElement('th');
                recTh.className = 'col-header';
                let recName = 'Recupera√ß√£o';
                if (institution) {
                    if (institution.periodType === 'Bimestral') recName = 'Rec. Bim.';
                    else if (institution.periodType === 'Trimestral') recName = 'Rec. Trim.';
                    else if (institution.periodType === 'Semestral') recName = 'Rec. Sem.';
                }
                const isEditingRec = (editingColumnId === periodRecovery.id) || isEditingAll;
                const recActionClass = isEditingRec ? 'save-col-btn' : 'edit-col-btn';
                const recEditIcon = isEditingRec ? 'üíæ' : 'üìù';

                recTh.innerHTML = `
                    <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-assessment-id="${periodRecovery.id}"> ${recName}</div>
                    <div class="col-header-actions">
                        <button class="${recActionClass}" data-id="${periodRecovery.id}">${recEditIcon}</button>
                        <button class="remove-assessment-btn" data-id="${periodRecovery.id}">üóëÔ∏è</button>
                    </div>
                `;
                notesTableHeader.appendChild(recTh);
            }

            avaliacoesDaTurma.forEach(av => {
                const isEditingThisColumn = (editingColumnId === av.id) || isEditingAll;
                const th = document.createElement('th');
                th.className = 'assessment-header col-header';
                th.dataset.assessmentId = av.id;
                
                const formattedValue = `(Valor: ${av.value.toFixed(1).replace('.', ',')})`;
                const saveIcon = 'üíæ';
                const editNameIcon = '‚úèÔ∏è'; 
                const editNotesIcon = isEditingThisColumn ? saveIcon : 'üìù';
                const actionClass = isEditingThisColumn ? 'save-col-btn' : 'edit-col-btn';

                th.innerHTML = `
                    <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-assessment-id="${av.id}"> ${av.name}</div>
                    <div>${formattedValue}</div>
                    <div class="col-header-actions">
                        <button class="edit-assessment-name-btn" data-id="${av.id}">${editNameIcon}</button>
                        <button class="${actionClass}" data-id="${av.id}">${editNotesIcon}</button>
                        <button class="remove-assessment-btn" data-id="${av.id}">üóëÔ∏è</button>
                    </div>
                `;
                notesTableHeader.appendChild(th);

                const recoveryForThis = recuperacoes.find(r => r.originalAssessmentId === av.id);
                if (recoveryForThis) {
                    const isEditingRec = (editingColumnId === recoveryForThis.id) || isEditingAll;
                    const recTh = document.createElement('th');
                    recTh.className = 'assessment-header col-header';
                    recTh.dataset.assessmentId = recoveryForThis.id;
                    const recActionClass = isEditingRec ? 'save-col-btn' : 'edit-col-btn';
                    const recEditIcon = isEditingRec ? saveIcon : 'üìù';
                    recTh.innerHTML = `
                        <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-assessment-id="${recoveryForThis.id}"> Rec. ${av.name}</div>
                        <div>(Valor: ${recoveryForThis.value.toFixed(1).replace('.',',')})</div>
                        <div class="col-header-actions">
                            <button class="${recActionClass}" data-id="${recoveryForThis.id}">${recEditIcon}</button>
                            <button class="remove-assessment-btn" data-id="${recoveryForThis.id}">üóëÔ∏è</button>
                        </div>
                    `;
                    notesTableHeader.appendChild(recTh);
                }
            });

            alunosDaTurma.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.dataset.studentId = aluno.id;
                if (aluno.active === false) {
                    tr.classList.add('inactive-student-row');
                }
                let rowHTML = `<td class="student-name-cell"><input type="checkbox" class="table-filter-checkbox" data-filter-type="row" data-student-id="${aluno.id}"> ${aluno.number}. ${aluno.name}</td>`;

                if (currentResult) {
                    const studentScoreObj = currentResult.scores.find(s => s.studentId === aluno.id);
                    let finalScore = null;
                    let scoreText = '-';
                    if (studentScoreObj) {
                        finalScore = studentScoreObj.score;
                        if (periodRecovery) {
                            const recoveryGradeObj = periodRecovery.grades.find(g => g.studentId === aluno.id);
                            if (recoveryGradeObj) {
                                finalScore = Math.max(finalScore, recoveryGradeObj.grade);
                            }
                        }
                        scoreText = finalScore.toFixed(1).replace('.', ',');
                    }
                    rowHTML += `<td class="data-cell result-cell">${scoreText}</td>`;

                    let situationText = '-';
                    let situationColor = '#333';
                    if (finalScore !== null && institution) {
                        const isApproved = finalScore >= institution.passingGrade;
                        situationText = isApproved ? 'Aprovado' : 'Em Recupera√ß√£o';
                        situationColor = isApproved ? 'blue' : 'orange';
                    }
                    rowHTML += `<td class="data-cell situation-cell" style="color: ${situationColor}; font-weight: bold;">${situationText}</td>`;
                }
                
                if (periodRecovery) {
                    const isEditingRec = (editingColumnId === periodRecovery.id) || isEditingAll;
                    const recoveryGradeObj = periodRecovery.grades.find(g => g.studentId === aluno.id);
                    const recoveryGrade = recoveryGradeObj ? recoveryGradeObj.grade : null;
                    const recText = (recoveryGrade !== null) ? recoveryGrade.toFixed(1).replace('.', ',') : '-';
                    const recValue = (recoveryGrade !== null) ? recoveryGrade : '';
                    rowHTML += `<td class="data-cell grade-cell ${isEditingRec ? 'editing' : ''}" data-assessment-id="${periodRecovery.id}">
                        <span class="grade-text">${recText}</span>
                        <input type="number" class="grade-input" data-student-id="${aluno.id}" data-assessment-id="${periodRecovery.id}" value="${recValue}" step="0.1" max="${periodRecovery.value}" min="0">
                    </td>`;
                }
                
                avaliacoesDaTurma.forEach(av => {
                    const isEditingThisColumn = (editingColumnId === av.id) || isEditingAll;
                    
                    const notaObj = av.grades.find(g => g.studentId === aluno.id);
                    const nota = notaObj ? notaObj.grade : null;
                    const notaText = (nota !== null && nota !== undefined) ? nota.toFixed(1).replace('.', ',') : '-';
                    const notaValue = (nota !== null && nota !== undefined) ? nota : '';

                    rowHTML += `<td class="data-cell grade-cell ${isEditingThisColumn ? 'editing' : ''}" data-assessment-id="${av.id}">
                        <span class="grade-text">${notaText}</span>
                        <input type="number" class="grade-input" data-student-id="${aluno.id}" data-assessment-id="${av.id}" value="${notaValue}" step="0.1" max="${av.value}" min="0">
                    </td>`;

                    const recoveryForThis = recuperacoes.find(r => r.originalAssessmentId === av.id);
                    if (recoveryForThis) {
                        const isEditingRec = (editingColumnId === recoveryForThis.id) || isEditingAll;
                        const recNotaObj = recoveryForThis.grades.find(g => g.studentId === aluno.id);
                        const recNota = recNotaObj ? recNotaObj.grade : null;
                        const recNotaText = (recNota !== null) ? recNota.toFixed(1).replace('.', ',') : '-';
                        const recNotaValue = (recNota !== null) ? recNota : '';
                        rowHTML += `<td class="data-cell grade-cell ${isEditingRec ? 'editing' : ''}" data-assessment-id="${recoveryForThis.id}">
                            <span class="grade-text">${recNotaText}</span>
                            <input type="number" class="grade-input" data-student-id="${aluno.id}" data-assessment-id="${recoveryForThis.id}" value="${recNotaValue}" step="0.1" max="${recoveryForThis.value}" min="0">
                        </td>`;
                    }
                });
                tr.innerHTML = rowHTML;
                notesTableBody.appendChild(tr);
            });

            editAllNotesBtn.textContent = isEditingAll ? 'Salvar Todas as Notas' : 'Editar Todas as Notas';
            editAllNotesBtn.dataset.editing = isEditingAll;
        }

        function renderFinalGradesView(calculate = false) {
            const state = annualRecoveryState[selectedClassId] || { added: false, editing: false, grades: [] };
            const addRecovery = state.added;
            const isEditing = state.editing;

            notesTableHeader.innerHTML = ''; // Limpa cabe√ßalho
            notesTableBody.innerHTML = ''; // Limpa corpo

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId && a.active !== false).sort((a, b) => a.number - b.number);
            const institution = institutions.find(i => i.id === selectedInstitutionId);
            if (!institution) return;

            let periodOptions = [];
            let divisor = 1;

            switch (institution.periodType) {
                case 'Bimestral': 
                    periodOptions = ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre']; 
                    divisor = 4;
                    break;
                case 'Trimestral': 
                    periodOptions = ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre']; 
                    divisor = 3;
                    break;
                case 'Semestral': 
                    periodOptions = ['1¬∫ Semestre', '2¬∫ Semestre']; 
                    divisor = 2;
                    break;
            }

            let headerHTML = '<th class="student-name-header">Aluno</th>';
            periodOptions.forEach(period => {
                const shortName = period.replace(' Bimestre', 'B').replace(' Trimestre', 'T').replace(' Semestre', 'S');
                headerHTML += `<th class="col-header">${shortName}</th>`;
            });
            
            if (addRecovery) {
                const actionClass = isEditing ? 'save-annual-recovery-btn' : 'edit-annual-recovery-btn';
                const icon = isEditing ? 'üíæ' : '?';
                headerHTML += `<th class="col-header">
                    <div>Rec. Anual</div>
                    <div class="col-header-actions">
                        <button id="${actionClass}">${icon}</button>
                        <button id="delete-annual-recovery-btn">üóëÔ∏è</button>
                    </div>
                </th>`;
            }

            headerHTML += '<th class="result-header col-header">M√©dia Final</th><th class="col-header situation-col">Situa√ß√£o</th>';
            notesTableHeader.innerHTML = headerHTML;

            alunosDaTurma.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.dataset.studentId = aluno.id;
                let rowHTML = `<td class="student-name-cell">${aluno.number}. ${aluno.name}</td>`;
                
                let totalScore = 0;
                let periodCount = 0;

                periodOptions.forEach(period => {
                    const resultId = `notes-${selectedClassId}-${period}`;
                    const periodResult = notesResults.find(r => r.id === resultId);
                    let score = null;
                    
                    if (periodResult) {
                        const studentScoreObj = periodResult.scores.find(s => s.studentId === aluno.id);
                        if (studentScoreObj) {
                            score = studentScoreObj.score;
                            
                            // **IN√çCIO DA CORRE√á√ÉO**
                            const periodRecovery = avaliacoes.find(av => av.classId === selectedClassId && av.period === period && av.recoveryType === 'period');
                            if (periodRecovery) {
                                const recoveryGradeObj = periodRecovery.grades.find(g => g.studentId === aluno.id);
                                if (recoveryGradeObj) {
                                    score = Math.max(score, recoveryGradeObj.grade);
                                }
                            }
                            // **FIM DA CORRE√á√ÉO**

                            totalScore += score;
                            periodCount++;
                        }
                    }
                    const scoreText = (score !== null) ? score.toFixed(1).replace('.', ',') : '-';
                    rowHTML += `<td class="data-cell">${scoreText}</td>`;
                });

                if (addRecovery) {
                    const savedGradeObj = state.grades.find(g => g.studentId === aluno.id);
                    const savedGrade = savedGradeObj ? savedGradeObj.grade : null;
                    const gradeText = (savedGrade !== null) ? savedGrade.toFixed(1).replace('.',',') : '-';
                    const gradeValue = (savedGrade !== null) ? savedGrade : '';

                    rowHTML += `<td class="data-cell grade-cell ${isEditing ? 'editing' : ''}">
                        <span class="grade-text">${gradeText}</span>
                        <input type="number" class="grade-input annual-recovery-input" data-student-id="${aluno.id}" value="${gradeValue}" step="0.1" max="10" min="0">
                    </td>`;
                }

                if (calculate) {
                    const originalAverage = totalScore / divisor;
                    let finalAverage = originalAverage;

                    if (addRecovery) {
                        const recoveryGradeObj = state.grades.find(g => g.studentId === aluno.id);
                        if (recoveryGradeObj && recoveryGradeObj.grade > finalAverage) {
                            finalAverage = recoveryGradeObj.grade;
                        }
                    }

                    const roundedAverage = roundToOneDecimal(finalAverage);
                    
                    let situationText = '';
                    let situationColor = '';

                    if (periodCount < divisor) {
                        situationText = 'Cursando';
                        situationColor = 'green';
                    } else {
                        const isApproved = roundedAverage >= institution.passingGrade;
                        situationText = isApproved ? 'Aprovado' : 'Reprovado';
                        situationColor = isApproved ? 'blue' : 'red';
                    }

                    rowHTML += `<td class="data-cell result-cell" style="font-weight: bold;">${roundedAverage.toFixed(1).replace('.', ',')}</td>`;
                    rowHTML += `<td class="data-cell situation-cell" style="color: ${situationColor}; font-weight: bold;">${situationText}</td>`;
                } else {
                    rowHTML += `<td class="data-cell">-</td><td class="data-cell">-</td>`;
                }
                
                tr.innerHTML = rowHTML;
                notesTableBody.appendChild(tr);
            });
        }

        function renderVistosView() {
            vistosTableHeader.innerHTML = '<th class="student-name-header">Aluno</th>';
            vistoFormPanel.classList.add('hidden');
            vistoForm.reset();
            document.getElementById('visto-id').value = '';
            vistoCalcPanel.classList.add('hidden');
            vistoCalcForm.reset();

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            const vistosDaTurma = vistos.filter(v => v.classId === selectedClassId && v.period === selectedPeriod);
            
            const resultId = `${selectedClassId}-${selectedPeriod}`;
            const currentResult = vistosResults.find(r => r.id === resultId);

            if (currentResult) {
                const th = document.createElement('th');
                th.className = 'visto-result-header result-header col-header';
                th.innerHTML = `Total (Valor: ${currentResult.totalValue.toFixed(1).replace('.',',')})`;
                vistosTableHeader.appendChild(th);
            }

            vistosDaTurma.forEach(visto => {
                const th = document.createElement('th');
                th.className = 'visto-header col-header';
                th.dataset.vistoId = visto.id;
                
                const formattedDate = new Date(visto.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'});

                th.innerHTML = `
                    <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-visto-id="${visto.id}"> ${formattedDate}</div>
                    <div class="visto-header-actions col-header-actions">
                        <button class="edit-visto-btn" data-id="${visto.id}">‚úèÔ∏è</button>
                        <button class="info-visto-btn" data-id="${visto.id}">‚ÑπÔ∏è</button>
                        <button class="remove-visto-btn" data-id="${visto.id}">üóëÔ∏è</button>
                    </div>
                `;
                vistosTableHeader.appendChild(th);
            });

            const vistoOptions = ["-", "C", "I", "AT", "F", "NFT", "NTM"];
            vistosTableBody.innerHTML = '';

            alunosDaTurma.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.dataset.studentId = aluno.id;
                 if (aluno.active === false) {
                    tr.classList.add('inactive-student-row');
                }
                let rowHTML = `<td class="student-name-cell"><input type="checkbox" class="table-filter-checkbox" data-filter-type="row" data-student-id="${aluno.id}"> ${aluno.number}. ${aluno.name}</td>`;

                if (currentResult) {
                    const studentScore = currentResult.scores.find(s => s.studentId === aluno.id);
                    const scoreText = studentScore ? studentScore.score.toFixed(1).replace('.', ',') : '-';
                    rowHTML += `<td class="visto-cell data-cell result-cell">${scoreText}</td>`;
                }
                
                vistosDaTurma.forEach(visto => {
                    const record = visto.records.find(r => r.studentId === aluno.id);
                    const currentValue = record ? record.value : "-";

                    let selectHTML = `<td class="visto-cell data-cell" data-visto-id="${visto.id}"><select class="visto-select" data-student-id="${aluno.id}" data-visto-id="${visto.id}">`;
                    vistoOptions.forEach(opt => {
                        const selected = (opt === currentValue) ? 'selected' : '';
                        selectHTML += `<option value="${opt}" ${selected}>${opt}</option>`;
                    });
                    selectHTML += `</select></td>`;
                    rowHTML += selectHTML;
                });
                tr.innerHTML = rowHTML;
                vistosTableBody.appendChild(tr);
            });
        }

        function renderContinuousAssessmentsView(editingColumnId = null, isEditingAll = false) {
            continuousAssessmentTableHeader.innerHTML = '<th class="student-name-header">Aluno</th>';
            continuousAssessmentTableBody.innerHTML = '';
            continuousAssessmentFormPanel.classList.add('hidden');
            continuousAssessmentForm.reset();
            document.getElementById('continuous-assessment-id').value = '';

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            const assessments = continuousAssessments.filter(v => v.classId === selectedClassId && v.period === selectedPeriod);
            
            const resultId = `ca-${selectedClassId}-${selectedPeriod}`;
            const currentResult = continuousAssessmentsResults.find(r => r.id === resultId);

            if (currentResult) {
                const th = document.createElement('th');
                th.className = 'result-header col-header';
                th.innerHTML = `Total`;
                continuousAssessmentTableHeader.appendChild(th);
            }

            assessments.forEach(assessment => {
                const isEditingThisColumn = (editingColumnId === assessment.id) || isEditingAll;
                const th = document.createElement('th');
                th.className = 'col-header';
                th.dataset.assessmentId = assessment.id;
                
                const formattedDate = new Date(assessment.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                const saveIcon = 'üíæ';
                const editNotesIcon = isEditingThisColumn ? saveIcon : 'üìù';
                const actionClass = isEditingThisColumn ? 'save-col-btn' : 'edit-col-btn';

                th.innerHTML = `
                    <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-assessment-id="${assessment.id}"> ${formattedDate}</div>
                    <div class="col-header-actions">
                        <button class="edit-continuous-assessment-btn" data-id="${assessment.id}">‚úèÔ∏è</button>
                        <button class="${actionClass}" data-id="${assessment.id}">${editNotesIcon}</button>
                        <button class="remove-continuous-assessment-btn" data-id="${assessment.id}">üóëÔ∏è</button>
                    </div>
                `;
                continuousAssessmentTableHeader.appendChild(th);
            });

            continuousAssessmentTableBody.innerHTML = '';
            alunosDaTurma.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.dataset.studentId = aluno.id;
                 if (aluno.active === false) {
                    tr.classList.add('inactive-student-row');
                }
                let rowHTML = `<td class="student-name-cell"><input type="checkbox" class="table-filter-checkbox" data-filter-type="row" data-student-id="${aluno.id}"> ${aluno.number}. ${aluno.name}</td>`;

                if (currentResult) {
                    const studentScore = currentResult.scores.find(s => s.studentId === aluno.id);
                    const scoreText = studentScore ? studentScore.score.toFixed(1).replace('.', ',') : '-';
                    rowHTML += `<td class="data-cell result-cell">${scoreText}</td>`;
                }
                
                assessments.forEach(assessment => {
                    const isEditingThisColumn = (editingColumnId === assessment.id) || isEditingAll;
                    
                    const notaObj = assessment.grades.find(g => g.studentId === aluno.id);
                    const nota = notaObj ? notaObj.grade : null;
                    const notaText = (nota !== null && nota !== undefined) ? nota.toFixed(1).replace('.', ',') : '-';
                    const notaValue = (nota !== null && nota !== undefined) ? nota : '';

                    let cellHTML = `<td class="data-cell grade-cell ${isEditingThisColumn ? 'editing' : ''}" data-assessment-id="${assessment.id}">
                        <span class="grade-text">${notaText}</span>
                        <input type="number" class="grade-input" data-student-id="${aluno.id}" data-assessment-id="${assessment.id}" value="${notaValue}" step="0.1" min="0" max="10">
                    </td>`;
                    rowHTML += cellHTML;
                });
                tr.innerHTML = rowHTML;
                continuousAssessmentTableBody.appendChild(tr);
            });

            editAllContinuousAssessmentsBtn.textContent = isEditingAll ? 'Salvar Todas as Notas' : 'Editar Todas as Notas';
            editAllContinuousAssessmentsBtn.dataset.editing = isEditingAll;
        }
        
        function renderFavorites() {
            favoriteListContainer.innerHTML = '';
            if (favorites.length === 0) {
                favoriteListContainer.innerHTML = '<p>Nenhum favorito adicionado.</p>';
                return;
            }
            favorites.forEach(fav => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.dataset.id = fav.id;
                item.innerHTML = `
                    <span class="item-name">${fav.name}</span>
                    <div class="item-actions">
                        <button class="go-favorite-btn" data-id="${fav.id}">üöÄ</button>
                        <button class="remove-favorite-btn" data-id="${fav.id}">üóëÔ∏è</button>
                    </div>
                `;
                favoriteListContainer.appendChild(item);
            });
        }

        function renderReportFilters() {
            reportInstitutionSelect.innerHTML = '<option value="">Selecione uma Institui√ß√£o</option>';
            institutions.sort((a,b) => a.name.localeCompare(b.name)).forEach(inst => {
                const option = document.createElement('option');
                option.value = inst.id;
                option.textContent = inst.name;
                reportInstitutionSelect.appendChild(option);
            });

            reportYearSelect.innerHTML = '<option value="">Selecione um Ano Letivo</option>';
            reportClassSelect.innerHTML = '<option value="">Selecione uma Turma</option>';
            reportPeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
            reportTypeSelect.innerHTML = '<option value="">Selecione um Tipo de Relat√≥rio</option>';
            reportOutputContainer.innerHTML = '';
        }

        // --- FUN√á√ÉO DE FILTRO DA TABELA ---
        function handleTableFilter(checkbox) {
            const table = checkbox.closest('.data-table');
            const allCheckboxes = table.querySelectorAll('.table-filter-checkbox');
            
            // Desmarca todos os outros checkboxes
            allCheckboxes.forEach(cb => {
                if (cb !== checkbox) {
                    cb.checked = false;
                }
            });

            const allRows = table.querySelectorAll('tbody tr');
            const allHeaders = table.querySelectorAll('thead th');
            const allCells = table.querySelectorAll('tbody td');

            // Reseta todos os filtros
            allRows.forEach(row => row.classList.remove('filter-hidden'));
            allHeaders.forEach(th => th.classList.remove('filter-hidden'));
            allCells.forEach(td => td.classList.remove('filter-hidden'));

            if (checkbox.checked) {
                const filterType = checkbox.dataset.filterType;

                if (filterType === 'row') {
                    const studentId = checkbox.dataset.studentId;
                    allRows.forEach(row => {
                        if (row.dataset.studentId !== studentId) {
                            row.classList.add('filter-hidden');
                        }
                    });
                } else if (filterType === 'col') {
                    const assessmentId = checkbox.dataset.assessmentId || checkbox.dataset.vistoId;
                    
                    // Esconde cabe√ßalhos
                    allHeaders.forEach((th, index) => {
                        if (index > 0 && th.dataset.assessmentId !== assessmentId && th.dataset.vistoId !== assessmentId && !th.classList.contains('result-header') && !th.classList.contains('situation-col')) {
                            th.classList.add('filter-hidden');
                        }
                    });

                    // Esconde c√©lulas
                    allCells.forEach((td, index) => {
                         if (td.cellIndex > 0 && td.dataset.assessmentId !== assessmentId && td.dataset.vistoId !== assessmentId && !td.classList.contains('result-cell') && !td.classList.contains('situation-cell')) {
                            td.classList.add('filter-hidden');
                        }
                    });
                }
            }
        }

        // --- EVENT LISTENERS ---
        allReportsBtns.forEach(btn => btn.addEventListener('click', () => navigateTo('reports-view')));
        allFavoritesBtns.forEach(btn => btn.addEventListener('click', () => navigateTo('favorites-view')));
        homeBtns.forEach(btn => btn.addEventListener('click', () => navigateTo('dashboard-view')));
        backBtns.forEach(btn => btn.addEventListener('click', navigateBack));
        backupBtns.forEach(btn => btn.addEventListener('click', () => navigateTo('backup-view')));
        gotoStudentRegistrationBtn.addEventListener('click', () => navigateTo('student-registration-view'));
        gotoPeriodSelectionBtn.addEventListener('click', () => navigateTo('period-selection-view'));
        
        periodSelect.addEventListener('change', () => {
            selectedPeriod = periodSelect.value;
            periodActionsContainer.innerHTML = '';
            periodActionsContainer.classList.add('hidden');

            if (!selectedPeriod) {
                periodClassSelectionContainer.classList.add('hidden');
                return;
            }

            periodClassSelectionContainer.classList.remove('hidden');
            renderClassSelection(periodClassSelect, selectedYearId);
            periodClassSelect.value = '';
        });

        periodClassSelect.addEventListener('change', () => {
            selectedClassId = parseInt(periodClassSelect.value);
            periodActionsContainer.innerHTML = '';

            // Inicializa o estado de recupera√ß√£o para a turma selecionada
            if (selectedClassId && !annualRecoveryState[selectedClassId]) {
                annualRecoveryState[selectedClassId] = { added: false, editing: false, grades: [] };
            }

            if (!selectedClassId) {
                periodActionsContainer.classList.add('hidden');
                return;
            }

            if (selectedPeriod !== 'M√©dias Finais') {
                const atividadesBtn = document.createElement('button');
                atividadesBtn.textContent = 'Atividades';
                atividadesBtn.addEventListener('click', () => navigateTo('activities-view'));
                periodActionsContainer.appendChild(atividadesBtn);
            }

            const notasBtn = document.createElement('button');
            notasBtn.textContent = 'Notas';
            notasBtn.addEventListener('click', () => navigateTo('notes-view'));
            periodActionsContainer.appendChild(notasBtn);

            const clearBtn = document.createElement('button');
            clearBtn.textContent = 'Limpar Sele√ß√£o';
            clearBtn.id = 'clear-period-selection-btn';
            periodActionsContainer.appendChild(clearBtn);

            periodActionsContainer.classList.remove('hidden');
        });

        periodActionsContainer.addEventListener('click', (event) => {
            if (event.target.id === 'clear-period-selection-btn') {
                periodSelect.value = '';
                // Trigger the change event to reset the dependent UI elements
                periodSelect.dispatchEvent(new Event('change')); 
            }
        });

        institutionButtonsContainer.addEventListener('click', (event) => {
            const button = event.target.closest('.institution-btn');
            if (button) { navigateTo('year-selection-view', { institutionId: parseInt(button.dataset.id) }); }
        });
        confirmYearBtn.addEventListener('click', () => {
            const yearId = parseInt(yearSelectDropdown.value);
            if (!yearId) { showModal('Selecione um ano letivo.'); return; }
            selectedYearId = yearId; navigateTo('main-menu-view');
        });
        gotoClassRegistrationBtn.addEventListener('click', () => navigateTo('class-registration-view'));
        manageInstitutionsBtn.addEventListener('click', () => {
            renderInstitutionsInManager();
            institutionManagerPanel.classList.toggle('hidden');
        });
        colorPicker.addEventListener('input', () => colorText.value = colorPicker.value);
        colorText.addEventListener('change', () => { if (/^#[0-9A-F]{6}$/i.test(colorText.value)) { colorPicker.value = colorText.value; }});
        
        institutionForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = parseInt(document.getElementById('institution-id').value); const name = document.getElementById('institution-name').value.trim();
            const periodType = document.getElementById('institution-period-type').value; const passingGrade = parseFloat(document.getElementById('institution-passing-grade').value);
            const mainColor = document.getElementById('institution-main-color-text').value;
            if (id) { const index = institutions.findIndex(inst => inst.id === id); if (index > -1) institutions[index] = { id, name, periodType, passingGrade, mainColor };
            } else { const newId = institutions.length > 0 ? Math.max(...institutions.map(i => i.id)) + 1 : Date.now(); institutions.push({ id: newId, name, periodType, passingGrade, mainColor }); }
            saveInstitutions(); renderInstitutionsInManager(); renderInstitutionButtons();
            institutionForm.reset(); document.getElementById('institution-id').value = ''; colorText.value = '#007bff'; colorPicker.value = '#007bff'; cancelEditBtn.classList.add('hidden');
        });
        
        institutionListContainer.addEventListener('click', async (event) => {
            const target = event.target; const item = target.closest('.list-item'); if (!item) return;
            const id = parseInt(item.dataset.id);
            if (target.classList.contains('edit-btn')) {
                const institution = institutions.find(inst => inst.id === id);
                document.getElementById('institution-id').value = institution.id; document.getElementById('institution-name').value = institution.name;
                document.getElementById('institution-period-type').value = institution.periodType; document.getElementById('institution-passing-grade').value = institution.passingGrade;
                colorPicker.value = institution.mainColor; colorText.value = institution.mainColor;
                cancelEditBtn.classList.remove('hidden'); institutionManagerPanel.classList.remove('hidden'); window.scrollTo(0, 0);
            }
            if (target.classList.contains('remove-btn')) {
                if (anosLetivos.some(ano => ano.institutionId === id)) { showModal('N√£o √© poss√≠vel remover. Existem Anos Letivos vinculados.'); return; }
                const confirmed = await showModal('Tem certeza?', true);
                if (confirmed) { institutions = institutions.filter(inst => inst.id !== id); saveInstitutions(); renderInstitutionsInManager(); renderInstitutionButtons(); }
            }
        });
        
        cancelEditBtn.addEventListener('click', () => { institutionForm.reset(); document.getElementById('institution-id').value = ''; cancelEditBtn.classList.add('hidden'); });
        manageYearsBtn.addEventListener('click', () => yearManagerPanel.classList.toggle('hidden'));
        
        yearForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const yearInput = document.getElementById('year-input'); const year = parseInt(yearInput.value);
            if (!year || year < 1900 || year > 2100) { showModal('Ano inv√°lido.'); return; }
            if (anosLetivos.some(y => y.year === year && y.institutionId === selectedInstitutionId)) { showModal('Este ano j√° foi cadastrado.'); return; }
            const newId = anosLetivos.length > 0 ? Math.max(...anosLetivos.map(a => a.id)) + 1 : Date.now();
            anosLetivos.push({ id: newId, year, institutionId: selectedInstitutionId });
            saveAnosLetivos(); renderAnosLetivos(); yearInput.value = '';
        });
        
        yearListContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-year-btn')) {
                const item = event.target.closest('.list-item'); const id = parseInt(item.dataset.id);
                if (turmas.some(t => t.yearId === id)) { showModal('N√£o √© poss√≠vel remover. Existem turmas neste ano letivo.'); return; }
                anosLetivos = anosLetivos.filter(ano => ano.id !== id); saveAnosLetivos(); renderAnosLetivos();
            }
        });
        
        classForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const classIdInput = document.getElementById('class-id'); const nameInput = document.getElementById('class-name-input');
            const subjectInput = document.getElementById('class-subject-input');
            const classId = parseInt(classIdInput.value); const name = nameInput.value.trim(); const subject = subjectInput.value.trim();
            if(!name || !subject) { showModal('Campos obrigat√≥rios.'); return; }
            const newFullName = `${name} - ${subject}`;
            const isDuplicate = turmas.some(turma => {
                if (turma.yearId !== selectedYearId) return false;
                const existingFullName = `${turma.name} - ${turma.subject}`;
                if (classId && turma.id === classId) return false;
                return existingFullName.toLowerCase() === newFullName.toLowerCase();
            });
            if (isDuplicate) { showModal(`A turma "${newFullName}" j√° existe.`); return; }
            if (classId) { const index = turmas.findIndex(t => t.id === classId); if(index > -1) { turmas[index].name = name; turmas[index].subject = subject; }
            } else { const newId = turmas.length > 0 ? Math.max(...turmas.map(t => t.id)) + 1 : Date.now(); turmas.push({ id: newId, name, subject, yearId: selectedYearId, institutionId: selectedInstitutionId }); }
            saveTurmas(); renderTurmas(); classForm.reset(); classIdInput.value = '';
        });
        
        classListContainer.addEventListener('click', async (event) => {
            const target = event.target; const item = target.closest('.list-item'); if(!item) return;
            const id = parseInt(target.dataset.id);
            if(target.classList.contains('edit-class-btn')) {
                const turma = turmas.find(t => t.id === id);
                document.getElementById('class-id').value = turma.id;
                document.getElementById('class-name-input').value = turma.name;
                document.getElementById('class-subject-input').value = turma.subject;
            }
            if(target.classList.contains('remove-class-btn')) {
                if (alunos.some(a => a.classId === id)) { showModal('N√£o √© poss√≠vel remover. Existem alunos nesta turma.'); return; }
                const confirmed = await showModal('Tem certeza?', true);
                if(confirmed) { turmas = turmas.filter(t => t.id !== id); saveTurmas(); renderTurmas(); }
            }
        });
        
        classSelectionForStudents.addEventListener('change', () => {
            selectedClassId = parseInt(classSelectionForStudents.value);
            studentListEditPanel.classList.add('hidden');
            studentImportPanel.classList.add('hidden');
            inactivateStudentListPanel.classList.add('hidden');
            if (selectedClassId) { 
                studentEntryContainer.classList.remove('hidden'); 
                renderAlunos();
            } else { 
                studentEntryContainer.classList.add('hidden'); 
            }
        });
        
        addStudentsBtn.addEventListener('click', () => {
            const textarea = document.getElementById('student-names-textarea');
            const names = textarea.value.split('\n').filter(name => name.trim() !== '');
            if (names.length === 0) { showModal('Digite os nomes dos alunos.'); return; }
            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId);
            let maxNumber = alunosDaTurma.length > 0 ? Math.max(...alunosDaTurma.map(a => a.number)) : 0;
            const timestamp = Date.now();
            names.forEach((name, index) => {
                maxNumber++;
                const newId = timestamp + index;
                alunos.push({ id: newId, name: name.trim(), number: maxNumber, classId: selectedClassId, active: true });
            });
            saveAlunos(); renderAlunos(); textarea.value = '';
        });
        
        editStudentListBtn.addEventListener('click', () => {
            studentImportPanel.classList.add('hidden');
            inactivateStudentListPanel.classList.add('hidden');
            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a,b) => a.number - b.number);
            const nomes = alunosDaTurma.map(aluno => aluno.name).join('\n');
            document.getElementById('student-list-edit-textarea').value = nomes;
            studentListEditPanel.classList.remove('hidden');
        });
        
        cancelStudentListEditBtn.addEventListener('click', () => {
            studentListEditPanel.classList.add('hidden');
        });
        
        saveStudentListBtn.addEventListener('click', async () => {
            const confirmed = await showModal('Isso ir√° substituir a lista de alunos atual por esta nova vers√£o. Deseja continuar?', true);
            if (!confirmed) { return; }
            const editTextarea = document.getElementById('student-list-edit-textarea');
            const newNames = editTextarea.value.split('\n').map(name => name.trim()).filter(name => name !== '');
            
            // Mant√©m os alunos inativos
            const inactiveStudents = alunos.filter(aluno => aluno.classId === selectedClassId && aluno.active === false);
            
            // Remove todos os alunos da turma (ativos e inativos)
            alunos = alunos.filter(aluno => aluno.classId !== selectedClassId);
            
            let currentNumber = 1;
            const timestamp = Date.now();
            newNames.forEach((name, index) => {
                const newId = timestamp + index;
                alunos.push({ id: newId, name: name, number: currentNumber, classId: selectedClassId, active: true });
                currentNumber++;
            });

            // Adiciona os alunos inativos de volta
            inactiveStudents.forEach(inactiveStudent => {
                inactiveStudent.number = currentNumber;
                alunos.push(inactiveStudent);
                currentNumber++;
            });

            saveAlunos(); renderAlunos();
            studentListEditPanel.classList.add('hidden');
        });

        importStudentsBtn.addEventListener('click', () => {
            studentListEditPanel.classList.add('hidden');
            inactivateStudentListPanel.classList.add('hidden');
            importFromClassSelect.innerHTML = '<option value="">-- Selecione uma Turma --</option>';

            const currentAnoLetivo = anosLetivos.find(a => a.id === selectedYearId);
            if (!currentAnoLetivo) {
                showModal('Erro: Ano letivo atual n√£o encontrado.');
                return;
            }

            const previousAnoLetivo = anosLetivos.find(a => 
                a.institutionId === selectedInstitutionId && a.year === currentAnoLetivo.year - 1
            );

            const turmasAtuais = turmas
                .filter(t => t.yearId === selectedYearId && t.id !== selectedClassId)
                .map(t => ({ ...t, year: currentAnoLetivo.year }));

            const turmasAnteriores = previousAnoLetivo
                ? turmas.filter(t => t.yearId === previousAnoLetivo.id).map(t => ({ ...t, year: previousAnoLetivo.year }))
                : [];
            
            const allPossibleTurmas = [...turmasAnteriores, ...turmasAtuais];

            allPossibleTurmas.sort((a, b) => {
                if (b.year !== a.year) {
                    return b.year - a.year;
                }
                return `${a.name} - ${a.subject}`.localeCompare(`${b.name} - ${b.subject}`);
            });

            if (allPossibleTurmas.length > 0) {
                allPossibleTurmas.forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma.id;
                    option.textContent = `${turma.name} - ${turma.subject} (${turma.year})`;
                    importFromClassSelect.appendChild(option);
                });
                studentImportPanel.classList.remove('hidden');
            } else {
                showModal('N√£o h√° outras turmas (do ano atual ou anterior) para importar alunos.');
            }
        });

        cancelImportBtn.addEventListener('click', () => {
            studentImportPanel.classList.add('hidden');
        });

        confirmImportBtn.addEventListener('click', () => {
            const sourceClassId = parseInt(importFromClassSelect.value);
            if (!sourceClassId) {
                showModal('Por favor, selecione uma turma de origem.');
                return;
            }

            const alunosDaFonte = alunos.filter(a => a.classId === sourceClassId);
            const alunosDoDestino = alunos.filter(a => a.classId === selectedClassId);
            const nomesDosAlunosDoDestino = new Set(alunosDoDestino.map(a => a.name.toLowerCase().trim()));

            const alunosParaImportar = alunosDaFonte.filter(alunoFonte => {
                return !nomesDosAlunosDoDestino.has(alunoFonte.name.toLowerCase().trim());
            });

            if (alunosParaImportar.length === 0) {
                showModal('Nenhum aluno novo para importar. Todos os alunos da turma de origem j√° existem na turma atual.');
                return;
            }

            let maxNumber = alunosDoDestino.length > 0 ? Math.max(...alunosDoDestino.map(a => a.number)) : 0;
            
            const timestamp = Date.now();
            alunosParaImportar.forEach((aluno, index) => {
                maxNumber++;
                const newId = timestamp + index;
                alunos.push({ id: newId, name: aluno.name, number: maxNumber, classId: selectedClassId, active: true });
            });

            saveAlunos();
            renderAlunos();
            studentImportPanel.classList.add('hidden');
            showModal(`${alunosParaImportar.length} aluno(s) importado(s) com sucesso!`);
        });

        function renderInactivateStudentList() {
            inactivateListContainer.innerHTML = '';
            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            
            alunosDaTurma.forEach(aluno => {
                const item = document.createElement('div');
                item.className = 'list-item';
                const isChecked = aluno.active !== false; // Considera ativo se for true ou undefined

                item.innerHTML = `
                    <label style="display: flex; align-items: center; width: 100%;">
                        <input type="checkbox" class="inactivate-checkbox" data-id="${aluno.id}" ${isChecked ? 'checked' : ''}>
                        <span class="item-name" style="margin-left: 10px;">${aluno.number}. ${aluno.name}</span>
                    </label>
                `;
                inactivateListContainer.appendChild(item);
            });
        }

        inactivateStudentsBtn.addEventListener('click', () => {
            studentListEditPanel.classList.add('hidden');
            studentImportPanel.classList.add('hidden');
            renderInactivateStudentList();
            inactivateStudentListPanel.classList.remove('hidden');
        });

        cancelInactivateListBtn.addEventListener('click', () => {
            inactivateStudentListPanel.classList.add('hidden');
        });

        saveInactivateListBtn.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.inactivate-checkbox');
            checkboxes.forEach(checkbox => {
                const studentId = parseInt(checkbox.dataset.id);
                const aluno = alunos.find(a => a.id === studentId);
                if (aluno) {
                    aluno.active = checkbox.checked;
                }
            });
            saveAlunos();
            renderAlunos();
            inactivateStudentListPanel.classList.add('hidden');
            showModal('Status dos alunos atualizado com sucesso!');
        });


        // --- EVENTOS DA TELA DE NOTAS ---
        addAssessmentBtn.addEventListener('click', () => {
            assessmentForm.reset();
            document.getElementById('assessment-id').value = '';
            assessmentPanel.classList.remove('hidden');
        });

        cancelAssessmentEditBtn.addEventListener('click', () => {
            assessmentPanel.classList.add('hidden');
        });

        assessmentForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const idInput = document.getElementById('assessment-id');
            const nameInput = document.getElementById('assessment-name');
            const valueInput = document.getElementById('assessment-value');

            const id = parseInt(idInput.value);
            const name = nameInput.value.trim();
            const value = parseFloat(valueInput.value.replace(',', '.'));

            if (!name || isNaN(value)) {
                showModal('Nome e valor da avalia√ß√£o s√£o obrigat√≥rios.');
                return;
            }
            
            const isDuplicate = avaliacoes.some(av => av.classId === selectedClassId && av.period === selectedPeriod && av.name.toLowerCase() === name.toLowerCase() && av.id !== id);
            if(isDuplicate) {
                showModal('J√° existe uma avalia√ß√£o com este nome neste per√≠odo.');
                return;
            }

            const resultId = `notes-${selectedClassId}-${selectedPeriod}`;
            notesResults = notesResults.filter(r => r.id !== resultId);
            saveNotesResults();

            if (id) {
                const index = avaliacoes.findIndex(av => av.id === id);
                if (index > -1) {
                    avaliacoes[index].name = name;
                    avaliacoes[index].value = value;
                }
                 saveAvaliacoes();
                 renderNotesView();
            } else {
                const newId = Date.now();
                avaliacoes.push({ id: newId, name, value, classId: selectedClassId, period: selectedPeriod, grades: [] });
                saveAvaliacoes();
                renderNotesView(newId);
            }
        });
        
        function saveColumnNotes(assessmentId) {
            const inputs = document.querySelectorAll(`.grade-input[data-assessment-id="${assessmentId}"]`);
            const assessment = avaliacoes.find(av => av.id === assessmentId);
            if (!assessment) return;

            const newGrades = [];
            inputs.forEach(input => {
                const studentId = parseInt(input.dataset.studentId);
                const grade = input.value !== '' ? parseFloat(input.value.replace(',', '.')) : null;

                if (grade !== null && !isNaN(grade)) {
                    newGrades.push({ studentId, grade });
                }
            });

            assessment.grades = newGrades;
            saveAvaliacoes();

            const resultId = `notes-${selectedClassId}-${selectedPeriod}`;
            notesResults = notesResults.filter(r => r.id !== resultId);
            saveNotesResults();
        }

        notesView.addEventListener('click', async (event) => {
            const target = event.target;

            if (target.classList.contains('table-filter-checkbox')) {
                handleTableFilter(target);
                return;
            }

            const button = target.closest('button');

            if (button) {
                if (button.id === 'calculate-notes-btn') {
                    const assessments = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod && !av.isRecovery);
                    if (assessments.length === 0) {
                        showModal('N√£o h√° avalia√ß√µes para calcular.');
                        return;
                    }

                    const totalValue = assessments.reduce((sum, av) => sum + av.value, 0);
                    const divisor = Math.max(1, totalValue / 10);
                    const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId && a.active !== false);
                    const scores = [];
                    const recuperacoes = avaliacoes.filter(av => av.isRecovery && av.classId === selectedClassId && av.period === selectedPeriod);

                    alunosDaTurma.forEach(aluno => {
                        let studentTotalScore = 0;
                        assessments.forEach(assessment => {
                            const originalGradeObj = assessment.grades.find(g => g.studentId === aluno.id);
                            let finalGrade = originalGradeObj ? originalGradeObj.grade : 0;

                            const recovery = recuperacoes.find(r => r.originalAssessmentId === assessment.id);
                            if (recovery) {
                                const recoveryGradeObj = recovery.grades.find(g => g.studentId === aluno.id);
                                if (recoveryGradeObj) {
                                    finalGrade = Math.max(finalGrade, recoveryGradeObj.grade);
                                }
                            }
                            studentTotalScore += finalGrade;
                        });
                        const finalScore = studentTotalScore / divisor;
                        scores.push({ studentId: aluno.id, score: roundToOneDecimal(finalScore) });
                    });

                    const resultId = `notes-${selectedClassId}-${selectedPeriod}`;
                    const resultIndex = notesResults.findIndex(r => r.id === resultId);
                    const newResult = { id: resultId, classId: selectedClassId, period: selectedPeriod, scores };

                    if (resultIndex > -1) {
                        notesResults[resultIndex] = newResult;
                    } else {
                        notesResults.push(newResult);
                    }
                    
                    saveNotesResults();
                    renderNotesView();
                    return;
                }

                if (button.id === 'calculate-final-grades-btn') {
                    renderFinalGradesView(true);
                    return;
                }

                if (button.id === 'add-annual-recovery-btn') {
                    if (annualRecoveryState[selectedClassId]) {
                        annualRecoveryState[selectedClassId].added = true;
                    }
                    button.disabled = true; // Desabilita o bot√£o para n√£o adicionar de novo
                    saveAnnualRecoveryState();
                    renderFinalGradesView(false);
                    return;
                }
                
                if (button.id === 'edit-annual-recovery-btn') {
                    if (annualRecoveryState[selectedClassId]) {
                        annualRecoveryState[selectedClassId].editing = true;
                    }
                    saveAnnualRecoveryState();
                    renderFinalGradesView(false);
                    return;
                }

                if (button.id === 'save-annual-recovery-btn') {
                    const inputs = document.querySelectorAll('.annual-recovery-input');
                    const newGrades = [];
                    inputs.forEach(input => {
                        const studentId = parseInt(input.dataset.studentId);
                        const grade = input.value !== '' ? parseFloat(input.value.replace(',', '.')) : null;
                        if (grade !== null && !isNaN(grade)) {
                            newGrades.push({ studentId, grade });
                        }
                    });
                    if (annualRecoveryState[selectedClassId]) {
                        annualRecoveryState[selectedClassId].grades = newGrades;
                        annualRecoveryState[selectedClassId].editing = false;
                    }
                    saveAnnualRecoveryState();
                    renderFinalGradesView(false);
                    return;
                }
                
                if (button.id === 'delete-annual-recovery-btn') {
                    const confirmed = await showModal('Tem certeza que deseja remover a coluna de Recupera√ß√£o Anual? As notas inseridas ser√£o perdidas.', true);
                    if (confirmed) {
                        if (annualRecoveryState[selectedClassId]) {
                            annualRecoveryState[selectedClassId].added = false;
                            annualRecoveryState[selectedClassId].editing = false;
                            annualRecoveryState[selectedClassId].grades = [];
                        }
                        addAnnualRecoveryBtn.disabled = false;
                        saveAnnualRecoveryState();
                        renderFinalGradesView();
                    }
                    return;
                }

                const assessmentId = parseInt(button.dataset.id);
                if (isNaN(assessmentId)) return;

                if (button.classList.contains('edit-assessment-name-btn')) {
                    const assessment = avaliacoes.find(av => av.id === assessmentId);
                    if (assessment) {
                        document.getElementById('assessment-id').value = assessment.id;
                        document.getElementById('assessment-name').value = assessment.name;
                        document.getElementById('assessment-value').value = assessment.value;
                        assessmentPanel.classList.remove('hidden');
                    }
                } else if (button.classList.contains('edit-col-btn')) {
                    renderNotesView(assessmentId);
                } else if (button.classList.contains('save-col-btn')) {
                    saveColumnNotes(assessmentId);
                    renderNotesView();
                } else if (button.classList.contains('remove-assessment-btn')) {
                    const confirmed = await showModal('Tem certeza que deseja remover esta avalia√ß√£o e todas as suas notas? Esta a√ß√£o n√£o pode ser desfeita.', true);
                    if (confirmed) {
                        avaliacoes = avaliacoes.filter(av => av.id !== assessmentId && av.originalAssessmentId !== assessmentId);
                        const resultId = `notes-${selectedClassId}-${selectedPeriod}`;
                        notesResults = notesResults.filter(r => r.id !== resultId);
                        saveNotesResults();
                        saveAvaliacoes();
                        renderNotesView();
                    }
                }
            }
        });

        notesView.addEventListener('input', (event) => {
            const input = event.target;
            if (input.classList.contains('grade-input')) {
                const maxValue = parseFloat(input.max);
                if (parseFloat(input.value) > maxValue) {
                    input.value = maxValue;
                }
            }
        });

        notesTableBody.addEventListener('blur', (event) => {
            const input = event.target;
            if (input.classList.contains('grade-input')) {
                const value = parseFloat(input.value.replace(',', '.'));
                const maxValue = parseFloat(input.max);
                if (value > maxValue && String(value).indexOf('.') === -1) {
                    input.value = (value / 10).toFixed(1);
                }
            }
        }, true);

        notesTableBody.addEventListener('keydown', (event) => {
            if (!event.target.classList.contains('grade-input')) return;

            if (event.key === 'Enter') {
                event.preventDefault();
                const currentInput = event.target;
                const currentTr = currentInput.closest('tr');
                let nextTr = currentTr.nextElementSibling;
                // Pula linhas de alunos inativos
                while(nextTr && nextTr.classList.contains('inactive-student-row')) {
                    nextTr = nextTr.nextElementSibling;
                }

                if (nextTr) {
                    const sameColInput = nextTr.querySelector(`.grade-input[data-assessment-id="${currentInput.dataset.assessmentId}"]`);
                    if (sameColInput) {
                        sameColInput.parentElement.classList.add('editing');
                        sameColInput.focus();
                        sameColInput.select();
                    }
                }
            }
        });

        notesTableBody.addEventListener('paste', (event) => {
            const targetInput = event.target;
            if (!targetInput.classList.contains('grade-input')) return;

            event.preventDefault();
            const pasteData = (event.clipboardData || window.clipboardData).getData('text');
            const lines = pasteData.split(/\r?\n/).filter(line => line.trim() !== '');

            if (lines.length > 0) {
                const assessmentId = targetInput.dataset.assessmentId;
                let currentTr = targetInput.closest('tr');

                lines.forEach((line, index) => {
                    if (currentTr) {
                         // Pula linhas de alunos inativos
                        while(currentTr && currentTr.classList.contains('inactive-student-row')) {
                            currentTr = currentTr.nextElementSibling;
                        }
                        if (!currentTr) return; // Sai se n√£o houver mais linhas v√°lidas

                        const inputInRow = currentTr.querySelector(`.grade-input[data-assessment-id="${assessmentId}"]`);
                        if (inputInRow) {
                            inputInRow.value = line.trim().replace(',', '.');
                            // Dispara o evento 'blur' para aplicar a formata√ß√£o e valida√ß√£o
                            inputInRow.dispatchEvent(new Event('blur', { bubbles: true }));
                        }
                        currentTr = currentTr.nextElementSibling;
                    }
                });
                
                // Salva os dados sem redesenhar a tela inteira
                const assessment = avaliacoes.find(av => av.id === parseInt(assessmentId));
                if (assessment) {
                    const allInputsForColumn = document.querySelectorAll(`.grade-input[data-assessment-id="${assessmentId}"]`);
                    const newGrades = [];
                     allInputsForColumn.forEach(input => {
                        const studentId = parseInt(input.dataset.studentId);
                        const grade = input.value !== '' ? parseFloat(input.value.replace(',', '.')) : null;
                        if (grade !== null && !isNaN(grade)) {
                           newGrades.push({ studentId, grade });
                        }
                    });
                    assessment.grades = newGrades;
                    saveAvaliacoes();
                }
            }
        });


        editAllNotesBtn.addEventListener('click', () => {
            const isEditing = editAllNotesBtn.dataset.editing === 'true';
            if (isEditing) {
                const allAssessments = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod);
                allAssessments.forEach(av => saveColumnNotes(av.id));
                renderNotesView(null, false);
                showModal('Todas as notas foram salvas.');
            } else {
                renderNotesView(null, true);
            }
        });

        importNotesBtn.addEventListener('click', () => {
            importNotesSourceSelect.innerHTML = ''; // Limpa op√ß√µes anteriores
            const resultIdVistos = `${selectedClassId}-${selectedPeriod}`;
            const currentVistosResult = vistosResults.find(r => r.id === resultIdVistos);

            const resultIdContinuous = `ca-${selectedClassId}-${selectedPeriod}`;
            const currentContinuousResult = continuousAssessmentsResults.find(r => r.id === resultIdContinuous);

            let hasOptions = false;
            if (currentVistosResult) {
                const option = document.createElement('option');
                option.value = 'vistos';
                option.textContent = `Total de Vistos (Valor: ${currentVistosResult.totalValue.toFixed(1).replace('.',',')})`;
                importNotesSourceSelect.appendChild(option);
                hasOptions = true;
            }

            if (currentContinuousResult) {
                const option = document.createElement('option');
                option.value = 'continuous';
                option.textContent = `Total de Avalia√ß√µes Cont√≠nuas`;
                importNotesSourceSelect.appendChild(option);
                hasOptions = true;
            }

            if (hasOptions) {
                importNotesForm.reset();
                importNotesModalOverlay.classList.remove('hidden');
            } else {
                showModal('N√£o h√° resultados calculados em "Atividades" para importar.');
            }
        });

        cancelImportNotesBtn.addEventListener('click', () => {
            importNotesModalOverlay.classList.add('hidden');
        });

        importNotesForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const newName = document.getElementById('import-notes-name').value.trim();
            const source = importNotesSourceSelect.value;

            if (!newName || !source) {
                showModal('Por favor, preencha o nome da avalia√ß√£o e selecione uma fonte de dados.');
                return;
            }

            const isDuplicate = avaliacoes.some(av => av.classId === selectedClassId && av.period === selectedPeriod && av.name.toLowerCase() === newName.toLowerCase());
            if (isDuplicate) {
                showModal('J√° existe uma avalia√ß√£o com este nome neste per√≠odo.');
                return;
            }

            let sourceData;
            let value = 10; // Valor padr√£o para Avalia√ß√µes Cont√≠nuas (m√©dia)
            if (source === 'vistos') {
                const resultId = `${selectedClassId}-${selectedPeriod}`;
                sourceData = vistosResults.find(r => r.id === resultId);
                value = sourceData.totalValue;
            } else { // continuous
                const resultId = `ca-${selectedClassId}-${selectedPeriod}`;
                sourceData = continuousAssessmentsResults.find(r => r.id === resultId);
            }

            if (!sourceData) {
                showModal('Erro ao encontrar os dados de origem. Por favor, tente novamente.');
                return;
            }

            const newId = Date.now();
            const newGrades = sourceData.scores.map(s => ({ studentId: s.studentId, grade: s.score }));
            
            avaliacoes.push({
                id: newId,
                name: newName,
                value: value,
                classId: selectedClassId,
                period: selectedPeriod,
                grades: newGrades
            });

            saveAvaliacoes();
            renderNotesView();
            importNotesModalOverlay.classList.add('hidden');
            showModal('Notas importadas com sucesso!');
        });

        recoveryBtn.addEventListener('click', () => {
            recoveryForm.reset();
            recoveryAssessmentSelection.classList.add('hidden');
            const institution = institutions.find(i => i.id === selectedInstitutionId);
            const periodOption = recoveryTypeSelect.querySelector('option[value="period"]');
            if (institution) {
                const periodTypeName = institution.periodType;
                periodOption.textContent = `Recupera√ß√£o ${periodTypeName}`;
            }
            recoveryModalOverlay.classList.remove('hidden');
        });

        cancelRecoveryBtn.addEventListener('click', () => {
            recoveryModalOverlay.classList.add('hidden');
        });

        recoveryTypeSelect.addEventListener('change', () => {
            if (recoveryTypeSelect.value === 'assessment') {
                const assessments = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod && !av.isRecovery);
                recoveryAssessmentSelect.innerHTML = '<option value="">-- Selecione --</option>';
                assessments.forEach(av => {
                    const option = document.createElement('option');
                    option.value = av.id;
                    option.textContent = av.name;
                    recoveryAssessmentSelect.appendChild(option);
                });
                recoveryAssessmentSelection.classList.remove('hidden');
            } else {
                recoveryAssessmentSelection.classList.add('hidden');
            }
        });

        recoveryForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const type = recoveryTypeSelect.value;
            if (!type) {
                showModal('Selecione um tipo de recupera√ß√£o.');
                return;
            }

            if (type === 'assessment') {
                const originalId = parseInt(recoveryAssessmentSelect.value);
                if (!originalId) {
                    showModal('Selecione uma avalia√ß√£o para recuperar.');
                    return;
                }
                const originalAssessment = avaliacoes.find(av => av.id === originalId);
                const newId = Date.now();
                avaliacoes.push({
                    id: newId,
                    name: `Rec. ${originalAssessment.name}`,
                    value: originalAssessment.value,
                    classId: selectedClassId,
                    period: selectedPeriod,
                    grades: [],
                    isRecovery: true,
                    recoveryType: 'assessment',
                    originalAssessmentId: originalId
                });
            } else { // period
                const newId = Date.now();
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                const periodTypeName = institution ? institution.periodType : 'Per√≠odo';
                avaliacoes.push({
                    id: newId,
                    name: `Recupera√ß√£o ${periodTypeName}`,
                    value: 10.0, // Recupera√ß√£o final √© base 10
                    classId: selectedClassId,
                    period: selectedPeriod,
                    grades: [],
                    isRecovery: true,
                    recoveryType: 'period'
                });
            }
            saveAvaliacoes();
            renderNotesView();
            recoveryModalOverlay.classList.add('hidden');
        });

        // --- EVENTOS DA TELA DE ATIVIDADES ---
        toggleVistosPanelBtn.addEventListener('click', () => {
            vistosPanel.classList.toggle('hidden');
            continuousAssessmentPanel.classList.add('hidden');
            if (!vistosPanel.classList.contains('hidden')) {
                renderVistosView();
            }
        });

        toggleContinuousAssessmentPanelBtn.addEventListener('click', () => {
            continuousAssessmentPanel.classList.toggle('hidden');
            vistosPanel.classList.add('hidden');
            if (!continuousAssessmentPanel.classList.contains('hidden')) {
                renderContinuousAssessmentsView();
            }
        });

        addVistoBtn.addEventListener('click', () => {
            vistoForm.reset();
            document.getElementById('visto-id').value = '';
            vistoFormPanel.classList.remove('hidden');
        });

        cancelVistoEditBtn.addEventListener('click', () => {
            vistoFormPanel.classList.add('hidden');
        });

        vistoForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const idInput = document.getElementById('visto-id');
            const dateInput = document.getElementById('visto-date');
            const descriptionInput = document.getElementById('visto-description');

            const id = parseInt(idInput.value);
            const date = dateInput.value;
            const description = descriptionInput.value.trim();

            if (!date || !description) {
                showModal('Data e descri√ß√£o s√£o obrigat√≥rias.');
                return;
            }

            const resultId = `${selectedClassId}-${selectedPeriod}`;
            vistosResults = vistosResults.filter(r => r.id !== resultId);
            saveVistosResults();

            if (id) {
                const index = vistos.findIndex(v => v.id === id);
                if (index > -1) {
                    vistos[index].date = date;
                    vistos[index].description = description;
                }
            } else {
                const newId = Date.now();
                vistos.push({ id: newId, date, description, classId: selectedClassId, period: selectedPeriod, records: [] });
            }
            saveVistos();
            renderVistosView();
            vistoFormPanel.classList.add('hidden');
        });

        activitiesView.addEventListener('click', async (event) => {
            const target = event.target;
            
            // L√≥gica de filtro
            if (target.classList.contains('table-filter-checkbox')) {
                handleTableFilter(target);
                return;
            }

            const button = target.closest('button');
            if (!button) return;

            // Check if it's a CA button before parsing ID
            if (button.classList.contains('edit-continuous-assessment-btn') || 
                button.classList.contains('remove-continuous-assessment-btn') ||
                button.classList.contains('save-col-btn') ||
                button.classList.contains('edit-col-btn')) {
                return; // Let the other listener handle it
            }

            const vistoId = parseInt(button.dataset.id);
            if (isNaN(vistoId)) return;

            if (button.classList.contains('edit-visto-btn')) {
                const visto = vistos.find(v => v.id === vistoId);
                if (visto) {
                    document.getElementById('visto-id').value = visto.id;
                    document.getElementById('visto-date').value = visto.date;
                    document.getElementById('visto-description').value = visto.description;
                    vistoFormPanel.classList.remove('hidden');
                }
            } else if (button.classList.contains('info-visto-btn')) {
                const visto = vistos.find(v => v.id === vistoId);
                if (visto) {
                    showModal(`Descri√ß√£o: ${visto.description}`);
                }
            } else if (button.classList.contains('remove-visto-btn')) {
                const confirmed = await showModal('Tem certeza que deseja remover este visto e todos os seus registros?', true);
                if (confirmed) {
                    vistos = vistos.filter(v => v.id !== vistoId);
                    const resultId = `${selectedClassId}-${selectedPeriod}`;
                    vistosResults = vistosResults.filter(r => r.id !== resultId);
                    saveVistos();
                    saveVistosResults();
                    renderVistosView();
                }
            }
        });

        activitiesView.addEventListener('change', (event) => {
            const select = event.target;
            if (select.classList.contains('visto-select')) {
                const studentId = parseInt(select.dataset.studentId);
                const vistoId = parseInt(select.dataset.vistoId);
                const value = select.value;

                const visto = vistos.find(v => v.id === vistoId);
                if (!visto) return;

                const recordIndex = visto.records.findIndex(r => r.studentId === studentId);

                if (recordIndex > -1) {
                    if (value === '-') {
                        visto.records.splice(recordIndex, 1);
                    } else {
                        visto.records[recordIndex].value = value;
                    }
                } else if (value !== '-') {
                    visto.records.push({ studentId, value });
                }
                saveVistos();
            }
        });

        calculateVistosBtn.addEventListener('click', () => {
            vistoCalcPanel.classList.remove('hidden');
        });
        cancelVistoCalcBtn.addEventListener('click', () => {
            vistoCalcPanel.classList.add('hidden');
        });

        vistoCalcForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const totalValueInput = document.getElementById('visto-calc-total-value');
            const totalValue = parseFloat(totalValueInput.value.replace(',', '.'));

            if (isNaN(totalValue)) {
                showModal('Por favor, insira um valor total v√°lido.');
                return;
            }

            const vistosDaTurma = vistos.filter(v => v.classId === selectedClassId && v.period === selectedPeriod);
            if (vistosDaTurma.length === 0) {
                showModal('N√£o h√° vistos para calcular. Adicione colunas de vistos primeiro.');
                return;
            }

            const valuePerColumn = totalValue / vistosDaTurma.length;
            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId && a.active !== false);
            const scores = [];

            const multipliers = { 'C': 1, 'I': 0.5, 'AT': 0.8, 'F': 0, 'NFT': 0, 'NTM': 0, '-': 0 };

            alunosDaTurma.forEach(aluno => {
                let totalScore = 0;
                vistosDaTurma.forEach(visto => {
                    const record = visto.records.find(r => r.studentId === aluno.id);
                    const value = record ? record.value : '-';
                    const multiplier = multipliers[value] || 0;
                    totalScore += valuePerColumn * multiplier;
                });
                scores.push({ studentId: aluno.id, score: roundToOneDecimal(totalScore) });
            });

            const resultId = `${selectedClassId}-${selectedPeriod}`;
            const resultIndex = vistosResults.findIndex(r => r.id === resultId);
            const newResult = { id: resultId, classId: selectedClassId, period: selectedPeriod, totalValue, scores };

            if (resultIndex > -1) {
                vistosResults[resultIndex] = newResult;
            } else {
                vistosResults.push(newResult);
            }
            
            saveVistosResults();
            renderVistosView();
            vistoCalcPanel.classList.add('hidden');
        });

        // --- EVENTOS DE AVALIA√á√ïES CONT√çNUAS ---
        addContinuousAssessmentBtn.addEventListener('click', () => {
            continuousAssessmentForm.reset();
            document.getElementById('continuous-assessment-id').value = '';
            continuousAssessmentFormPanel.classList.remove('hidden');
        });

        cancelContinuousAssessmentEditBtn.addEventListener('click', () => {
            continuousAssessmentFormPanel.classList.add('hidden');
        });

        continuousAssessmentForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const idInput = document.getElementById('continuous-assessment-id');
            const dateInput = document.getElementById('continuous-assessment-date');
            const id = parseInt(idInput.value);
            const date = dateInput.value;

            if (!date) {
                showModal('A data √© obrigat√≥ria.');
                return;
            }

            const resultId = `ca-${selectedClassId}-${selectedPeriod}`;
            continuousAssessmentsResults = continuousAssessmentsResults.filter(r => r.id !== resultId);
            saveContinuousAssessmentsResults();

            if (id) {
                const index = continuousAssessments.findIndex(v => v.id === id);
                if (index > -1) {
                    continuousAssessments[index].date = date;
                }
                saveContinuousAssessments();
                renderContinuousAssessmentsView();
            } else {
                const newId = Date.now();
                continuousAssessments.push({ id: newId, date, classId: selectedClassId, period: selectedPeriod, grades: [] });
                saveContinuousAssessments();
                renderContinuousAssessmentsView(newId);
            }
            continuousAssessmentFormPanel.classList.add('hidden');
        });

        function saveContinuousColumnNotes(assessmentId) {
            const inputs = document.querySelectorAll(`#continuous-assessment-table .grade-input[data-assessment-id="${assessmentId}"]`);
            const assessment = continuousAssessments.find(av => av.id === assessmentId);
            if (!assessment) return;

            const newGrades = [];
            inputs.forEach(input => {
                const studentId = parseInt(input.dataset.studentId);
                const grade = input.value !== '' ? parseFloat(input.value.replace(',', '.')) : null;

                if (grade !== null && !isNaN(grade)) {
                    newGrades.push({ studentId, grade });
                }
            });

            assessment.grades = newGrades;
            saveContinuousAssessments();
        }
        
        continuousAssessmentPanel.addEventListener('click', async (event) => {
            const target = event.target;
            const button = target.closest('button');

            if (button) {
                const assessmentId = parseInt(button.dataset.id);
                if (isNaN(assessmentId)) return;

                if (button.classList.contains('edit-continuous-assessment-btn')) {
                    const assessment = continuousAssessments.find(av => av.id === assessmentId);
                    if (assessment) {
                        document.getElementById('continuous-assessment-id').value = assessment.id;
                        document.getElementById('continuous-assessment-date').value = assessment.date;
                        continuousAssessmentFormPanel.classList.remove('hidden');
                    }
                } else if (button.classList.contains('edit-col-btn')) {
                    renderContinuousAssessmentsView(assessmentId);
                } else if (button.classList.contains('save-col-btn')) {
                    saveContinuousColumnNotes(assessmentId);
                    renderContinuousAssessmentsView();
                } else if (button.classList.contains('remove-continuous-assessment-btn')) {
                    const confirmed = await showModal('Tem certeza que deseja remover esta avalia√ß√£o e todas as suas notas?', true);
                    if (confirmed) {
                        continuousAssessments = continuousAssessments.filter(av => av.id !== assessmentId);
                        const resultId = `ca-${selectedClassId}-${selectedPeriod}`;
                        continuousAssessmentsResults = continuousAssessmentsResults.filter(r => r.id !== resultId);
                        saveContinuousAssessments();
                        saveContinuousAssessmentsResults();
                        renderContinuousAssessmentsView();
                    }
                }
            }
        });

        // IN√çCIO: L√ìGICA CORRIGIDA PARA AVALIA√á√ïES CONT√çNUAS
        continuousAssessmentPanel.addEventListener('blur', (event) => {
            const input = event.target;
            if (input.classList.contains('grade-input')) {
                if (input.value.trim() === '') return;

                let valueStr = input.value.replace(',', '.');
                let value = parseFloat(valueStr);
                const maxValue = parseFloat(input.max);

                if (isNaN(value)) {
                    input.value = ''; // Limpa se a entrada for inv√°lida
                    return;
                }

                // 1. Tenta formatar (ex: 75 -> 7.5)
                if (value > maxValue && valueStr.indexOf('.') === -1) {
                    value = value / 10;
                }

                // 2. Garante que n√£o ultrapasse o valor m√°ximo
                if (value > maxValue) {
                    value = maxValue;
                }
                
                // 3. Garante que n√£o seja menor que o valor m√≠nimo
                if (value < 0) {
                    value = 0;
                }

                // 4. Define o valor final formatado
                input.value = value.toFixed(1);
            }
        }, true);


        continuousAssessmentPanel.addEventListener('keydown', (event) => {
            if (!event.target.classList.contains('grade-input')) return;

            if (event.key === 'Enter') {
                event.preventDefault();
                const currentInput = event.target;
                const currentTr = currentInput.closest('tr');
                let nextTr = currentTr.nextElementSibling;
                
                while(nextTr && nextTr.classList.contains('inactive-student-row')) {
                    nextTr = nextTr.nextElementSibling;
                }

                if (nextTr) {
                    const sameColInput = nextTr.querySelector(`.grade-input[data-assessment-id="${currentInput.dataset.assessmentId}"]`);
                    if (sameColInput) {
                        sameColInput.parentElement.classList.add('editing');
                        sameColInput.focus();
                        sameColInput.select();
                    }
                }
            }
        });

        continuousAssessmentPanel.addEventListener('paste', (event) => {
            const targetInput = event.target;
            if (!targetInput.classList.contains('grade-input')) return;

            event.preventDefault();
            const pasteData = (event.clipboardData || window.clipboardData).getData('text');
            const lines = pasteData.split(/\r?\n/).filter(line => line.trim() !== '');

            if (lines.length > 0) {
                const assessmentId = targetInput.dataset.assessmentId;
                let currentTr = targetInput.closest('tr');

                lines.forEach((line) => {
                    if (currentTr) {
                        while(currentTr && currentTr.classList.contains('inactive-student-row')) {
                            currentTr = currentTr.nextElementSibling;
                        }
                        if (!currentTr) return;

                        const inputInRow = currentTr.querySelector(`.grade-input[data-assessment-id="${assessmentId}"]`);
                        if (inputInRow) {
                            inputInRow.value = line.trim().replace(',', '.');
                            inputInRow.dispatchEvent(new Event('blur', { bubbles: true }));
                        }
                        currentTr = currentTr.nextElementSibling;
                    }
                });
                
                saveContinuousColumnNotes(parseInt(assessmentId));
            }
        });
        // FIM: L√ìGICA CORRIGIDA

        calculateContinuousAssessmentBtn.addEventListener('click', () => {
            const assessments = continuousAssessments.filter(v => v.classId === selectedClassId && v.period === selectedPeriod);
            if (assessments.length === 0) {
                showModal('N√£o h√° avalia√ß√µes para calcular a m√©dia.');
                return;
            }

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId && a.active !== false);
            const scores = [];

            alunosDaTurma.forEach(aluno => {
                let totalScore = 0;
                let count = 0;
                assessments.forEach(assessment => {
                    const record = assessment.grades.find(r => r.studentId === aluno.id);
                    if (record && record.grade !== null) {
                        totalScore += record.grade;
                        count++;
                    }
                });
                const average = count > 0 ? totalScore / count : 0;
                scores.push({ studentId: aluno.id, score: roundToOneDecimal(average) });
            });

            const resultId = `ca-${selectedClassId}-${selectedPeriod}`;
            const resultIndex = continuousAssessmentsResults.findIndex(r => r.id === resultId);
            const newResult = { id: resultId, classId: selectedClassId, period: selectedPeriod, scores };

            if (resultIndex > -1) {
                continuousAssessmentsResults[resultIndex] = newResult;
            } else {
                continuousAssessmentsResults.push(newResult);
            }
            
            saveContinuousAssessmentsResults();
            renderContinuousAssessmentsView();
        });

        editAllContinuousAssessmentsBtn.addEventListener('click', () => {
            const isEditing = editAllContinuousAssessmentsBtn.dataset.editing === 'true';
            if (isEditing) {
                const allAssessments = continuousAssessments.filter(av => av.classId === selectedClassId && av.period === selectedPeriod);
                allAssessments.forEach(av => saveContinuousColumnNotes(av.id));
                renderContinuousAssessmentsView(null, false);
                showModal('Todas as notas foram salvas.');
            } else {
                renderContinuousAssessmentsView(null, true);
            }
        });

        // --- EVENTOS DA TELA DE FAVORITOS ---
        addFavoriteBtn.addEventListener('click', () => {
            favoriteFormPanel.classList.toggle('hidden');
            favoriteForm.reset();
            favoriteYearSelect.innerHTML = '<option value="">Selecione um Ano Letivo</option>';
            favoritePeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';

            favoriteInstitutionSelect.innerHTML = '<option value="">Selecione uma Institui√ß√£o</option>';
            institutions.forEach(inst => {
                const option = document.createElement('option');
                option.value = inst.id;
                option.textContent = inst.name;
                favoriteInstitutionSelect.appendChild(option);
            });
        });

        favoriteInstitutionSelect.addEventListener('change', () => {
            const instId = parseInt(favoriteInstitutionSelect.value);
            const institution = institutions.find(i => i.id === instId);

            favoriteYearSelect.innerHTML = '<option value="">Selecione um Ano Letivo</option>';
            anosLetivos.filter(y => y.institutionId === instId).forEach(year => {
                const option = document.createElement('option');
                option.value = year.id;
                option.textContent = year.year;
                favoriteYearSelect.appendChild(option);
            });

            favoritePeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
            if (institution) {
                 let periodOptions = [];
                switch (institution.periodType) {
                    case 'Bimestral': periodOptions = ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre', 'M√©dias Finais']; break;
                    case 'Trimestral': periodOptions = ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre', 'M√©dias Finais']; break;
                    case 'Semestral': periodOptions = ['1¬∫ Semestre', '2¬∫ Semestre', 'M√©dias Finais']; break;
                }
                periodOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    favoritePeriodSelect.appendChild(option);
                });
            }
        });

        favoriteForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const name = document.getElementById('favorite-name-input').value.trim();
            const instId = parseInt(favoriteInstitutionSelect.value);
            const yearId = parseInt(favoriteYearSelect.value);
            const period = favoritePeriodSelect.value;

            if(!name || !instId || !yearId || !period) {
                showModal('Todos os campos s√£o obrigat√≥rios.');
                return;
            }

            const newId = Date.now();
            favorites.push({ id: newId, name, institutionId: instId, yearId, period });
            saveFavorites();
            renderFavorites();
            favoriteFormPanel.classList.add('hidden');
        });

        favoriteListContainer.addEventListener('click', async (event) => {
            const button = event.target.closest('button');
            if (!button) return;

            const favId = parseInt(button.dataset.id);
            const favorite = favorites.find(f => f.id === favId);

            if (button.classList.contains('go-favorite-btn')) {
                if (favorite) {
                    selectedInstitutionId = favorite.institutionId;
                    selectedYearId = favorite.yearId;
                    selectedPeriod = favorite.period;
                    navigateTo('period-selection-view', { fromFavorite: true });
                }
            }

            if (button.classList.contains('remove-favorite-btn')) {
                const confirmed = await showModal('Tem certeza que deseja remover este favorito?', true);
                if (confirmed) {
                    favorites = favorites.filter(f => f.id !== favId);
                    saveFavorites();
                    renderFavorites();
                }
            }
        });

        // --- EVENTOS DA TELA DE RELAT√ìRIOS ---
        reportInstitutionSelect.addEventListener('change', () => {
            const instId = parseInt(reportInstitutionSelect.value);
            const institution = institutions.find(i => i.id === instId);

            reportYearSelect.innerHTML = '<option value="">Selecione um Ano Letivo</option>';
            anosLetivos.filter(y => y.institutionId === instId).sort((a,b) => b.year - a.year).forEach(year => {
                const option = document.createElement('option');
                option.value = year.id;
                option.textContent = year.year;
                reportYearSelect.appendChild(option);
            });
            
            reportClassSelect.innerHTML = '<option value="">Selecione uma Turma</option>';
            reportPeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';

            // Update report type options
            reportTypeSelect.innerHTML = '<option value="">Selecione um Tipo de Relat√≥rio</option>';
            if (institution) {
                const periodTypeName = institution.periodType;
                
                const option1 = document.createElement('option');
                option1.value = 'complete';
                option1.textContent = 'Relat√≥rio Completo';
                reportTypeSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = 'recovery-students';
                option2.textContent = `Alunos em Recupera√ß√£o ${periodTypeName}`;
                reportTypeSelect.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = 'recovery-grades';
                option3.textContent = `Notas da Recupera√ß√£o ${periodTypeName}`;
                reportTypeSelect.appendChild(option3);

                const option4 = document.createElement('option');
                option4.value = 'final-grades';
                option4.textContent = 'M√©dias Finais';
                reportTypeSelect.appendChild(option4);
            }
        });

        reportYearSelect.addEventListener('change', () => {
            const yearId = parseInt(reportYearSelect.value);
            const hasClasses = renderClassSelection(reportClassSelect, yearId);
            if (hasClasses) {
                const allTurmasOption = document.createElement('option');
                allTurmasOption.value = 'all';
                allTurmasOption.textContent = 'Todas as Turmas';
                reportClassSelect.insertBefore(allTurmasOption, reportClassSelect.children[1]);
            }
            reportPeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
        });

        reportClassSelect.addEventListener('change', () => {
            const instId = parseInt(reportInstitutionSelect.value);
            const institution = institutions.find(i => i.id === instId);
            reportPeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
            if (institution) {
                 let periodOptions = [];
                switch (institution.periodType) {
                    case 'Bimestral': periodOptions = ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre', 'M√©dias Finais']; break;
                    case 'Trimestral': periodOptions = ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre', 'M√©dias Finais']; break;
                    case 'Semestral': periodOptions = ['1¬∫ Semestre', '2¬∫ Semestre', 'M√©dias Finais']; break;
                }
                periodOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    reportPeriodSelect.appendChild(option);
                });
            }
        });
        
        // --- L√ìGICA DE GERA√á√ÉO DE RELAT√ìRIOS ---
        
        /**
         * Gera e exibe o relat√≥rio com base nos filtros selecionados.
         */
        function generateAndDisplayReport() {
            const instId = parseInt(reportInstitutionSelect.value);
            const yearId = parseInt(reportYearSelect.value);
            const classIdValue = reportClassSelect.value;
            const period = reportPeriodSelect.value;
            const type = reportTypeSelect.value;
        
            if (!instId || !yearId || !classIdValue || !period || !type) {
                showModal('Por favor, preencha todos os filtros para gerar o relat√≥rio.');
                return;
            }
        
            const institution = institutions.find(i => i.id === instId);
            const year = anosLetivos.find(y => y.id === yearId);
        
            let reportHTML = '';
            
            const classesToReport = classIdValue === 'all'
                ? turmas.filter(t => t.yearId === yearId)
                : [turmas.find(t => t.id === parseInt(classIdValue))];
        
            classesToReport.forEach(turma => {
                if (!turma) return;
        
                const reportTitle = `
                    <h3>${institution.name}</h3>
                    <h4>Ano Letivo: ${year.year}</h4>
                    <h4>Turma: ${turma.name} - ${turma.subject}</h4>
                    <h4>Per√≠odo: ${period}</h4>
                `;
        
                let tableHTML = '';
                switch (type) {
                    case 'complete':
                        tableHTML = generateCompleteReportHTML(institution, turma.id, period);
                        break;
                    case 'recovery-students':
                        tableHTML = generateRecoveryStudentsReportHTML(institution, turma.id, period);
                        break;
                    case 'recovery-grades':
                        tableHTML = generateRecoveryGradesReportHTML(institution, turma.id, period);
                        break;
                    case 'final-grades':
                        tableHTML = generateFinalGradesReportHTML(institution, turma.id);
                        break;
                }
                reportHTML += `<div class="report-content align-center">${reportTitle}${tableHTML}</div><hr>`;
            });
        
            if (reportHTML) {
                reportOutputContainer.innerHTML = reportHTML;
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'report-controls';
        
                const alignControls = document.createElement('div');
                alignControls.className = 'align-controls';
                alignControls.innerHTML = `
                    <button class="align-btn" data-align="left">E</button>
                    <button class="align-btn active" data-align="center">C</button>
                    <button class="align-btn" data-align="right">D</button>
                `;
        
                const printButton = document.createElement('button');
                printButton.textContent = 'Imprimir Relat√≥rio';
                printButton.onclick = () => window.print();
        
                controlsContainer.appendChild(alignControls);
                controlsContainer.appendChild(printButton);
                reportOutputContainer.appendChild(controlsContainer);
        
                alignControls.addEventListener('click', (e) => {
                    if (e.target.classList.contains('align-btn')) {
                        const align = e.target.dataset.align;
                        const allReportContents = reportOutputContainer.querySelectorAll('.report-content');
                        allReportContents.forEach(content => {
                            content.classList.remove('align-left', 'align-center', 'align-right');
                            content.classList.add(`align-${align}`);
                        });
        
                        alignControls.querySelectorAll('.align-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                    }
                });
            } else {
                reportOutputContainer.innerHTML = '<p>Nenhum dado encontrado para os filtros selecionados.</p>';
            }
        }
        
        function generateCompleteReportHTML(institution, classId, period) {
            const studentList = alunos.filter(a => a.classId === classId && a.active !== false).sort((a,b) => a.number - b.number);
            const assessments = avaliacoes.filter(av => av.classId === classId && av.period === period && !av.isRecovery);
            const recoveries = avaliacoes.filter(av => av.isRecovery && av.classId === classId && av.period === period);
            const periodResult = notesResults.find(r => r.id === `notes-${classId}-${period}`);
        
            let headers = '<th>Aluno</th>';
            assessments.forEach(av => {
                headers += `<th>${av.name}</th>`;
                if(recoveries.some(rec => rec.originalAssessmentId === av.id)) headers += `<th>Rec. ${av.name}</th>`;
            });
            const periodRecovery = recoveries.find(rec => rec.recoveryType === 'period');
            if(periodRecovery) {
                let recName = 'Rec. Per√≠odo';
                if (institution) {
                    if (institution.periodType === 'Bimestral') recName = 'Rec. Bim.';
                    else if (institution.periodType === 'Trimestral') recName = 'Rec. Tri.';
                    else if (institution.periodType === 'Semestral') recName = 'Rec. Sem.';
                }
                headers += `<th>${recName}</th>`;
            }
            if(periodResult) headers += '<th>M√©dia</th><th>Situa√ß√£o</th>';
        
            let rows = '';
            studentList.forEach(student => {
                let row = `<tr><td>${student.number}. ${student.name}</td>`;
                assessments.forEach(av => {
                    const gradeObj = av.grades.find(g => g.studentId === student.id);
                    row += `<td>${gradeObj ? gradeObj.grade.toFixed(1).replace('.',',') : '-'}</td>`;
        
                    const recovery = recoveries.find(rec => rec.originalAssessmentId === av.id);
                    if(recovery) {
                        const recGradeObj = recovery.grades.find(g => g.studentId === student.id);
                        row += `<td>${recGradeObj ? recGradeObj.grade.toFixed(1).replace('.',',') : '-'}</td>`;
                    }
                });
                
                if(periodRecovery) {
                    const recGradeObj = periodRecovery.grades.find(g => g.studentId === student.id);
                    row += `<td>${recGradeObj ? recGradeObj.grade.toFixed(1).replace('.',',') : '-'}</td>`;
                }
                if(periodResult) {
                    const studentScoreObj = periodResult.scores.find(s => s.studentId === student.id);
                    if(studentScoreObj) {
                        let finalScore = studentScoreObj.score;
                        // **IN√çCIO DA CORRE√á√ÉO**
                        if(periodRecovery) {
                            const recoveryGradeObj = periodRecovery.grades.find(g => g.studentId === student.id);
                            if(recoveryGradeObj) {
                                finalScore = Math.max(finalScore, recoveryGradeObj.grade);
                            }
                        }
                        // **FIM DA CORRE√á√ÉO**
                        const isApproved = finalScore >= institution.passingGrade;
                        row += `<td>${finalScore.toFixed(1).replace('.',',')}</td>`;
                        row += `<td>${isApproved ? 'Aprovado' : 'Recupera√ß√£o'}</td>`;
                    } else {
                        row += '<td>-</td><td>-</td>';
                    }
                }
                row += '</tr>';
                rows += row;
            });
        
            return `<table class="data-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
        }
        
        function generateRecoveryStudentsReportHTML(institution, classId, period) {
            const studentList = alunos.filter(a => a.classId === classId && a.active !== false).sort((a, b) => a.number - b.number);
            const periodResult = notesResults.find(r => r.id === `notes-${classId}-${period}`);
            if (!periodResult) return '<p>As m√©dias deste per√≠odo ainda n√£o foram calculadas.</p>';

            let headers = '<th>Aluno</th><th>M√©dia</th>';
            let rows = '';

            studentList.forEach(student => {
                const studentScoreObj = periodResult.scores.find(s => s.studentId === student.id);
                // **CORRE√á√ÉO:** Usa a nota original (studentScoreObj.score) para determinar quem precisa de recupera√ß√£o.
                if (studentScoreObj && studentScoreObj.score < institution.passingGrade) {
                    rows += `<tr><td>${student.number}. ${student.name}</td><td>${studentScoreObj.score.toFixed(1).replace('.', ',')}</td></tr>`;
                }
            });

            if (!rows) return '<p>Nenhum aluno em recupera√ß√£o neste per√≠odo.</p>';
            return `<table class="data-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
        }

        function generateRecoveryGradesReportHTML(institution, classId, period) {
            const studentList = alunos.filter(a => a.classId === classId && a.active !== false).sort((a,b) => a.number - b.number);
            const recoveries = avaliacoes.filter(av => av.isRecovery && av.classId === classId && av.period === period);
            if(recoveries.length === 0) return '<p>Nenhuma avalia√ß√£o de recupera√ß√£o foi criada para este per√≠odo.</p>';
        
            let headers = '<th>Aluno</th>';
            recoveries.forEach(rec => headers += `<th>${rec.name}</th>`);
        
            let rows = '';
            // **CORRE√á√ÉO:** Filtra a lista de alunos para mostrar apenas aqueles com nota de recupera√ß√£o.
            const studentsWithRecoveryGrades = studentList.filter(student => {
                return recoveries.some(rec => rec.grades.some(g => g.studentId === student.id));
            });

            if(studentsWithRecoveryGrades.length === 0) return '<p>Nenhum aluno com nota de recupera√ß√£o lan√ßada.</p>';

            studentsWithRecoveryGrades.forEach(student => {
                let row = `<tr><td>${student.number}. ${student.name}</td>`;
                recoveries.forEach(rec => {
                    const gradeObj = rec.grades.find(g => g.studentId === student.id);
                    row += `<td>${gradeObj ? gradeObj.grade.toFixed(1).replace('.',',') : '-'}</td>`;
                });
                row += '</tr>';
                rows += row;
            });
            return `<table class="data-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
        }
        
        function generateFinalGradesReportHTML(institution, classId) {
             const studentList = alunos.filter(a => a.classId === classId && a.active !== false).sort((a,b) => a.number - b.number);
             const state = annualRecoveryState[classId] || { added: false, grades: [] };
        
            let periodOptions = [];
            let divisor = 1;
            switch (institution.periodType) {
                case 'Bimestral': periodOptions = ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre']; divisor = 4; break;
                case 'Trimestral': periodOptions = ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre']; divisor = 3; break;
                case 'Semestral': periodOptions = ['1¬∫ Semestre', '2¬∫ Semestre']; divisor = 2; break;
            }
        
            let headers = '<th>Aluno</th>';
            periodOptions.forEach(p => headers += `<th>${p.replace(' Bimestre', 'B').replace(' Trimestre', 'T').replace(' Semestre', 'S')}</th>`);
            if(state.added) headers += '<th>Rec. Anual</th>';
            headers += '<th>M√©dia Final</th><th>Situa√ß√£o</th>';
        
            let rows = '';
            studentList.forEach(student => {
                let row = `<tr><td>${student.number}. ${student.name}</td>`;
                let totalScore = 0;
                let periodCount = 0;
        
                periodOptions.forEach(p => {
                    const result = notesResults.find(r => r.id === `notes-${classId}-${p}`);
                    let score = null;
                    if(result) {
                        const scoreObj = result.scores.find(s => s.studentId === student.id);
                        if (scoreObj) {
                            score = scoreObj.score;
                            // **IN√çCIO DA CORRE√á√ÉO**
                            const periodRecovery = avaliacoes.find(av => av.classId === classId && av.period === p && av.recoveryType === 'period');
                            if (periodRecovery) {
                                const recoveryGradeObj = periodRecovery.grades.find(g => g.studentId === student.id);
                                if (recoveryGradeObj) {
                                    score = Math.max(score, recoveryGradeObj.grade);
                                }
                            }
                            // **FIM DA CORRE√á√ÉO**
                            totalScore += score;
                            periodCount++;
                        }
                    }
                    row += `<td>${score !== null ? score.toFixed(1).replace('.',',') : '-'}</td>`;
                });
        
                const originalAverage = periodCount > 0 ? totalScore / divisor : 0;
                let finalAverage = originalAverage;
        
                if (state.added) {
                    const recoveryGradeObj = state.grades.find(g => g.studentId === student.id);
                    const recoveryGrade = recoveryGradeObj ? recoveryGradeObj.grade : null;
                    if (recoveryGrade !== null && recoveryGrade > finalAverage) {
                        finalAverage = recoveryGrade;
                    }
                    row += `<td>${recoveryGrade !== null ? recoveryGrade.toFixed(1).replace('.',',') : '-'}</td>`;
                }
        
                const roundedAverage = roundToOneDecimal(finalAverage);
                const isApproved = roundedAverage >= institution.passingGrade;
                const situation = periodCount < divisor ? 'Cursando' : (isApproved ? 'Aprovado' : 'Reprovado');
        
                row += `<td>${roundedAverage.toFixed(1).replace('.',',')}</td><td>${situation}</td>`;
                row += '</tr>';
                rows += row;
            });
        
            return `<table class="data-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
        }
        
        reportFiltersForm.addEventListener('submit', (event) => {
            event.preventDefault();
            generateAndDisplayReport();
        });

        // --- EVENTOS DE BACKUP ---
        exportBackupBtn.addEventListener('click', () => {
            const backupData = {
                institutions,
                anosLetivos,
                turmas,
                alunos,
                avaliacoes,
                vistos,
                vistosResults,
                continuousAssessments,
                continuousAssessmentsResults,
                notesResults,
                favorites,
                annualRecoveryState
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            
            // Cria um nome de arquivo com data e hora
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = String(now.getFullYear()).slice(-2);
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const timestamp = `${day}_${month}_${year}-${hours}_${minutes}`;
            
            link.href = url;
            link.download = `diario_professor_backup_${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showModal('Backup exportado com sucesso!');
        });

        importBackupBtn.addEventListener('click', () => {
            importFileInput.click();
        });

        importFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const confirmed = await showModal('Tem certeza que deseja importar este backup? TODOS os dados atuais ser√£o substitu√≠dos. Esta a√ß√£o n√£o pode ser desfeita.', true);
            if (!confirmed) {
                importFileInput.value = ''; // Reset file input
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Valida√ß√£o simples para garantir que as chaves principais existem
                    const requiredKeys = ['institutions', 'anosLetivos', 'turmas', 'alunos', 'avaliacoes'];
                    const hasAllKeys = requiredKeys.every(key => key in data);

                    if (!hasAllKeys) {
                        throw new Error('Arquivo de backup inv√°lido ou corrompido.');
                    }

                    // Substitui os dados locais pelos dados do backup
                    institutions = data.institutions || [];
                    anosLetivos = data.anosLetivos || [];
                    turmas = data.turmas || [];
                    alunos = data.alunos || [];
                    avaliacoes = data.avaliacoes || [];
                    vistos = data.vistos || [];
                    vistosResults = data.vistosResults || [];
                    continuousAssessments = data.continuousAssessments || [];
                    continuousAssessmentsResults = data.continuousAssessmentsResults || [];
                    notesResults = data.notesResults || [];
                    favorites = data.favorites || [];
                    annualRecoveryState = data.annualRecoveryState || {};

                    // Salva todos os novos dados no localStorage
                    saveInstitutions();
                    saveAnosLetivos();
                    saveTurmas();
                    saveAlunos();
                    saveAvaliacoes();
                    saveVistos();
                    saveVistosResults();
                    saveContinuousAssessments();
                    saveContinuousAssessmentsResults();
                    saveNotesResults();
                    saveFavorites();
                    saveAnnualRecoveryState();

                    showModal('Backup importado com sucesso! A aplica√ß√£o ser√° recarregada.').then(() => {
                        location.reload();
                    });

                } catch (error) {
                    showModal(`Erro ao importar o backup: ${error.message}`);
                } finally {
                    importFileInput.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        });


        // --- L√ìGICA DE AUTENTICA√á√ÉO DO GOOGLE ---

        // Fun√ß√µes globais para serem chamadas pelos scripts do Google
        window.gapiLoaded = () => {
            gapi.load('client', initializeGapiClient);
        };

        window.gisInitialized = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // O callback √© definido dinamicamente
            });
            gisInited = true;
            maybeEnableButtons();
        };

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            const apiStatusDiv = document.getElementById('api-status');
            if (gapiInited && gisInited) {
                apiStatusDiv.textContent = 'API do Google pronta.';
                document.querySelectorAll('.signin-btn').forEach(btn => btn.classList.remove('hidden'));
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                await updateSigninStatus(true);
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateSigninStatus(false);
            }
        }

        async function updateSigninStatus(isSignedIn) {
            const authStatusSpans = document.querySelectorAll('.auth-status');
            const signinBtns = document.querySelectorAll('.signin-btn');
            const signoutBtns = document.querySelectorAll('.signout-btn');

            if (isSignedIn) {
                 try {
                    const res = await gapi.client.drive.about.get({ fields: 'user' });
                    const user = res.result.user;
                    authStatusSpans.forEach(span => span.textContent = `Logado como: ${user.displayName}`);
                    signinBtns.forEach(btn => btn.classList.add('hidden'));
                    signoutBtns.forEach(btn => btn.classList.remove('hidden'));
                 } catch (err) {
                    console.error("Erro ao buscar informa√ß√µes do usu√°rio:", err);
                    authStatusSpans.forEach(span => span.textContent = 'Erro ao obter dados do usu√°rio.');
                    signinBtns.forEach(btn => btn.classList.remove('hidden'));
                    signoutBtns.forEach(btn => btn.classList.add('hidden'));
                 }
            } else {
                authStatusSpans.forEach(span => span.textContent = 'N√£o conectado.');
                signinBtns.forEach(btn => btn.classList.remove('hidden'));
                signoutBtns.forEach(btn => btn.classList.add('hidden'));
            }
        }


        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
        function initialize() {
            if (!localStorage.getItem('app_initialized')) {
                // N√£o cria mais dados de exemplo, apenas marca como inicializado
                localStorage.setItem('app_initialized', 'true');
            }
            // Adiciona eventos a todos os bot√µes de login/logout
            document.querySelectorAll('.signin-btn').forEach(btn => btn.addEventListener('click', handleAuthClick));
            document.querySelectorAll('.signout-btn').forEach(btn => btn.addEventListener('click', handleSignoutClick));
            
            navigateTo('dashboard-view');
        }
        initialize();
    });
    </script>
    <!-- FIM DO JAVASCRIPT -->
</body>
</html>
