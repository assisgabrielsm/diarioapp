<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio do Professor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìñ</text></svg>">
    
    <!-- IN√çCIO DO CSS OTIMIZADO -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding-bottom: 40px; /* Espa√ßo para o rodap√© */
        }

        .hidden {
            display: none;
        }

        .view {
            width: 100%;
            max-width: 600px;
        }
        
        /* Regra que agrupa os pain√©is principais das views */
        .view-panel {
            max-width: 95%; 
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .1);
        }

        #dashboard-view {
            text-align: center;
        }

        .institution-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .institution-buttons button {
            padding: 20px;
            font-size: 1.2em;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color .2s, box-shadow .2s;
            flex-grow: 1;
            min-width: 200px;
        }

        .institution-buttons button:hover {
            background-color: #e9e9e9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
        }

        .management-buttons {
            margin-top: 40px;
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
        }

        .management-buttons button {
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            border: 1px solid #007bff;
            background-color: #fff;
            color: #007bff;
            border-radius: 5px;
            margin: 0 5px;
            flex-grow: 1; 
        }

        .management-buttons button:hover {
            background-color: #007bff;
            color: #fff;
        }

        .star-icon {
            color: #ffc107;
        }

        .manager-panel {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: left;
        }
        
        /* Regra que agrupa todos os formul√°rios com estilos comuns */
        .styled-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        /* Regra OTIMIZADA para todos os inputs, selects e bot√µes dentro dos formul√°rios */
        .styled-form input,
        .styled-form select,
        .styled-form button {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #visto-form, #continuous-assessment-form {
            align-items: stretch;
        }
        
        #visto-calc-form {
             align-items: center;
             flex-wrap: wrap;
             justify-content: center;
        }

        #visto-form .form-row {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        #visto-description {
            flex-grow: 1;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .list-container .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 5px;
            background-color: #fff;
        }
        
        .list-item.inactive .item-name {
            color: #999;
            text-decoration: line-through;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ccc;
            margin-right: 15px;
        }

        .item-name {
            font-weight: 700;
            flex-grow: 1;
        }

        .item-actions button {
            margin-left: 5px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.2em;
        }

        .global-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .header-top-row {
            display: flex;
            justify-content: flex-start; 
            width: 100%;
            margin-bottom: 10px;
        }
        
        .header-button-group {
            display: flex;
            gap: 15px;
        }

        .header-bottom-row {
            width: 100%;
        }

        .global-header h2 {
            margin: 0;
            font-size: 1.5em;
            text-align: center;
        }

        .header-btn {
            font-size: 1.5em;
            background: 0 0;
            border: none;
            cursor: pointer;
            padding: 0 5px;
            color: #333;
        }
        
        .header-btn.star-icon {
            color: #ffc107;
        }

        /* Regra que agrupa os mains das views */
        .view-panel main {
            text-align: center;
        }
        
        /* Regra que agrupa os selects principais */
        #year-select,
        #class-selection-for-students,
        #import-from-class-select,
        #period-select,
        #period-class-select {
            width: 100%;
            padding: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .main-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .main-buttons button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
        }

        .menu-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menu-button {
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
            border: 1px solid #ddd;
            background-color: #f7f7f7;
            border-radius: 8px;
        }

        .menu-button:hover {
            background-color: #e9e9e9;
        }

        #student-names-textarea,
        #student-list-edit-textarea {
            width: 95%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #student-list-edit-textarea {
            height: 150px;
        }

        /* ESTILOS UNIFICADOS PARA TABELAS */
        .table-container {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: auto;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
            vertical-align: middle;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
        
        .data-table tbody tr:nth-child(even) td {
            background-color: #f9f9f9;
        }
        
        .data-table .filter-hidden {
            display: none;
        }
        .student-name-cell {
            align-items: center;
            gap: 10px;
        }
        .student-name-cell input {
             margin-right: 5px;
        }

        .data-table th.student-name-header {
            min-width: 200px;
            position: sticky;
            left: 0;
            background-color: #f2f2f2;
            z-index: 2;
        }
        .data-table td:first-child {
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 1;
        }
        .data-table tbody tr:nth-child(even) td:first-child {
            background-color: #f9f9f9;
        }
        
        .data-table tr.inactive-student-row td {
            background-color: #f0f0f0;
            color: #aaa;
        }
        .data-table tr.inactive-student-row td:first-child {
             background-color: #e9e9e9;
        }

        .data-table th.result-header {
            width: 100px;
            min-width: 100px;
            position: sticky;
            left: 200px; 
            background-color: #e9ecef;
            z-index: 2;
        }
        .data-table td.result-cell {
            position: sticky;
            left: 200px; 
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
            z-index: 1;
        }
         .data-table tbody tr:nth-child(even) td.result-cell {
            background-color: #f1f3f5;
        }

        .data-table th.situation-col {
            width: 120px;
            min-width: 120px;
        }
        .data-table td.situation-cell {
            text-align: center;
        }

        .col-header {
            text-align: center;
            width: 1%;
        }
        .col-header > div:first-child {
            font-weight: bold;
        }
        
        .col-header-actions {
            font-size: 0.8em;
            margin-top: 5px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .col-header-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 1.2em;
        }
        .data-table .data-cell {
            text-align: center;
        }
        .data-cell input[type="number"], .data-table select {
            width: 80px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }
        .data-cell .grade-text { display: inline-block; }
        .data-cell .grade-input { display: none; }
        .data-cell.editing .grade-text { display: none; }
        .data-cell.editing .grade-input { display: inline-block; }
        
        /* Estilos para Relat√≥rios */
        #report-output-container {
            overflow: hidden;
        }
        #report-output-container .report-content {
            margin-bottom: 2rem;
        }
        #report-output-container .report-header {
            text-align: center;
        }
        #report-output-container .table-wrapper {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
        }
        #report-output-container .table-wrapper.align-left { justify-content: flex-start; }
        #report-output-container .table-wrapper.align-center { justify-content: center; }
        #report-output-container .table-wrapper.align-right { justify-content: flex-end; }
        
        #report-output-container .data-table:not(.proof-record-table) {
            width: auto; 
            display: inline-block;
        }
        #report-output-container .data-table th,
        #report-output-container .data-table td {
            padding: 4px 6px; 
            font-size: 0.9em; 
            text-align: center;
        }
        #report-output-container .data-table td:first-child {
            text-align: left;
        }
        .report-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
        }
        .align-controls button {
            padding: 5px 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .align-controls button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* Estilos para Ata de Prova */
        .report-extra-info {
            text-align: left;
            margin: 1rem 0;
            font-weight: bold;
        }
        #report-output-container .proof-record-table {
            width: 100%;
            table-layout: fixed !important; 
        }
        #report-output-container .proof-record-table .col-student {
            width: auto;
            text-align: left !important;
            white-space: normal;
            word-break: break-word;
        }
        #report-output-container .proof-record-table .col-sign {
            width: 35%;
        }
        
        /* Regra que agrupa os overlays dos modais */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.hidden {
            display: none;
        }

        .custom-modal-content {
            background-color: white;
            padding: 25px 35px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            text-align: center;
            max-width: 90%;
            width: 400px;
        }

        #custom-modal-message {
            margin: 0;
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.5;
        }

        #custom-modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
            font-weight: bold;
        }

        #modal-confirm-btn {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        #modal-cancel-btn {
            background-color: #f0f0f0;
        }

        #sync-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #6c757d;
            color: white;
            text-align: center;
            padding: 8px 0;
            font-size: 0.9em;
            z-index: 1001;
        }

        @media (max-width: 768px) {
            .data-table th.result-header,
            .data-table td.result-cell,
            .data-table th.situation-col,
            .data-table td.situation-cell {
                position: static;
            }
        }

        @media print {
            body * { visibility: hidden; }
            .report-content, .report-content * { visibility: visible; }
            .report-content { page-break-after: always; margin-bottom: 0; }
            .report-content:last-of-type { page-break-after: auto; }
            #report-output-container hr { display: none; }
            #reports-view.view-panel, #report-output-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 10px;
                box-shadow: none !important;
                border: none !important;
                background: none !important;
            }
            #report-output-container h3, #report-output-container h4 { text-align: center; color: black; }
            #report-output-container table {
                width: 100%;
                font-size: 8pt;
                color: black;
                border-collapse: collapse; 
                border: 1px solid #333; 
            }
             #report-output-container .proof-record-table {
                table-layout: fixed !important;
            }
            #report-output-container .align-left { justify-content: flex-start; }
            #report-output-container .align-center { justify-content: center; }
            #report-output-container .align-right { justify-content: flex-end; }
            #report-output-container th, #report-output-container td {
                border: 1px solid #333 !important;
                background-color: white !important;
                position: static !important;
            }
            .report-controls, #sync-footer, .slider-controls { display: none; }
        }
    </style>
    <!-- FIM DO CSS -->
</head>
<body>

    <!-- IN√çCIO DO HTML (com classes otimizadas) -->
    <div id="dashboard-view" class="view">
        <header class="dashboard-header"><h1>Di√°rio do Professor</h1></header>
        <main class="dashboard-main">
            <div id="institution-buttons-container" class="institution-buttons"></div>
            <div class="management-buttons">
                <button id="manage-institutions-btn">Gerenciar Institui√ß√µes</button>
                <button id="favorites-btn"><span class="star-icon">‚òÖ</span> Favoritos</button>
                <button class="reports-main-btn">üñ®Ô∏è Relat√≥rios</button>
                <button class="backup-btn">‚ÜïÔ∏è Backup</button>
            </div>
        </main>
        <div id="institution-manager-panel" class="manager-panel hidden">
            <h2>Gerenciar Institui√ß√µes</h2>
            <form id="institution-form" class="styled-form">
                <input type="hidden" id="institution-id">
                <input type="text" id="institution-name" placeholder="Nome da Institui√ß√£o" required>
                <select id="institution-period-type" required>
                    <option value="" disabled selected>Selecione o Per√≠odo</option>
                    <option value="Bimestral">Bimestral</option>
                    <option value="Trimestral">Trimestral</option>
                    <option value="Semestral">Semestral</option>
                </select>
                <input type="number" step="0.1" id="institution-passing-grade" placeholder="M√©dia" required>
                <div class="color-picker-wrapper">
                    <label for="institution-main-color">Cor:</label>
                    <input type="color" id="institution-main-color" value="#007bff">
                    <input type="text" id="institution-main-color-text" placeholder="#007bff" size="7">
                </div>
                <button type="submit">Salvar Institui√ß√£o</button>
                <button type="button" id="cancel-edit-btn" class="hidden">Cancelar Edi√ß√£o</button>
            </form>
            <hr>
            <h3>Institui√ß√µes Cadastradas</h3>
            <div id="institution-list" class="list-container"></div>
        </div>
    </div>

    <div id="year-selection-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="year-sel-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="home-btn" class="header-btn">üè†</button>
                    <button id="year-sel-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-year" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2 id="year-selection-title"></h2>
            </div>
        </header>
        <main>
            <h3>Selecione o Ano Letivo</h3>
            <select id="year-select"><option>Nenhum ano letivo cadastrado</option></select>
            <div class="main-buttons">
                <button id="confirm-year-btn">Confirmar Ano Selecionado</button>
                <button id="manage-years-btn">Gerenciar Anos Letivos</button>
            </div>
            <div id="year-manager-panel" class="manager-panel hidden">
                <hr>
                <h4>Gerenciar Anos Letivos</h4>
                <form id="year-form" class="styled-form">
                    <input type="number" id="year-input" placeholder="Digite o ano (ex: 2025)" required>
                    <button type="submit">Adicionar Ano</button>
                </form>
                <div id="year-list" class="list-container"></div>
            </div>
        </main>
    </div>

    <div id="main-menu-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="main-menu-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="main-menu-home-btn" class="header-btn">üè†</button>
                    <button id="main-menu-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-main" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2 id="main-menu-title"></h2>
            </div>
        </header>
        <main>
            <div class="menu-buttons-container">
                <button id="goto-class-registration-btn" class="menu-button">Cadastro de Turmas</button>
                <button id="goto-student-registration-btn" class="menu-button">Cadastro de Alunos</button>
                <button id="goto-period-selection-btn" class="menu-button">Selecionar Per√≠odo</button>
            </div>
        </main>
    </div>

    <div id="class-registration-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="class-reg-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="class-reg-home-btn" class="header-btn">üè†</button>
                    <button id="class-reg-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-class" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2 id="class-reg-title">Cadastro de Turmas</h2>
            </div>
        </header>
        <main>
            <div class="manager-panel">
                <form id="class-form" class="styled-form">
                    <input type="hidden" id="class-id">
                    <input type="text" id="class-name-input" placeholder="Nome da Turma (ex: 6¬∫ Ano A)" required>
                    <input type="text" id="class-subject-input" placeholder="Mat√©ria (ex: L√≠ngua Portuguesa)" required>
                    <button type="submit">Salvar Turma</button>
                </form>
                <hr>
                <h3>Turmas Cadastradas</h3>
                <div id="class-list-container" class="list-container"></div>
            </div>
        </main>
    </div>

    <div id="student-registration-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="student-reg-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="student-reg-home-btn" class="header-btn">üè†</button>
                    <button id="student-reg-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-student" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2 id="student-reg-title">Cadastro de Alunos</h2>
            </div>
        </header>
        <main>
            <div class="manager-panel">
                <label for="class-selection-for-students">Selecione uma turma para gerenciar os alunos:</label>
                <select id="class-selection-for-students"></select>
            </div>
            <div id="student-entry-container" class="manager-panel hidden">
                <h4>Adicionar Novos Alunos</h4>
                <p>Digite um nome por linha. Eles ser√£o numerados automaticamente.</p>
                <textarea id="student-names-textarea" rows="10" placeholder="Ana Silva&#10;Bruno Costa&#10;Carla Dias"></textarea>
                <div class="main-buttons">
                    <button id="add-students-btn">Adicionar Alunos</button>
                    <button id="edit-student-list-btn">Editar Lista</button>
                    <button id="import-students-btn">Importar Alunos</button>
                    <button id="inactivate-students-btn">Inativar Alunos</button>
                </div>
                
                <div id="student-list-edit-panel" class="manager-panel hidden">
                    <h4>Editando a Lista de Alunos</h4>
                    <p>Ajuste os nomes, adicione ou remova linhas. A lista ser√° salva e renumerada.</p>
                    <textarea id="student-list-edit-textarea" rows="15"></textarea>
                    <div class="main-buttons">
                        <button id="save-student-list-btn">Salvar Lista</button>
                        <button type="button" id="cancel-student-list-edit-btn">Cancelar</button>
                    </div>
                </div>

                <div id="inactivate-student-list-panel" class="manager-panel hidden">
                    <h4>Gerenciar Status dos Alunos</h4>
                    <p>Desmarque os alunos que foram transferidos ou sa√≠ram.</p>
                    <div id="inactivate-list-container" class="list-container" style="max-height: 300px; overflow-y: auto;"></div>
                    <div class="main-buttons">
                        <button id="save-inactivate-list-btn">Salvar Status</button>
                        <button type="button" id="cancel-inactivate-list-btn">Cancelar</button>
                    </div>
                </div>

                <div id="student-import-panel" class="manager-panel hidden">
                    <h4>Importar Alunos de outra Turma</h4>
                    <label for="import-from-class-select">Importar da turma:</label>
                    <select id="import-from-class-select"></select>
                    <div class="main-buttons">
                        <button id="confirm-import-btn">Confirmar Importa√ß√£o</button>
                        <button type="button" id="cancel-import-btn">Cancelar</button>
                    </div>
                </div>

                <hr>
                <h3>Alunos na Turma</h3>
                <div id="student-list-container" class="list-container"></div>
            </div>
        </main>
    </div>

    <div id="period-selection-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="period-sel-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="period-sel-home-btn" class="header-btn">üè†</button>
                    <button id="period-sel-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-period" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                 <h2 id="period-sel-title"></h2>
            </div>
        </header>
        <main>
            <div class="manager-panel">
                <label for="period-select">Selecione o Per√≠odo:</label>
                <select id="period-select"></select>
            </div>
            <div id="period-class-selection-container" class="manager-panel hidden">
                 <label for="period-class-select">Selecione a Turma:</label>
                 <select id="period-class-select"></select>
            </div>
            <div id="period-actions-container" class="main-buttons hidden"></div>
        </main>
    </div>

    <div id="notes-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="notes-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="notes-home-btn" class="header-btn">üè†</button>
                    <button id="notes-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-notes" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                 <h2 id="notes-title">Lan√ßamento de Notas</h2>
            </div>
        </header>
        <main>
            <div class="main-buttons">
                <button id="add-assessment-btn">Adicionar Avalia√ß√£o</button>
                <button id="import-notes-btn">Importar Notas</button>
                <button id="recovery-btn">Recupera√ß√£o</button>
                <button id="calculate-notes-btn">Calcular</button>
                <button id="calculate-final-grades-btn" class="hidden">Calcular</button>
                <button id="add-annual-recovery-btn" class="hidden">Recupera√ß√£o Anual</button>
            </div>
            <div id="assessment-panel" class="manager-panel hidden">
                <form id="assessment-form" class="styled-form">
                    <input type="hidden" id="assessment-id">
                    <input type="text" id="assessment-name" placeholder="Nome da Avalia√ß√£o (ex: P1)" required>
                    <input type="number" id="assessment-value" placeholder="Valor (ex: 10.0)" step="0.1" required>
                    <button type="submit">Salvar Avalia√ß√£o</button>
                    <button type="button" id="cancel-assessment-edit-btn">Cancelar</button>
                </form>
            </div>
            <div class="table-container">
                <table id="notes-table" class="data-table">
                    <thead>
                        <tr id="notes-table-header">
                            <th class="student-name-header">Aluno</th>
                        </tr>
                    </thead>
                    <tbody id="notes-table-body">
                    </tbody>
                </table>
            </div>
             <div id="edit-all-notes-container" class="main-buttons">
                <button id="edit-all-notes-btn">Editar Todas as Notas</button>
            </div>
        </main>
    </div>

    <div id="activities-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="activities-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="activities-home-btn" class="header-btn">üè†</button>
                    <button id="activities-favorites-btn" class="header-btn star-icon">‚òÖ</button>
                    <button id="reports-header-btn-activities" class="header-btn">üñ®Ô∏è</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                 <h2 id="activities-title">Atividades</h2>
            </div>
        </header>
        <main>
            <div class="main-buttons">
                <button id="toggle-vistos-panel-btn">Vistos</button>
                <button id="toggle-continuous-assessment-panel-btn">Avalia√ß√µes Cont√≠nuas</button>
            </div>

            <div id="vistos-panel" class="manager-panel hidden">
                <div class="main-buttons">
                    <button id="add-visto-btn" style="font-size: 1.5em; padding: 5px 12px;">+</button>
                    <button id="calculate-vistos-btn">Calcular</button>
                </div>
                <div id="visto-form-panel" class="manager-panel hidden">
                    <form id="visto-form" class="styled-form">
                        <div class="form-row">
                            <input type="date" id="visto-date" required>
                            <input type="text" id="visto-description" placeholder="Descri√ß√£o da atividade" required>
                        </div>
                        <div class="form-row">
                            <input type="hidden" id="visto-id">
                            <button type="submit">Salvar</button>
                            <button type="button" id="cancel-visto-edit-btn">Cancelar</button>
                        </div>
                    </form>
                </div>
                <div id="visto-calc-panel" class="manager-panel hidden">
                    <form id="visto-calc-form" class="styled-form">
                        <input type="number" id="visto-calc-total-value" placeholder="Valor Total (ex: 4,0)" step="0.1" required>
                        <button type="submit">OK</button>
                        <button type="button" id="cancel-visto-calc-btn">Cancelar</button>
                    </form>
                </div>
                <div class="table-container">
                    <table id="vistos-table" class="data-table">
                        <thead>
                            <tr id="vistos-table-header">
                                <th class="student-name-header">Aluno</th>
                            </tr>
                        </thead>
                        <tbody id="vistos-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="continuous-assessment-panel" class="manager-panel hidden">
                <div class="main-buttons">
                    <button id="add-continuous-assessment-btn" style="font-size: 1.5em; padding: 5px 12px;">+</button>
                    <button id="convert-continuous-assessment-btn">Converter Notas</button>
                    <button id="calculate-continuous-assessment-btn">Calcular</button>
                </div>
                <div id="continuous-assessment-form-panel" class="manager-panel hidden">
                    <form id="continuous-assessment-form" class="styled-form">
                        <input type="hidden" id="continuous-assessment-id">
                        <input type="date" id="continuous-assessment-date" required>
                        <button type="submit">Salvar</button>
                        <button type="button" id="cancel-continuous-assessment-edit-btn">Cancelar</button>
                    </form>
                </div>
                <div class="table-container">
                    <table id="continuous-assessment-table" class="data-table">
                        <thead>
                            <tr id="continuous-assessment-table-header">
                                <th class="student-name-header">Aluno</th>
                            </tr>
                        </thead>
                        <tbody id="continuous-assessment-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="main-buttons">
                    <button id="edit-all-continuous-assessments-btn">Editar Todas as Notas</button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="favorites-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="favorites-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="favorites-home-btn" class="header-btn">üè†</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2>Favoritos</h2>
            </div>
        </header>
        <main>
            <div class="main-buttons">
                <button id="add-favorite-btn">Adicionar Favorito</button>
            </div>
            <div id="favorite-form-panel" class="manager-panel hidden">
                <h4>Novo Atalho Favorito</h4>
                <form id="favorite-form" class="styled-form">
                    <input type="text" id="favorite-name-input" placeholder="Nome do Atalho" required>
                    <select id="favorite-institution-select" required>
                        <option value="">Selecione uma Institui√ß√£o</option>
                    </select>
                    <select id="favorite-year-select" required>
                        <option value="">Selecione um Ano Letivo</option>
                    </select>
                    <select id="favorite-period-select" required>
                        <option value="">Selecione um Per√≠odo</option>
                    </select>
                    <button type="submit">Salvar Favorito</button>
                </form>
            </div>
            <hr>
            <h3>Meus Atalhos</h3>
            <div id="favorite-list-container" class="list-container"></div>
        </main>
    </div>

    <div id="reports-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="reports-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="reports-home-btn" class="header-btn">üè†</button>
                    <button class="header-btn backup-btn">‚ÜïÔ∏è</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2>Relat√≥rios</h2>
            </div>
        </header>
        <main>
            <div class="manager-panel">
                <h4>Filtros do Relat√≥rio</h4>
                <form id="report-filters-form" class="styled-form">
                    <select id="report-institution-select" required>
                        <option value="">Selecione uma Institui√ß√£o</option>
                    </select>
                    <select id="report-year-select" required>
                        <option value="">Selecione um Ano Letivo</option>
                    </select>
                    <select id="report-class-select" required>
                        <option value="">Selecione uma Turma</option>
                    </select>
                    <select id="report-period-select" required>
                        <option value="">Selecione um Per√≠odo</option>
                    </select>
                    <select id="report-type-select" required>
                        <option value="">Selecione um Tipo de Relat√≥rio</option>
                    </select>
                    <button type="submit">Gerar Relat√≥rio</button>
                </form>
            </div>
            <div id="report-output-container">
                <!-- O relat√≥rio gerado aparecer√° aqui -->
            </div>
        </main>
    </div>

    <div id="backup-view" class="view hidden view-panel">
        <header class="global-header">
            <div class="header-top-row">
                <div class="header-button-group">
                    <button id="backup-back-btn" class="header-btn">‚¨ÖÔ∏è</button>
                    <button id="backup-home-btn" class="header-btn">üè†</button>
                </div>
            </div>
            <div class="header-bottom-row">
                <h2>Backup / Restaura√ß√£o</h2>
            </div>
        </header>
        <main>
            <div class="menu-buttons-container">
                <button id="export-backup-btn" class="menu-button">Exportar Backup</button>
                <button id="import-backup-btn" class="menu-button">Importar Backup</button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </div>
        </main>
    </div>

    <div id="custom-modal-overlay" class="modal-overlay hidden">
      <div id="custom-modal" class="custom-modal-content">
        <p id="custom-modal-message"></p>
        <div id="custom-modal-buttons">
          <button id="modal-confirm-btn">OK</button>
          <button id="modal-cancel-btn">Cancelar</button>
        </div>
      </div>
    </div>

    <div id="import-notes-modal-overlay" class="modal-overlay hidden">
      <div id="import-notes-modal" class="custom-modal-content">
        <h4>Importar Notas de Atividades</h4>
        <form id="import-notes-form" class="styled-form">
            <label for="import-notes-name">Nome da Nova Avalia√ß√£o:</label>
            <input type="text" id="import-notes-name" required>
            
            <div id="import-notes-value-container" class="hidden">
                 <label for="import-notes-value">Valor da Avalia√ß√£o:</label>
                 <input type="number" id="import-notes-value" step="0.1" required>
            </div>

            <label for="import-notes-source">Fonte dos Dados:</label>
            <select id="import-notes-source" required></select>
            
            <div class="main-buttons">
                <button type="submit">Importar</button>
                <button type="button" id="cancel-import-notes-btn">Cancelar</button>
            </div>
        </form>
      </div>
    </div>

    <div id="recovery-modal-overlay" class="modal-overlay hidden">
      <div id="recovery-modal" class="custom-modal-content">
        <h4>Selecione o Tipo de Recupera√ß√£o</h4>
        <form id="recovery-form" class="styled-form">
            <select id="recovery-type-select">
                <option value="">-- Selecione --</option>
                <option value="assessment">Recupera√ß√£o de Avalia√ß√£o</option>
                <option value="period">Recupera√ß√£o do Per√≠odo</option>
            </select>
            <div id="recovery-assessment-selection" class="hidden">
                <label for="recovery-assessment-select">Selecione a Avalia√ß√£o:</label>
                <select id="recovery-assessment-select"></select>
            </div>
            <div class="main-buttons">
                <button type="submit">Criar</button>
                <button type="button" id="cancel-recovery-btn">Cancelar</button>
            </div>
        </form>
      </div>
    </div>

    <div id="grade-conversion-modal-overlay" class="modal-overlay hidden">
      <div id="grade-conversion-modal" class="custom-modal-content">
        <h4>Converter Notas</h4>
        <form id="grade-conversion-form" class="styled-form">
            <label for="new-max-grade">Converter notas para o valor m√°ximo de:</label>
            <input type="number" id="new-max-grade" step="0.1" placeholder="Ex: 2.5" required>
            <div class="main-buttons">
                <button type="submit">Converter</button>
                <button type="button" id="cancel-grade-conversion-btn">Cancelar</button>
            </div>
        </form>
      </div>
    </div>
    <!-- FIM DO HTML -->
    
    <footer id="sync-footer">
        <div id="sync-status">Dados locais. Nenhum backup restaurado.</div>
    </footer>


    <!-- IN√çCIO DO JAVASCRIPT OTIMIZADO -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- FUN√á√ÉO AJUDANTE PARA CARREGAR E FILTRAR DADOS DO LOCALSTORAGE ---
        const loadAndFilter = (key) => (JSON.parse(localStorage.getItem(key)) || []).filter(Boolean);

        // --- BANCO DE DADOS (localStorage) ---
        let institutions = loadAndFilter('institutions_db');
        let anosLetivos = loadAndFilter('anos_letivos_db');
        let turmas = loadAndFilter('turmas_db');
        let alunos = loadAndFilter('alunos_db');
        let avaliacoes = loadAndFilter('avaliacoes_db');
        let vistos = loadAndFilter('vistos_db');
        let vistosResults = loadAndFilter('vistos_results_db');
        let continuousAssessments = loadAndFilter('continuous_assessments_db');
        let continuousAssessmentsResults = loadAndFilter('continuous_assessments_results_db');
        let notesResults = loadAndFilter('notes_results_db');
        let favorites = loadAndFilter('favorites_db');
        let annualRecoveryState = JSON.parse(localStorage.getItem('annual_recovery_state_db')) || {};

        // --- ESTADO DA APLICA√á√ÉO ---
        let selectedInstitutionId = null;
        let selectedYearId = null;
        let selectedClassId = null;
        let selectedPeriod = null;
        let viewHistory = [];

        // --- FUN√á√ïES DE SALVAMENTO ---
        const saveDb = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const saveAllDbs = () => {
            saveDb('institutions_db', institutions);
            saveDb('anos_letivos_db', anosLetivos);
            saveDb('turmas_db', turmas);
            saveDb('alunos_db', alunos);
            saveDb('avaliacoes_db', avaliacoes);
            saveDb('vistos_db', vistos);
            saveDb('vistos_results_db', vistosResults);
            saveDb('continuous_assessments_db', continuousAssessments);
            saveDb('continuous_assessments_results_db', continuousAssessmentsResults);
            saveDb('notes_results_db', notesResults);
            saveDb('favorites_db', favorites);
            saveDb('annual_recovery_state_db', annualRecoveryState);
        };
        
        // --- FUN√á√ÉO AJUDANTE PARA SELETORES ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- ELEMENTOS DO DOM ---
        const institutionButtonsContainer = $('#institution-buttons-container');
        const manageInstitutionsBtn = $('#manage-institutions-btn');
        const institutionManagerPanel = $('#institution-manager-panel');
        const institutionForm = $('#institution-form');
        const institutionListContainer = $('#institution-list');
        const cancelEditBtn = $('#cancel-edit-btn');
        const colorPicker = $('#institution-main-color');
        const colorText = $('#institution-main-color-text');
        const confirmYearBtn = $('#confirm-year-btn');
        const yearSelectDropdown = $('#year-select');
        const manageYearsBtn = $('#manage-years-btn');
        const yearManagerPanel = $('#year-manager-panel');
        const yearForm = $('#year-form');
        const yearListContainer = $('#year-list');
        const gotoClassRegistrationBtn = $('#goto-class-registration-btn');
        const classForm = $('#class-form');
        const classListContainer = $('#class-list-container');
        const gotoStudentRegistrationBtn = $('#goto-student-registration-btn');
        const gotoPeriodSelectionBtn = $('#goto-period-selection-btn');
        const classSelectionForStudents = $('#class-selection-for-students');
        const studentEntryContainer = $('#student-entry-container');
        const addStudentsBtn = $('#add-students-btn');
        const studentListContainer = $('#student-list-container');
        const editStudentListBtn = $('#edit-student-list-btn');
        const studentListEditPanel = $('#student-list-edit-panel');
        const cancelStudentListEditBtn = $('#cancel-student-list-edit-btn');
        const saveStudentListBtn = $('#save-student-list-btn');
        const importStudentsBtn = $('#import-students-btn');
        const studentImportPanel = $('#student-import-panel');
        const importFromClassSelect = $('#import-from-class-select');
        const confirmImportBtn = $('#confirm-import-btn');
        const cancelImportBtn = $('#cancel-import-btn');
        const inactivateStudentsBtn = $('#inactivate-students-btn');
        const inactivateStudentListPanel = $('#inactivate-student-list-panel');
        const inactivateListContainer = $('#inactivate-list-container');
        const saveInactivateListBtn = $('#save-inactivate-list-btn');
        const cancelInactivateListBtn = $('#cancel-inactivate-list-btn');
        const periodSelect = $('#period-select');
        const periodClassSelectionContainer = $('#period-class-selection-container');
        const periodClassSelect = $('#period-class-select');
        const periodActionsContainer = $('#period-actions-container');
        const notesView = $('#notes-view');
        const calculateFinalGradesBtn = $('#calculate-final-grades-btn');
        const addAnnualRecoveryBtn = $('#add-annual-recovery-btn');
        const addAssessmentBtn = $('#add-assessment-btn');
        const importNotesBtn = $('#import-notes-btn');
        const assessmentPanel = $('#assessment-panel');
        const assessmentForm = $('#assessment-form');
        const cancelAssessmentEditBtn = $('#cancel-assessment-edit-btn');
        const notesTableBody = $('#notes-table-body');
        const notesTableHeader = $('#notes-table-header');
        const editAllNotesContainer = $('#edit-all-notes-container');
        const editAllNotesBtn = $('#edit-all-notes-btn');
        const calculateNotesBtn = $('#calculate-notes-btn');
        const recoveryBtn = $('#recovery-btn');
        const activitiesView = $('#activities-view');
        const toggleVistosPanelBtn = $('#toggle-vistos-panel-btn');
        const vistosPanel = $('#vistos-panel');
        const addVistoBtn = $('#add-visto-btn');
        const vistoFormPanel = $('#visto-form-panel');
        const vistoForm = $('#visto-form');
        const cancelVistoEditBtn = $('#cancel-visto-edit-btn');
        const vistosTableHeader = $('#vistos-table-header');
        const vistosTableBody = $('#vistos-table-body');
        const calculateVistosBtn = $('#calculate-vistos-btn');
        const vistoCalcPanel = $('#visto-calc-panel');
        const vistoCalcForm = $('#visto-calc-form');
        const cancelVistoCalcBtn = $('#cancel-visto-calc-btn');
        const toggleContinuousAssessmentPanelBtn = $('#toggle-continuous-assessment-panel-btn');
        const continuousAssessmentPanel = $('#continuous-assessment-panel');
        const addContinuousAssessmentBtn = $('#add-continuous-assessment-btn');
        const continuousAssessmentFormPanel = $('#continuous-assessment-form-panel');
        const continuousAssessmentForm = $('#continuous-assessment-form');
        const cancelContinuousAssessmentEditBtn = $('#cancel-continuous-assessment-edit-btn');
        const continuousAssessmentTableHeader = $('#continuous-assessment-table-header');
        const continuousAssessmentTableBody = $('#continuous-assessment-table-body');
        const calculateContinuousAssessmentBtn = $('#calculate-continuous-assessment-btn');
        const editAllContinuousAssessmentsBtn = $('#edit-all-continuous-assessments-btn');
        const convertContinuousAssessmentBtn = $('#convert-continuous-assessment-btn');
        const importNotesModalOverlay = $('#import-notes-modal-overlay');
        const importNotesForm = $('#import-notes-form');
        const cancelImportNotesBtn = $('#cancel-import-notes-btn');
        const importNotesSourceSelect = $('#import-notes-source');
        const importNotesValueContainer = $('#import-notes-value-container');
        const recoveryModalOverlay = $('#recovery-modal-overlay');
        const recoveryForm = $('#recovery-form');
        const recoveryTypeSelect = $('#recovery-type-select');
        const recoveryAssessmentSelection = $('#recovery-assessment-selection');
        const recoveryAssessmentSelect = $('#recovery-assessment-select');
        const cancelRecoveryBtn = $('#cancel-recovery-btn');
        const gradeConversionModalOverlay = $('#grade-conversion-modal-overlay');
        const gradeConversionForm = $('#grade-conversion-form');
        const cancelGradeConversionBtn = $('#cancel-grade-conversion-btn');
        const addFavoriteBtn = $('#add-favorite-btn');
        const favoriteFormPanel = $('#favorite-form-panel');
        const favoriteForm = $('#favorite-form');
        const favoriteInstitutionSelect = $('#favorite-institution-select');
        const favoriteYearSelect = $('#favorite-year-select');
        const favoritePeriodSelect = $('#favorite-period-select');
        const favoriteListContainer = $('#favorite-list-container');
        const reportFiltersForm = $('#report-filters-form');
        const reportInstitutionSelect = $('#report-institution-select');
        const reportYearSelect = $('#report-year-select');
        const reportClassSelect = $('#report-class-select');
        const reportPeriodSelect = $('#report-period-select');
        const reportTypeSelect = $('#report-type-select');
        const reportOutputContainer = $('#report-output-container');
        const exportBackupBtn = $('#export-backup-btn');
        const importBackupBtn = $('#import-backup-btn');
        const importFileInput = $('#import-file-input');
        const modalOverlay = $('#custom-modal-overlay');
        const modalMessage = $('#custom-modal-message');
        const modalConfirmBtn = $('#modal-confirm-btn');
        const modalCancelBtn = $('#modal-cancel-btn');

        // --- MODAL CUSTOMIZADO ---
        let resolvePromise;
        function showModal(message, isConfirm = false) {
            return new Promise((resolve) => {
                resolvePromise = resolve;
                modalMessage.textContent = message;
                modalCancelBtn.style.display = isConfirm ? 'inline-block' : 'none';
                modalConfirmBtn.textContent = isConfirm ? 'Confirmar' : 'OK';
                modalOverlay.classList.remove('hidden');
            });
        }
        function hideModal(result) {
            modalOverlay.classList.add('hidden');
            if (resolvePromise) resolvePromise(result);
        }
        modalConfirmBtn.addEventListener('click', () => hideModal(true));
        modalCancelBtn.addEventListener('click', () => hideModal(false));

        // --- FUN√á√ïES DE NAVEGA√á√ÉO ---
        function navigateTo(viewId, context = null, isNavigatingBack = false) {
            const currentView = $('.view:not(.hidden)');
            if (currentView && !isNavigatingBack) {
                viewHistory.push(currentView.id);
            }
            $$('.view').forEach(v => v.classList.add('hidden'));
            const targetView = $(`#${viewId}`);
            if (targetView) targetView.classList.remove('hidden');

            // FIX: Pass a safe object to getCurrentContext to avoid null reference error
            const { institution, anoLetivo, turma } = getCurrentContext(context || {});

            if (viewId === 'dashboard-view') {
                viewHistory = [];
                renderInstitutionButtons();
            } else if (viewId === 'year-selection-view' && context) {
                selectedInstitutionId = context.institutionId;
                if (institution) $('#year-selection-title').textContent = institution.name;
                renderAnosLetivos();
            } else if (['main-menu-view', 'class-registration-view', 'student-registration-view', 'period-selection-view', 'notes-view', 'activities-view'].includes(viewId)) {
                if (institution && anoLetivo) {
                    let title = `${institution.name} - ${anoLetivo.year}`;
                    if (turma) title += ` - ${turma.name} - ${selectedPeriod} - ${turma.subject}`;
                    
                    const titleMap = {
                        'main-menu-view': '#main-menu-title',
                        'class-registration-view': '#class-reg-title',
                        'student-registration-view': '#student-reg-title',
                        'period-selection-view': '#period-sel-title',
                        'notes-view': '#notes-title',
                        'activities-view': '#activities-title'
                    };
                    if (titleMap[viewId]) $(titleMap[viewId]).textContent = title;
                }
                
                // Chamadas de renderiza√ß√£o espec√≠ficas da view
                if (viewId === 'class-registration-view') renderTurmas();
                if (viewId === 'student-registration-view') renderClassSelectionForStudents();
                if (viewId === 'period-selection-view') {
                    renderPeriodSelection();
                    if ((isNavigatingBack && selectedPeriod) || (context && context.fromFavorite)) {
                        periodSelect.value = selectedPeriod;
                        periodSelect.dispatchEvent(new Event('change'));
                        if (selectedClassId) {
                            periodClassSelect.value = selectedClassId;
                            periodClassSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
                if (viewId === 'notes-view') {
                    const isFinalGrades = selectedPeriod === 'M√©dias Finais';
                    addAssessmentBtn.style.display = isFinalGrades ? 'none' : 'inline-block';
                    importNotesBtn.style.display = isFinalGrades ? 'none' : 'inline-block';
                    recoveryBtn.style.display = isFinalGrades ? 'none' : 'inline-block';
                    calculateNotesBtn.style.display = isFinalGrades ? 'none' : 'inline-block';
                    calculateFinalGradesBtn.style.display = isFinalGrades ? 'inline-block' : 'none';
                    addAnnualRecoveryBtn.style.display = isFinalGrades ? 'inline-block' : 'none';
                    editAllNotesContainer.style.display = isFinalGrades ? 'none' : 'flex';

                    if (isFinalGrades) {
                        if (!annualRecoveryState[selectedClassId]) {
                            annualRecoveryState[selectedClassId] = { added: false, editing: false, grades: [] };
                        }
                        addAnnualRecoveryBtn.disabled = annualRecoveryState[selectedClassId].added;
                        renderFinalGradesView();
                    } else {
                        renderNotesView();
                    }
                }
                if (viewId === 'activities-view') {
                    vistosPanel.classList.add('hidden');
                    continuousAssessmentPanel.classList.add('hidden');
                }
            } else if (viewId === 'favorites-view') renderFavorites();
            else if (viewId === 'reports-view') renderReportFilters();
        }
        const navigateBack = () => { if (viewHistory.length > 0) navigateTo(viewHistory.pop(), null, true); };

        function getCurrentContext(context = {}) {
            if (context.institutionId) selectedInstitutionId = context.institutionId;
            const institution = institutions.find(i => i.id === selectedInstitutionId);
            const anoLetivo = anosLetivos.find(a => a.id === selectedYearId);
            const turma = turmas.find(t => t.id === selectedClassId);
            return { institution, anoLetivo, turma };
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
        function createListItem(container, { id, name, inactive = false, contentPrefix = '', actionsHTML = '' }) {
            const item = document.createElement('div');
            item.className = 'list-item';
            if (inactive) item.classList.add('inactive');
            item.dataset.id = id;
            item.innerHTML = `${contentPrefix}<span class="item-name">${name}</span><div class="item-actions">${actionsHTML}</div>`;
            container.appendChild(item);
        }

        function renderInstitutionButtons() {
            institutionButtonsContainer.innerHTML = '';
            const sortedInstitutions = [...institutions].sort((a, b) => a.name.localeCompare(b.name));
            if (sortedInstitutions.length === 0) { 
                institutionButtonsContainer.innerHTML = '<p>Nenhuma institui√ß√£o cadastrada.</p>';
                return;
            }
            sortedInstitutions.forEach(inst => {
                const button = document.createElement('button');
                button.className = 'institution-btn';
                button.textContent = inst.name;
                button.dataset.id = inst.id;
                button.style.cssText = `border-color: ${inst.mainColor}; border-width: 2px;`;
                institutionButtonsContainer.appendChild(button);
            });
        }

        function renderInstitutionsInManager() {
            institutionListContainer.innerHTML = '';
            const sortedInstitutions = [...institutions].sort((a, b) => a.name.localeCompare(b.name));
            if (sortedInstitutions.length === 0) { institutionListContainer.innerHTML = '<p>Nenhuma institui√ß√£o cadastrada.</p>'; return; }
            sortedInstitutions.forEach(inst => {
                createListItem(institutionListContainer, {
                    id: inst.id,
                    name: inst.name,
                    contentPrefix: `<span class="color-swatch" style="background-color: ${inst.mainColor};"></span>`,
                    actionsHTML: `<button class="edit-btn">Editar</button><button class="remove-btn">Remover</button>`
                });
            });
        }

        function renderAnosLetivos() {
            const anosDaInstituicao = anosLetivos.filter(ano => ano.institutionId === selectedInstitutionId).sort((a, b) => b.year - a.year);
            yearListContainer.innerHTML = ''; yearSelectDropdown.innerHTML = '';
            if (anosDaInstituicao.length === 0) {
                yearListContainer.innerHTML = '<p>Nenhum ano cadastrado.</p>';
                yearSelectDropdown.innerHTML = '<option disabled selected>Cadastre um ano letivo</option>';
                return;
            }
            anosDaInstituicao.forEach(ano => {
                createListItem(yearListContainer, {
                    id: ano.id,
                    name: ano.year,
                    actionsHTML: `<button class="remove-year-btn">Remover</button>`
                });
                const optionItem = document.createElement('option');
                optionItem.value = ano.id;
                optionItem.textContent = ano.year;
                yearSelectDropdown.appendChild(optionItem);
            });
        }

        function renderTurmas() {
            classListContainer.innerHTML = '';
            const turmasDoAno = turmas.filter(t => t.yearId === selectedYearId).sort((a, b) => `${a.name} - ${a.subject}`.localeCompare(`${b.name} - ${b.subject}`));
            if(turmasDoAno.length === 0) { classListContainer.innerHTML = '<p>Nenhuma turma cadastrada para este ano letivo.</p>'; return; }
            turmasDoAno.forEach(turma => {
                createListItem(classListContainer, {
                    id: turma.id,
                    name: `${turma.name} - ${turma.subject}`,
                    actionsHTML: `<button class="edit-class-btn" data-id="${turma.id}">Editar</button><button class="remove-class-btn" data-id="${turma.id}">Remover</button>`
                });
            });
        }

        function renderClassSelection(selectElement, yearId, excludeClassId = null) {
            selectElement.innerHTML = '<option value="">-- Selecione uma Turma --</option>';
            let turmasDoAno = turmas.filter(t => t.yearId === yearId && t.id !== excludeClassId);
            turmasDoAno.sort((a,b) => `${a.name} - ${a.subject}`.localeCompare(`${b.name} - ${b.subject}`));
            turmasDoAno.forEach(turma => {
                const option = document.createElement('option');
                option.value = turma.id;
                option.textContent = `${turma.name} - ${turma.subject}`;
                selectElement.appendChild(option);
            });
            return turmasDoAno.length > 0;
        }

        function renderClassSelectionForStudents() {
            renderClassSelection(classSelectionForStudents, selectedYearId);
            studentEntryContainer.classList.add('hidden');
            studentListEditPanel.classList.add('hidden');
            studentImportPanel.classList.add('hidden');
            inactivateStudentListPanel.classList.add('hidden');
        }

        function renderAlunos() {
            studentListContainer.innerHTML = '';
            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            if (alunosDaTurma.length === 0) { studentListContainer.innerHTML = '<p>Nenhum aluno cadastrado nesta turma.</p>'; return; }
            alunosDaTurma.forEach(aluno => {
                createListItem(studentListContainer, {
                    id: aluno.id,
                    name: `${aluno.number}. ${aluno.name}`,
                    inactive: aluno.active === false
                });
            });
        }

        function renderPeriodSelection() {
            periodSelect.innerHTML = '<option value="">-- Selecione --</option>';
            periodClassSelectionContainer.classList.add('hidden');
            periodActionsContainer.classList.add('hidden');
            periodActionsContainer.innerHTML = '';
            
            const institution = institutions.find(i => i.id === selectedInstitutionId);
            if (!institution) return;

            const periodMap = {
                'Bimestral': ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre', 'M√©dias Finais'],
                'Trimestral': ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre', 'M√©dias Finais'],
                'Semestral': ['1¬∫ Semestre', '2¬∫ Semestre', 'M√©dias Finais']
            };
            const periodOptions = periodMap[institution.periodType] || [];

            periodOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                periodSelect.appendChild(option);
            });
        }

        function roundToOneDecimal(num) {
            return Math.round(num * 10) / 10;
        }

        function renderNotesView(editingColumnId = null, isEditingAll = false) {
            notesTableHeader.innerHTML = '<th class="student-name-header">Aluno</th>';
            notesTableBody.innerHTML = '';
            assessmentPanel.classList.add('hidden');
            assessmentForm.reset();
            $('#assessment-id').value = '';

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            const avaliacoesDaTurma = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod && !av.isRecovery);
            const recuperacoes = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod && av.isRecovery);
            const institution = institutions.find(i => i.id === selectedInstitutionId);

            const resultId = `notes-${selectedClassId}-${selectedPeriod}`;
            const currentResult = notesResults.find(r => r.id === resultId);

            if (currentResult) {
                notesTableHeader.insertAdjacentHTML('beforeend', `<th class="result-header col-header">Total</th><th class="col-header situation-col">Situa√ß√£o</th>`);
            }

            const periodRecovery = recuperacoes.find(r => r.recoveryType === 'period');
            if (periodRecovery) {
                let recName = 'Recupera√ß√£o';
                if (institution) {
                    recName = `Rec. ${institution.periodType.replace('estral', '.')}`;
                }
                const isEditingRec = (editingColumnId === periodRecovery.id) || isEditingAll;
                notesTableHeader.insertAdjacentHTML('beforeend', `
                    <th class="col-header" data-assessment-id="${periodRecovery.id}">
                        <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-assessment-id="${periodRecovery.id}"> ${recName}</div>
                        <div class="col-header-actions">
                            <button class="${isEditingRec ? 'save-col-btn' : 'edit-col-btn'}" data-id="${periodRecovery.id}">${isEditingRec ? 'üíæ' : 'üìù'}</button>
                            <button class="remove-assessment-btn" data-id="${periodRecovery.id}">üóëÔ∏è</button>
                        </div>
                    </th>`);
            }

            avaliacoesDaTurma.forEach(av => {
                const isEditingThisColumn = (editingColumnId === av.id) || isEditingAll;
                notesTableHeader.insertAdjacentHTML('beforeend', `
                    <th class="assessment-header col-header" data-assessment-id="${av.id}">
                        <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-assessment-id="${av.id}"> ${av.name}</div>
                        <div>(Valor: ${av.value.toFixed(1).replace('.', ',')})</div>
                        <div class="col-header-actions">
                            <button class="edit-assessment-name-btn" data-id="${av.id}">‚úèÔ∏è</button>
                            <button class="${isEditingThisColumn ? 'save-col-btn' : 'edit-col-btn'}" data-id="${av.id}">${isEditingThisColumn ? 'üíæ' : ' '}</button>
                            <button class="remove-assessment-btn" data-id="${av.id}">üóëÔ∏è</button>
                        </div>
                    </th>`);

                const recoveryForThis = recuperacoes.find(r => r.originalAssessmentId === av.id);
                if (recoveryForThis) {
                    const isEditingRec = (editingColumnId === recoveryForThis.id) || isEditingAll;
                    notesTableHeader.insertAdjacentHTML('beforeend', `
                        <th class="assessment-header col-header" data-assessment-id="${recoveryForThis.id}">
                            <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-assessment-id="${recoveryForThis.id}"> Rec. ${av.name}</div>
                            <div>(Valor: ${recoveryForThis.value.toFixed(1).replace('.',',')})</div>
                            <div class="col-header-actions">
                                <button class="${isEditingRec ? 'save-col-btn' : 'edit-col-btn'}" data-id="${recoveryForThis.id}">${isEditingRec ? 'üíæ' : 'üìù'}</button>
                                <button class="remove-assessment-btn" data-id="${recoveryForThis.id}">üóëÔ∏è</button>
                            </div>
                        </th>`);
                }
            });

            alunosDaTurma.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.dataset.studentId = aluno.id;
                if (aluno.active === false) tr.classList.add('inactive-student-row');
                
                let rowHTML = `<td class="student-name-cell"><input type="checkbox" class="table-filter-checkbox" data-filter-type="row" data-student-id="${aluno.id}"> ${aluno.number}. ${aluno.name}</td>`;

                if (currentResult) {
                    const studentScoreObj = currentResult.scores.find(s => s.studentId === aluno.id);
                    let finalScore = studentScoreObj ? studentScoreObj.score : null;
                    const recoveryGradeObj = periodRecovery ? periodRecovery.grades.find(g => g.studentId === aluno.id) : null;

                    if (finalScore !== null && recoveryGradeObj && recoveryGradeObj.grade !== null) {
                        finalScore = Math.max(finalScore, recoveryGradeObj.grade);
                    }
                    const scoreText = finalScore !== null ? finalScore.toFixed(1).replace('.', ',') : '-';
                    rowHTML += `<td class="data-cell result-cell">${scoreText}</td>`;

                    let situationText = '-';
                    if (recoveryGradeObj && recoveryGradeObj.grade !== null) {
                        if (recoveryGradeObj.grade >= 7.0) {
                            situationText = `<span style="color: green; font-weight: bold;">Recuperou</span>`;
                        } else {
                            situationText = `<span style="color: red; font-weight: bold;">N√£o Recuperou</span>`;
                        }
                    } else if (finalScore !== null && institution) {
                        const isApproved = finalScore >= institution.passingGrade;
                        situationText = `<span style="color: ${isApproved ? 'blue' : 'orange'}; font-weight: bold;">${isApproved ? 'Aprovado' : 'Em Recupera√ß√£o'}</span>`;
                    }
                    rowHTML += `<td class="data-cell situation-cell">${situationText}</td>`;
                }
                
                const allAssessmentsForStudent = [periodRecovery, ...avaliacoesDaTurma, ...recuperacoes.filter(r => r.recoveryType === 'assessment')].filter(Boolean);
                allAssessmentsForStudent.forEach(av => {
                    const isEditing = (editingColumnId === av.id) || isEditingAll;
                    const gradeObj = av.grades.find(g => g.studentId === aluno.id);
                    const grade = gradeObj ? gradeObj.grade : null;
                    const text = (grade !== null) ? grade.toFixed(1).replace('.', ',') : '-';
                    const value = (grade !== null) ? grade : '';
                    rowHTML += `<td class="data-cell grade-cell ${isEditing ? 'editing' : ''}" data-assessment-id="${av.id}">
                        <span class="grade-text">${text}</span>
                        <input type="number" class="grade-input" data-student-id="${aluno.id}" data-assessment-id="${av.id}" value="${value}" step="0.1" max="${av.value}" min="0">
                    </td>`;
                });

                tr.innerHTML = rowHTML;
                notesTableBody.appendChild(tr);
            });

            editAllNotesBtn.textContent = isEditingAll ? 'Salvar Todas as Notas' : 'Editar Todas as Notas';
            editAllNotesBtn.dataset.editing = isEditingAll;
        }

        function renderFinalGradesView(calculate = false) {
            const state = annualRecoveryState[selectedClassId] || { added: false, editing: false, grades: [] };
            notesTableHeader.innerHTML = '';
            notesTableBody.innerHTML = '';

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId && a.active !== false).sort((a, b) => a.number - b.number);
            const institution = institutions.find(i => i.id === selectedInstitutionId);
            if (!institution) return;

            const periodMap = {
                'Bimestral': { names: ['1¬∫B', '2¬∫B', '3¬∫B', '4¬∫B'], periods: ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre'], divisor: 4 },
                'Trimestral': { names: ['1¬∫T', '2¬∫T', '3¬∫T'], periods: ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre'], divisor: 3 },
                'Semestral': { names: ['1¬∫S', '2¬∫S'], periods: ['1¬∫ Semestre', '2¬∫ Semestre'], divisor: 2 }
            };
            const { names, periods, divisor } = periodMap[institution.periodType];

            let headerHTML = `<th class="student-name-header">Aluno</th>${names.map(n => `<th class="col-header">${n}</th>`).join('')}`;
            if (state.added) {
                headerHTML += `<th class="col-header">
                    <div>Rec. Anual</div>
                    <div class="col-header-actions">
                        <button id="${state.editing ? 'save-annual-recovery-btn' : 'edit-annual-recovery-btn'}">${state.editing ? 'üíæ' : 'üìù'}</button>
                        <button id="delete-annual-recovery-btn">üóëÔ∏è</button>
                    </div>
                </th>`;
            }
            headerHTML += '<th class="result-header col-header">M√©dia Final</th><th class="col-header situation-col">Situa√ß√£o</th>';
            notesTableHeader.innerHTML = headerHTML;

            alunosDaTurma.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.dataset.studentId = aluno.id;
                let rowHTML = `<td class="student-name-cell">${aluno.number}. ${aluno.name}</td>`;
                
                let totalScore = 0;
                let periodCount = 0;

                periods.forEach(period => {
                    const result = notesResults.find(r => r.id === `notes-${selectedClassId}-${period}`);
                    let score = result ? (result.scores.find(s => s.studentId === aluno.id) || {}).score : null;
                    if (score !== null && score !== undefined) {
                        const periodRecovery = avaliacoes.find(av => av.classId === selectedClassId && av.period === period && av.recoveryType === 'period');
                        if (periodRecovery) {
                            const recoveryGradeObj = periodRecovery.grades.find(g => g.studentId === aluno.id);
                            if (recoveryGradeObj) score = Math.max(score, recoveryGradeObj.grade);
                        }
                        totalScore += score;
                        periodCount++;
                    }
                    rowHTML += `<td class="data-cell">${(score !== null && score !== undefined) ? score.toFixed(1).replace('.', ',') : '-'}</td>`;
                });

                if (state.added) {
                    const savedGradeObj = state.grades.find(g => g.studentId === aluno.id);
                    const grade = savedGradeObj ? savedGradeObj.grade : null;
                    rowHTML += `<td class="data-cell grade-cell ${state.editing ? 'editing' : ''}">
                        <span class="grade-text">${(grade !== null) ? grade.toFixed(1).replace('.',',') : '-'}</span>
                        <input type="number" class="grade-input annual-recovery-input" data-student-id="${aluno.id}" value="${grade || ''}" step="0.1" max="10" min="0">
                    </td>`;
                }

                if (calculate) {
                    let finalAverage = totalScore / divisor;
                    if (state.added) {
                        const recoveryGradeObj = state.grades.find(g => g.studentId === aluno.id);
                        if (recoveryGradeObj && recoveryGradeObj.grade > finalAverage) finalAverage = recoveryGradeObj.grade;
                    }
                    const roundedAverage = roundToOneDecimal(finalAverage);
                    const isApproved = roundedAverage >= institution.passingGrade;
                    const situationText = periodCount < divisor ? 'Cursando' : (isApproved ? 'Aprovado' : 'Reprovado');
                    const situationColor = periodCount < divisor ? 'green' : (isApproved ? 'blue' : 'red');

                    rowHTML += `<td class="data-cell result-cell" style="font-weight: bold;">${roundedAverage.toFixed(1).replace('.', ',')}</td>`;
                    rowHTML += `<td class="data-cell situation-cell" style="color: ${situationColor}; font-weight: bold;">${situationText}</td>`;
                } else {
                    rowHTML += `<td class="data-cell">-</td><td class="data-cell">-</td>`;
                }
                tr.innerHTML = rowHTML;
                notesTableBody.appendChild(tr);
            });
        }

        function renderVistosView() {
            vistosTableHeader.innerHTML = '<th class="student-name-header">Aluno</th>';
            vistoFormPanel.classList.add('hidden');
            vistoForm.reset();
            $('#visto-id').value = '';
            vistoCalcPanel.classList.add('hidden');
            vistoCalcForm.reset();

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            const vistosDaTurma = vistos.filter(v => v.classId === selectedClassId && v.period === selectedPeriod);
            const result = vistosResults.find(r => r.id === `${selectedClassId}-${selectedPeriod}`);

            if (result) {
                vistosTableHeader.insertAdjacentHTML('beforeend', `<th class="visto-result-header result-header col-header">Total (Valor: ${result.totalValue.toFixed(1).replace('.',',')})</th>`);
            }

            vistosDaTurma.forEach(visto => {
                vistosTableHeader.insertAdjacentHTML('beforeend', `
                    <th class="visto-header col-header" data-visto-id="${visto.id}">
                        <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-visto-id="${visto.id}"> ${new Date(visto.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</div>
                        <div class="visto-header-actions col-header-actions">
                            <button class="edit-visto-btn" data-id="${visto.id}">‚úèÔ∏è</button>
                            <button class="info-visto-btn" data-id="${visto.id}">‚ÑπÔ∏è</button>
                            <button class="remove-visto-btn" data-id="${visto.id}">üóëÔ∏è</button>
                        </div>
                    </th>`);
            });

            const vistoOptions = ["-", "C", "I", "AT", "F", "NFT", "NTM"];
            vistosTableBody.innerHTML = '';

            alunosDaTurma.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.dataset.studentId = aluno.id;
                if (aluno.active === false) tr.classList.add('inactive-student-row');
                
                let rowHTML = `<td class="student-name-cell"><input type="checkbox" class="table-filter-checkbox" data-filter-type="row" data-student-id="${aluno.id}"> ${aluno.number}. ${aluno.name}</td>`;
                if (result) {
                    const score = (result.scores.find(s => s.studentId === aluno.id) || {}).score;
                    rowHTML += `<td class="visto-cell data-cell result-cell">${(score !== undefined) ? score.toFixed(1).replace('.', ',') : '-'}</td>`;
                }
                
                vistosDaTurma.forEach(visto => {
                    const record = (visto.records.find(r => r.studentId === aluno.id) || {}).value || "-";
                    rowHTML += `<td class="visto-cell data-cell" data-visto-id="${visto.id}"><select class="visto-select" data-student-id="${aluno.id}" data-visto-id="${visto.id}">
                        ${vistoOptions.map(opt => `<option value="${opt}" ${opt === record ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select></td>`;
                });
                tr.innerHTML = rowHTML;
                vistosTableBody.appendChild(tr);
            });
        }

        function renderContinuousAssessmentsView(editingColumnId = null, isEditingAll = false) {
            continuousAssessmentTableHeader.innerHTML = '<th class="student-name-header">Aluno</th>';
            continuousAssessmentTableBody.innerHTML = '';
            continuousAssessmentFormPanel.classList.add('hidden');
            continuousAssessmentForm.reset();
            $('#continuous-assessment-id').value = '';

            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number);
            const assessments = continuousAssessments.filter(v => v.classId === selectedClassId && v.period === selectedPeriod);
            const result = continuousAssessmentsResults.find(r => r.id === `ca-${selectedClassId}-${selectedPeriod}`);

            if (result) {
                continuousAssessmentTableHeader.insertAdjacentHTML('beforeend', `<th class="result-header col-header">Total</th>`);
            }

            assessments.forEach(assessment => {
                const isEditing = (editingColumnId === assessment.id) || isEditingAll;
                continuousAssessmentTableHeader.insertAdjacentHTML('beforeend', `
                    <th class="col-header" data-assessment-id="${assessment.id}">
                        <div><input type="checkbox" class="table-filter-checkbox" data-filter-type="col" data-assessment-id="${assessment.id}"> ${new Date(assessment.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</div>
                        <div class="col-header-actions">
                            <button class="edit-continuous-assessment-btn" data-id="${assessment.id}">‚úèÔ∏è</button>
                            <button class="${isEditing ? 'save-col-btn' : 'edit-col-btn'}" data-id="${assessment.id}">${isEditing ? 'üíæ' : 'üìù'}</button>
                            <button class="remove-continuous-assessment-btn" data-id="${assessment.id}">üóëÔ∏è</button>
                        </div>
                    </th>`);
            });

            continuousAssessmentTableBody.innerHTML = '';
            alunosDaTurma.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.dataset.studentId = aluno.id;
                if (aluno.active === false) tr.classList.add('inactive-student-row');
                
                let rowHTML = `<td class="student-name-cell"><input type="checkbox" class="table-filter-checkbox" data-filter-type="row" data-student-id="${aluno.id}"> ${aluno.number}. ${aluno.name}</td>`;
                if (result) {
                    const score = (result.scores.find(s => s.studentId === aluno.id) || {}).score;
                    rowHTML += `<td class="data-cell result-cell">${(score !== undefined) ? score.toFixed(1).replace('.', ',') : '-'}</td>`;
                }
                
                assessments.forEach(assessment => {
                    const isEditing = (editingColumnId === assessment.id) || isEditingAll;
                    const gradeObj = assessment.grades.find(g => g.studentId === aluno.id);
                    const grade = (gradeObj !== undefined) ? gradeObj.grade : null;
                    rowHTML += `<td class="data-cell grade-cell ${isEditing ? 'editing' : ''}" data-assessment-id="${assessment.id}">
                        <span class="grade-text">${(grade !== null) ? grade.toFixed(1).replace('.', ',') : '-'}</span>
                        <input type="number" class="grade-input" data-student-id="${aluno.id}" data-assessment-id="${assessment.id}" value="${grade || ''}" step="0.1" min="0" max="${assessment.maxValue || 10.0}">
                    </td>`;
                });
                tr.innerHTML = rowHTML;
                continuousAssessmentTableBody.appendChild(tr);
            });

            editAllContinuousAssessmentsBtn.textContent = isEditingAll ? 'Salvar Todas as Notas' : 'Editar Todas as Notas';
            editAllContinuousAssessmentsBtn.dataset.editing = isEditingAll;
        }
        
        function renderFavorites() {
            favoriteListContainer.innerHTML = '';
            if (favorites.length === 0) { favoriteListContainer.innerHTML = '<p>Nenhum favorito adicionado.</p>'; return; }
            favorites.forEach(fav => {
                createListItem(favoriteListContainer, {
                    id: fav.id,
                    name: fav.name,
                    actionsHTML: `<button class="go-favorite-btn" data-id="${fav.id}">üöÄ</button><button class="remove-favorite-btn" data-id="${fav.id}">üóëÔ∏è</button>`
                });
            });
        }

        function renderReportFilters() {
            const populateSelect = (select, data, nameProp) => {
                select.innerHTML = `<option value="">Selecione um${select === reportInstitutionSelect ? 'a Institui√ß√£o' : (select === reportClassSelect ? 'a Turma' : '')}</option>`;
                data.sort((a,b) => a[nameProp].localeCompare(b[nameProp])).forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item[nameProp];
                    select.appendChild(option);
                });
            };
            populateSelect(reportInstitutionSelect, institutions, 'name');
            reportYearSelect.innerHTML = '<option value="">Selecione um Ano Letivo</option>';
            reportClassSelect.innerHTML = '<option value="">Selecione uma Turma</option>';
            reportPeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
            reportTypeSelect.innerHTML = '<option value="">Selecione um Tipo de Relat√≥rio</option>';
            reportOutputContainer.innerHTML = '';
        }

        // --- FUN√á√ÉO DE FILTRO DA TABELA ---
        function handleTableFilter(checkbox) {
            const table = checkbox.closest('.data-table');
            table.querySelectorAll('.table-filter-checkbox').forEach(cb => { if (cb !== checkbox) cb.checked = false; });

            const allRows = table.querySelectorAll('tbody tr');
            const allHeaders = table.querySelectorAll('thead th');
            const allCells = table.querySelectorAll('tbody td');

            allRows.forEach(row => row.classList.remove('filter-hidden'));
            allHeaders.forEach(th => th.classList.remove('filter-hidden'));
            allCells.forEach(td => td.classList.remove('filter-hidden'));

            if (!checkbox.checked) return;

            const filterType = checkbox.dataset.filterType;
            if (filterType === 'row') {
                const studentId = checkbox.dataset.studentId;
                allRows.forEach(row => { if (row.dataset.studentId !== studentId) row.classList.add('filter-hidden'); });
            } else if (filterType === 'col') {
                const id = checkbox.dataset.assessmentId || checkbox.dataset.vistoId;
                allHeaders.forEach((th) => {
                    if (th.cellIndex > 0 && th.dataset.assessmentId !== id && th.dataset.vistoId !== id && !th.classList.contains('result-header') && !th.classList.contains('situation-col')) {
                        th.classList.add('filter-hidden');
                    }
                });
                allCells.forEach((td) => {
                    if (td.cellIndex > 0 && td.dataset.assessmentId !== id && td.dataset.vistoId !== id && !td.classList.contains('result-cell') && !td.classList.contains('situation-cell')) {
                        td.classList.add('filter-hidden');
                    }
                });
            }
        }

        // --- EVENT LISTENERS ---
        $$('[id^="reports-header-btn-"], .reports-main-btn').forEach(btn => btn.addEventListener('click', () => navigateTo('reports-view')));
        $$('#favorites-btn, [id$="-favorites-btn"]').forEach(btn => btn.addEventListener('click', () => navigateTo('favorites-view')));
        $$('[id$="-home-btn"], #home-btn').forEach(btn => btn.addEventListener('click', () => navigateTo('dashboard-view')));
        $$('[id$="-back-btn"]').forEach(btn => btn.addEventListener('click', navigateBack));
        $$('.backup-btn').forEach(btn => btn.addEventListener('click', () => navigateTo('backup-view')));
        gotoStudentRegistrationBtn.addEventListener('click', () => navigateTo('student-registration-view'));
        gotoPeriodSelectionBtn.addEventListener('click', () => navigateTo('period-selection-view'));
        
        periodSelect.addEventListener('change', () => {
            selectedPeriod = periodSelect.value;
            periodActionsContainer.innerHTML = '';
            periodActionsContainer.classList.add('hidden');
            periodClassSelectionContainer.classList.toggle('hidden', !selectedPeriod);
            if (selectedPeriod) {
                renderClassSelection(periodClassSelect, selectedYearId);
                periodClassSelect.value = '';
            }
        });

        periodClassSelect.addEventListener('change', () => {
            selectedClassId = parseInt(periodClassSelect.value);
            periodActionsContainer.innerHTML = '';
            periodActionsContainer.classList.toggle('hidden', !selectedClassId);

            if (selectedClassId) {
                if (!annualRecoveryState[selectedClassId]) {
                    annualRecoveryState[selectedClassId] = { added: false, editing: false, grades: [] };
                }
                let buttonsHTML = '';
                if (selectedPeriod !== 'M√©dias Finais') {
                    buttonsHTML += `<button data-view="activities-view">Atividades</button>`;
                }
                buttonsHTML += `<button data-view="notes-view">Notas</button><button id="clear-period-selection-btn">Limpar Sele√ß√£o</button>`;
                periodActionsContainer.innerHTML = buttonsHTML;
            }
        });

        periodActionsContainer.addEventListener('click', (event) => {
            const button = event.target;
            if (button.id === 'clear-period-selection-btn') {
                periodSelect.value = '';
                periodSelect.dispatchEvent(new Event('change')); 
            } else if (button.dataset.view) {
                navigateTo(button.dataset.view);
            }
        });

        institutionButtonsContainer.addEventListener('click', (event) => {
            const button = event.target.closest('.institution-btn');
            if (button) navigateTo('year-selection-view', { institutionId: parseInt(button.dataset.id) });
        });

        confirmYearBtn.addEventListener('click', () => {
            const yearId = parseInt(yearSelectDropdown.value);
            if (!yearId) { showModal('Selecione um ano letivo.'); return; }
            selectedYearId = yearId; navigateTo('main-menu-view');
        });

        gotoClassRegistrationBtn.addEventListener('click', () => navigateTo('class-registration-view'));
        manageInstitutionsBtn.addEventListener('click', () => {
            renderInstitutionsInManager();
            institutionManagerPanel.classList.toggle('hidden');
        });

        colorPicker.addEventListener('input', () => colorText.value = colorPicker.value);
        colorText.addEventListener('change', () => { if (/^#[0-9A-F]{6}$/i.test(colorText.value)) colorPicker.value = colorText.value; });
        
        institutionForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = parseInt($('#institution-id').value);
            const instData = {
                name: $('#institution-name').value.trim(),
                periodType: $('#institution-period-type').value,
                passingGrade: parseFloat($('#institution-passing-grade').value),
                mainColor: $('#institution-main-color-text').value
            };
            if (id) {
                const index = institutions.findIndex(inst => inst.id === id);
                if (index > -1) institutions[index] = { id, ...instData };
            } else {
                const newId = Date.now();
                institutions.push({ id: newId, ...instData });
            }
            saveDb('institutions_db', institutions);
            renderInstitutionsInManager();
            renderInstitutionButtons();
            institutionForm.reset();
            $('#institution-id').value = '';
            colorText.value = '#007bff';
            colorPicker.value = '#007bff';
            cancelEditBtn.classList.add('hidden');
        });
        
        institutionListContainer.addEventListener('click', async (event) => {
            const target = event.target;
            const item = target.closest('.list-item');
            if (!item) return;
            const id = parseInt(item.dataset.id);
            if (target.classList.contains('edit-btn')) {
                const institution = institutions.find(inst => inst.id === id);
                $('#institution-id').value = institution.id;
                $('#institution-name').value = institution.name;
                $('#institution-period-type').value = institution.periodType;
                $('#institution-passing-grade').value = institution.passingGrade;
                colorPicker.value = institution.mainColor;
                colorText.value = institution.mainColor;
                cancelEditBtn.classList.remove('hidden');
                institutionManagerPanel.classList.remove('hidden');
                window.scrollTo(0, 0);
            } else if (target.classList.contains('remove-btn')) {
                if (anosLetivos.some(ano => ano.institutionId === id)) {
                    showModal('N√£o √© poss√≠vel remover. Existem Anos Letivos vinculados.');
                    return;
                }
                if (await showModal('Tem certeza?', true)) {
                    institutions = institutions.filter(inst => inst.id !== id);
                    saveDb('institutions_db', institutions);
                    renderInstitutionsInManager();
                    renderInstitutionButtons();
                }
            }
        });
        
        cancelEditBtn.addEventListener('click', () => {
            institutionForm.reset();
            $('#institution-id').value = '';
            cancelEditBtn.classList.add('hidden');
        });
        
        manageYearsBtn.addEventListener('click', () => yearManagerPanel.classList.toggle('hidden'));
        
        yearForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const yearInput = $('#year-input');
            const year = parseInt(yearInput.value);
            if (!year || year < 1900 || year > 2100) { showModal('Ano inv√°lido.'); return; }
            if (anosLetivos.some(y => y.year === year && y.institutionId === selectedInstitutionId)) { showModal('Este ano j√° foi cadastrado.'); return; }
            anosLetivos.push({ id: Date.now(), year, institutionId: selectedInstitutionId });
            saveDb('anos_letivos_db', anosLetivos);
            renderAnosLetivos();
            yearInput.value = '';
        });
        
        yearListContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-year-btn')) {
                const item = event.target.closest('.list-item');
                const id = parseInt(item.dataset.id);
                if (turmas.some(t => t.yearId === id)) { showModal('N√£o √© poss√≠vel remover. Existem turmas neste ano letivo.'); return; }
                anosLetivos = anosLetivos.filter(ano => ano.id !== id);
                saveDb('anos_letivos_db', anosLetivos);
                renderAnosLetivos();
            }
        });
        
        classForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const classId = parseInt($('#class-id').value);
            const name = $('#class-name-input').value.trim();
            const subject = $('#class-subject-input').value.trim();
            if(!name || !subject) { showModal('Campos obrigat√≥rios.'); return; }
            
            const isDuplicate = turmas.some(t => t.yearId === selectedYearId && t.id !== classId && `${t.name} - ${t.subject}`.toLowerCase() === `${name} - ${subject}`.toLowerCase());
            if (isDuplicate) { showModal(`A turma "${name} - ${subject}" j√° existe.`); return; }
            
            if (classId) {
                const index = turmas.findIndex(t => t.id === classId);
                if(index > -1) Object.assign(turmas[index], { name, subject });
            } else {
                turmas.push({ id: Date.now(), name, subject, yearId: selectedYearId, institutionId: selectedInstitutionId });
            }
            saveDb('turmas_db', turmas);
            renderTurmas();
            classForm.reset();
            $('#class-id').value = '';
        });
        
        classListContainer.addEventListener('click', async (event) => {
            const target = event.target;
            if (!target.dataset.id) return;
            const id = parseInt(target.dataset.id);
            
            if(target.classList.contains('edit-class-btn')) {
                const turma = turmas.find(t => t.id === id);
                $('#class-id').value = turma.id;
                $('#class-name-input').value = turma.name;
                $('#class-subject-input').value = turma.subject;
            } else if(target.classList.contains('remove-class-btn')) {
                if (alunos.some(a => a.classId === id)) { showModal('N√£o √© poss√≠vel remover. Existem alunos nesta turma.'); return; }
                if(await showModal('Tem certeza?', true)) {
                    turmas = turmas.filter(t => t.id !== id);
                    saveDb('turmas_db', turmas);
                    renderTurmas();
                }
            }
        });
        
        classSelectionForStudents.addEventListener('change', () => {
            selectedClassId = parseInt(classSelectionForStudents.value);
            studentListEditPanel.classList.add('hidden');
            studentImportPanel.classList.add('hidden');
            inactivateStudentListPanel.classList.add('hidden');
            studentEntryContainer.classList.toggle('hidden', !selectedClassId);
            if (selectedClassId) renderAlunos();
        });
        
        addStudentsBtn.addEventListener('click', () => {
            const textarea = $('#student-names-textarea');
            const names = textarea.value.split('\n').filter(name => name.trim() !== '');
            if (names.length === 0) { showModal('Digite os nomes dos alunos.'); return; }
            
            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId);
            let maxNumber = alunosDaTurma.length > 0 ? Math.max(...alunosDaTurma.map(a => a.number)) : 0;
            const timestamp = Date.now();
            names.forEach((name, index) => {
                alunos.push({ id: timestamp + index, name: name.trim(), number: ++maxNumber, classId: selectedClassId, active: true });
            });
            saveDb('alunos_db', alunos);
            renderAlunos();
            textarea.value = '';
        });
        
        editStudentListBtn.addEventListener('click', () => {
            studentImportPanel.classList.add('hidden');
            inactivateStudentListPanel.classList.add('hidden');
            const alunosDaTurma = alunos.filter(a => a.classId === selectedClassId).sort((a,b) => a.number - b.number);
            $('#student-list-edit-textarea').value = alunosDaTurma.map(aluno => aluno.name).join('\n');
            studentListEditPanel.classList.remove('hidden');
        });
        
        cancelStudentListEditBtn.addEventListener('click', () => studentListEditPanel.classList.add('hidden'));
        
        saveStudentListBtn.addEventListener('click', async () => {
            if (!await showModal('Isso ir√° substituir a lista de alunos atual. Deseja continuar?', true)) return;
            
            const newNames = $('#student-list-edit-textarea').value.split('\n').map(name => name.trim()).filter(Boolean);
            const inactiveStudents = alunos.filter(a => a.classId === selectedClassId && a.active === false);
            alunos = alunos.filter(a => a.classId !== selectedClassId);
            
            let currentNumber = 0;
            const timestamp = Date.now();
            newNames.forEach((name, index) => {
                alunos.push({ id: timestamp + index, name: name, number: ++currentNumber, classId: selectedClassId, active: true });
            });
            inactiveStudents.forEach(inactive => {
                alunos.push({ ...inactive, number: ++currentNumber });
            });

            saveDb('alunos_db', alunos);
            renderAlunos();
            studentListEditPanel.classList.add('hidden');
        });

        importStudentsBtn.addEventListener('click', () => {
            studentListEditPanel.classList.add('hidden');
            inactivateStudentListPanel.classList.add('hidden');
            
            const currentAnoLetivo = anosLetivos.find(a => a.id === selectedYearId);
            const previousAnoLetivo = anosLetivos.find(a => a.institutionId === selectedInstitutionId && a.year === currentAnoLetivo.year - 1);
            
            const turmasAtuais = turmas.filter(t => t.yearId === selectedYearId && t.id !== selectedClassId).map(t => ({ ...t, year: currentAnoLetivo.year }));
            const turmasAnteriores = previousAnoLetivo ? turmas.filter(t => t.yearId === previousAnoLetivo.id).map(t => ({ ...t, year: previousAnoLetivo.year })) : [];
            const allPossibleTurmas = [...turmasAnteriores, ...turmasAtuais].sort((a, b) => b.year - a.year || `${a.name} - ${a.subject}`.localeCompare(`${b.name} - ${b.subject}`));

            if (allPossibleTurmas.length > 0) {
                importFromClassSelect.innerHTML = '<option value="">-- Selecione uma Turma --</option>';
                allPossibleTurmas.forEach(t => importFromClassSelect.insertAdjacentHTML('beforeend', `<option value="${t.id}">${t.name} - ${t.subject} (${t.year})</option>`));
                studentImportPanel.classList.remove('hidden');
            } else {
                showModal('N√£o h√° outras turmas para importar alunos.');
            }
        });

        cancelImportBtn.addEventListener('click', () => studentImportPanel.classList.add('hidden'));

        confirmImportBtn.addEventListener('click', () => {
            const sourceClassId = parseInt(importFromClassSelect.value);
            if (!sourceClassId) { showModal('Selecione uma turma de origem.'); return; }

            const alunosDaFonte = alunos.filter(a => a.classId === sourceClassId);
            const nomesDoDestino = new Set(alunos.filter(a => a.classId === selectedClassId).map(a => a.name.toLowerCase().trim()));
            const alunosParaImportar = alunosDaFonte.filter(a => !nomesDoDestino.has(a.name.toLowerCase().trim()));

            if (alunosParaImportar.length === 0) { showModal('Nenhum aluno novo para importar.'); return; }

            let maxNumber = Math.max(0, ...alunos.filter(a => a.classId === selectedClassId).map(a => a.number));
            const timestamp = Date.now();
            alunosParaImportar.forEach((aluno, index) => {
                alunos.push({ id: timestamp + index, name: aluno.name, number: ++maxNumber, classId: selectedClassId, active: true });
            });

            saveDb('alunos_db', alunos);
            renderAlunos();
            studentImportPanel.classList.add('hidden');
            showModal(`${alunosParaImportar.length} aluno(s) importado(s) com sucesso!`);
        });

        function renderInactivateStudentList() {
            inactivateListContainer.innerHTML = '';
            alunos.filter(a => a.classId === selectedClassId).sort((a, b) => a.number - b.number).forEach(aluno => {
                inactivateListContainer.insertAdjacentHTML('beforeend', `
                    <div class="list-item">
                        <label style="display: flex; align-items: center; width: 100%;">
                            <input type="checkbox" class="inactivate-checkbox" data-id="${aluno.id}" ${aluno.active !== false ? 'checked' : ''}>
                            <span class="item-name" style="margin-left: 10px;">${aluno.number}. ${aluno.name}</span>
                        </label>
                    </div>`);
            });
        }

        inactivateStudentsBtn.addEventListener('click', () => {
            studentListEditPanel.classList.add('hidden');
            studentImportPanel.classList.add('hidden');
            renderInactivateStudentList();
            inactivateStudentListPanel.classList.remove('hidden');
        });

        cancelInactivateListBtn.addEventListener('click', () => inactivateStudentListPanel.classList.add('hidden'));

        saveInactivateListBtn.addEventListener('click', () => {
            $$('.inactivate-checkbox').forEach(checkbox => {
                const aluno = alunos.find(a => a.id === parseInt(checkbox.dataset.id));
                if (aluno) aluno.active = checkbox.checked;
            });
            saveDb('alunos_db', alunos);
            renderAlunos();
            inactivateStudentListPanel.classList.add('hidden');
            showModal('Status dos alunos atualizado com sucesso!');
        });

        // --- EVENTOS DA TELA DE NOTAS ---
        addAssessmentBtn.addEventListener('click', () => {
            assessmentForm.reset();
            $('#assessment-id').value = '';
            assessmentPanel.classList.remove('hidden');
        });

        cancelAssessmentEditBtn.addEventListener('click', () => assessmentPanel.classList.add('hidden'));

        assessmentForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = parseInt($('#assessment-id').value);
            const name = $('#assessment-name').value.trim();
            const value = parseFloat($('#assessment-value').value.replace(',', '.'));

            if (!name || isNaN(value)) { showModal('Nome e valor s√£o obrigat√≥rios.'); return; }
            if (avaliacoes.some(av => av.classId === selectedClassId && av.period === selectedPeriod && av.name.toLowerCase() === name.toLowerCase() && av.id !== id)) {
                showModal('J√° existe uma avalia√ß√£o com este nome.'); return;
            }

            notesResults = notesResults.filter(r => r.id !== `notes-${selectedClassId}-${selectedPeriod}`);
            saveDb('notes_results_db', notesResults);

            if (id) {
                const index = avaliacoes.findIndex(av => av.id === id);
                if (index > -1) Object.assign(avaliacoes[index], { name, value });
                saveDb('avaliacoes_db', avaliacoes);
                renderNotesView();
            } else {
                const newId = Date.now();
                avaliacoes.push({ id: newId, name, value, classId: selectedClassId, period: selectedPeriod, grades: [] });
                saveDb('avaliacoes_db', avaliacoes);
                renderNotesView(newId);
            }
        });
        
        function saveColumnNotes(assessmentId) {
            const assessment = avaliacoes.find(av => av.id === assessmentId);
            if (!assessment) return;
            assessment.grades = [];
            $$(`.grade-input[data-assessment-id="${assessmentId}"]`).forEach(input => {
                const grade = input.value !== '' ? parseFloat(input.value.replace(',', '.')) : null;
                if (grade !== null && !isNaN(grade)) {
                    assessment.grades.push({ studentId: parseInt(input.dataset.studentId), grade });
                }
            });
            saveDb('avaliacoes_db', avaliacoes);
            notesResults = notesResults.filter(r => r.id !== `notes-${selectedClassId}-${selectedPeriod}`);
            saveDb('notes_results_db', notesResults);
        }

        notesView.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('table-filter-checkbox')) { handleTableFilter(target); return; }

            const button = target.closest('button');
            if (!button) return;

            const handlers = {
                'calculate-notes-btn': () => {
                    const assessments = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod && !av.isRecovery);
                    if (assessments.length === 0) { showModal('N√£o h√° avalia√ß√µes para calcular.'); return; }

                    const totalValue = assessments.reduce((sum, av) => sum + av.value, 0);
                    const divisor = Math.max(1, totalValue / 10);
                    const recuperacoes = avaliacoes.filter(av => av.isRecovery && av.classId === selectedClassId && av.period === selectedPeriod);
                    
                    const scores = alunos.filter(a => a.classId === selectedClassId && a.active !== false).map(aluno => {
                        let studentTotalScore = assessments.reduce((total, assessment) => {
                            let finalGrade = (assessment.grades.find(g => g.studentId === aluno.id) || {}).grade || 0;
                            const recovery = recuperacoes.find(r => r.originalAssessmentId === assessment.id);
                            if (recovery) {
                                const recoveryGrade = (recovery.grades.find(g => g.studentId === aluno.id) || {}).grade;
                                if (recoveryGrade !== undefined) finalGrade = Math.max(finalGrade, recoveryGrade);
                            }
                            return total + finalGrade;
                        }, 0);
                        return { studentId: aluno.id, score: roundToOneDecimal(studentTotalScore / divisor) };
                    });

                    const resultId = `notes-${selectedClassId}-${selectedPeriod}`;
                    const resultIndex = notesResults.findIndex(r => r.id === resultId);
                    const newResult = { id: resultId, classId: selectedClassId, period: selectedPeriod, scores };
                    if (resultIndex > -1) notesResults[resultIndex] = newResult;
                    else notesResults.push(newResult);
                    
                    saveDb('notes_results_db', notesResults);
                    renderNotesView();
                },
                'calculate-final-grades-btn': () => renderFinalGradesView(true),
                'add-annual-recovery-btn': () => {
                    if (annualRecoveryState[selectedClassId]) annualRecoveryState[selectedClassId].added = true;
                    button.disabled = true;
                    saveDb('annual_recovery_state_db', annualRecoveryState);
                    renderFinalGradesView(false);
                },
                'edit-annual-recovery-btn': () => {
                    if (annualRecoveryState[selectedClassId]) annualRecoveryState[selectedClassId].editing = true;
                    saveDb('annual_recovery_state_db', annualRecoveryState);
                    renderFinalGradesView(false);
                },
                'save-annual-recovery-btn': () => {
                    const newGrades = [];
                    $$('.annual-recovery-input').forEach(input => {
                        const grade = input.value !== '' ? parseFloat(input.value.replace(',', '.')) : null;
                        if (grade !== null && !isNaN(grade)) newGrades.push({ studentId: parseInt(input.dataset.studentId), grade });
                    });
                    if (annualRecoveryState[selectedClassId]) {
                        annualRecoveryState[selectedClassId].grades = newGrades;
                        annualRecoveryState[selectedClassId].editing = false;
                    }
                    saveDb('annual_recovery_state_db', annualRecoveryState);
                    renderFinalGradesView(false);
                },
                'delete-annual-recovery-btn': async () => {
                    if (await showModal('Deseja remover a Recupera√ß√£o Anual? As notas ser√£o perdidas.', true)) {
                        if (annualRecoveryState[selectedClassId]) {
                            Object.assign(annualRecoveryState[selectedClassId], { added: false, editing: false, grades: [] });
                        }
                        addAnnualRecoveryBtn.disabled = false;
                        saveDb('annual_recovery_state_db', annualRecoveryState);
                        renderFinalGradesView();
                    }
                }
            };

            if (handlers[button.id]) {
                handlers[button.id]();
                return;
            }

            const assessmentId = parseInt(button.dataset.id);
            if (isNaN(assessmentId)) return;

            if (button.classList.contains('edit-assessment-name-btn')) {
                const assessment = avaliacoes.find(av => av.id === assessmentId);
                if (assessment) {
                    $('#assessment-id').value = assessment.id;
                    $('#assessment-name').value = assessment.name;
                    $('#assessment-value').value = assessment.value;
                    assessmentPanel.classList.remove('hidden');
                }
            } else if (button.classList.contains('edit-col-btn')) {
                renderNotesView(assessmentId);
            } else if (button.classList.contains('save-col-btn')) {
                saveColumnNotes(assessmentId);
                renderNotesView();
            } else if (button.classList.contains('remove-assessment-btn')) {
                if (await showModal('Remover esta avalia√ß√£o e suas notas?', true)) {
                    avaliacoes = avaliacoes.filter(av => av.id !== assessmentId && av.originalAssessmentId !== assessmentId);
                    notesResults = notesResults.filter(r => r.id !== `notes-${selectedClassId}-${selectedPeriod}`);
                    saveDb('notes_results_db', notesResults);
                    saveDb('avaliacoes_db', avaliacoes);
                    renderNotesView();
                }
            }
        });
        
        const handleGradeInputFormatting = (event) => {
            const input = event.target;
            if (!input.classList.contains('grade-input')) return;
            if (event.type === 'blur') {
                if (input.value.trim() === '') return;
                let value = parseFloat(input.value.replace(',', '.'));
                const maxValue = parseFloat(input.max);
                if (isNaN(value)) { input.value = ''; return; }
                if (value > maxValue && !input.value.includes('.')) value /= 10;
                input.value = Math.max(0, Math.min(value, maxValue)).toFixed(1);
            } else if (event.type === 'keydown' && event.key === 'Enter') {
                event.preventDefault();
                let nextTr = input.closest('tr').nextElementSibling;
                while(nextTr && nextTr.classList.contains('inactive-student-row')) nextTr = nextTr.nextElementSibling;
                if (nextTr) {
                    const nextInput = nextTr.querySelector(`.grade-input[data-assessment-id="${input.dataset.assessmentId}"]`);
                    if (nextInput) { nextInput.parentElement.classList.add('editing'); nextInput.focus(); nextInput.select(); }
                }
            } else if (event.type === 'paste') {
                event.preventDefault();
                const pasteData = (event.clipboardData || window.clipboardData).getData('text');
                const lines = pasteData.split(/\r?\n/).filter(Boolean);
                if (lines.length > 0) {
                    const assessmentId = input.dataset.assessmentId;
                    let currentTr = input.closest('tr');
                    lines.forEach(line => {
                        if (!currentTr) return;
                        while(currentTr && currentTr.classList.contains('inactive-student-row')) currentTr = currentTr.nextElementSibling;
                        if (!currentTr) return;
                        const inputInRow = currentTr.querySelector(`.grade-input[data-assessment-id="${assessmentId}"]`);
                        if (inputInRow) {
                            inputInRow.value = line.trim().replace(',', '.');
                            inputInRow.dispatchEvent(new Event('blur', { bubbles: true }));
                        }
                        currentTr = currentTr.nextElementSibling;
                    });
                    saveColumnNotes(parseInt(assessmentId));
                }
            }
        };

        notesView.addEventListener('blur', handleGradeInputFormatting, true);
        notesView.addEventListener('keydown', handleGradeInputFormatting);
        notesView.addEventListener('paste', handleGradeInputFormatting);
        continuousAssessmentPanel.addEventListener('blur', handleGradeInputFormatting, true);
        continuousAssessmentPanel.addEventListener('keydown', handleGradeInputFormatting);
        continuousAssessmentPanel.addEventListener('paste', handleGradeInputFormatting);

        editAllNotesBtn.addEventListener('click', () => {
            const isEditing = editAllNotesBtn.dataset.editing === 'true';
            if (isEditing) {
                avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod).forEach(av => saveColumnNotes(av.id));
                renderNotesView(null, false);
                showModal('Todas as notas foram salvas.');
            } else {
                renderNotesView(null, true);
            }
        });

        importNotesBtn.addEventListener('click', () => {
            importNotesSourceSelect.innerHTML = '<option value="">-- Selecione a Fonte --</option>';
            const sources = {
                vistos: vistosResults.find(r => r.id === `${selectedClassId}-${selectedPeriod}`),
                continuous: continuousAssessmentsResults.find(r => r.id === `ca-${selectedClassId}-${selectedPeriod}`),
                continuousCols: continuousAssessments.filter(ca => ca.classId === selectedClassId && ca.period === selectedPeriod)
            };

            if (sources.vistos) importNotesSourceSelect.insertAdjacentHTML('beforeend', `<option value="vistos">Total de Vistos (Valor: ${sources.vistos.totalValue.toFixed(1).replace('.',',')})</option>`);
            if (sources.continuous) importNotesSourceSelect.insertAdjacentHTML('beforeend', `<option value="continuous">Total de Avalia√ß√µes Cont√≠nuas</option>`);
            
            if(sources.continuousCols.length > 0){
                const group = document.createElement('optgroup');
                group.label = 'Avalia√ß√µes Cont√≠nuas Individuais';
                sources.continuousCols.forEach(col => {
                    const date = new Date(col.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    group.insertAdjacentHTML('beforeend', `<option value="ca-${col.id}">Aval. Cont. (${date})</option>`);
                });
                importNotesSourceSelect.appendChild(group);
            }

            if (importNotesSourceSelect.options.length > 1) {
                importNotesForm.reset();
                importNotesValueContainer.classList.add('hidden');
                importNotesModalOverlay.classList.remove('hidden');
            } else {
                showModal('N√£o h√° resultados ou atividades para importar.');
            }
        });
        
        importNotesSourceSelect.addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            if (selectedValue.startsWith('ca-')) {
                importNotesValueContainer.classList.remove('hidden');
                const assessmentId = parseInt(selectedValue.replace('ca-', ''));
                const assessment = continuousAssessments.find(ca => ca.id === assessmentId);
                if (assessment) {
                    const date = new Date(assessment.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    $('#import-notes-name').value = `Aval. Cont. ${date}`;
                }
            } else {
                importNotesValueContainer.classList.add('hidden');
                $('#import-notes-name').value = '';
            }
        });

        cancelImportNotesBtn.addEventListener('click', () => importNotesModalOverlay.classList.add('hidden'));

        importNotesForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const newName = $('#import-notes-name').value.trim();
            const sourceKey = importNotesSourceSelect.value;
            if (!newName || !sourceKey) { showModal('Preencha todos os campos.'); return; }
            if (avaliacoes.some(av => av.classId === selectedClassId && av.period === selectedPeriod && av.name.toLowerCase() === newName.toLowerCase())) {
                showModal('J√° existe uma avalia√ß√£o com este nome.'); return;
            }

            let sourceData;
            let newValue = 10.0; // Default value

            if (sourceKey.startsWith('ca-')) {
                const assessmentId = parseInt(sourceKey.replace('ca-', ''));
                sourceData = continuousAssessments.find(ca => ca.id === assessmentId);
                newValue = parseFloat($('#import-notes-value').value.replace(',', '.'));
                if(isNaN(newValue) || newValue <= 0) {
                    showModal('Por favor, insira um valor v√°lido para a avalia√ß√£o.');
                    return;
                }
            } else if (sourceKey === 'vistos') {
                sourceData = vistosResults.find(r => r.id === `${selectedClassId}-${selectedPeriod}`);
                newValue = sourceData.totalValue;
            } else if (sourceKey === 'continuous') {
                sourceData = continuousAssessmentsResults.find(r => r.id === `ca-${selectedClassId}-${selectedPeriod}`);
                newValue = 10.0;
            }

            if (!sourceData) { showModal('Erro ao encontrar dados de origem.'); return; }
            
            const gradesToImport = sourceData.grades || sourceData.scores;

            avaliacoes.push({
                id: Date.now(),
                name: newName,
                value: newValue,
                classId: selectedClassId,
                period: selectedPeriod,
                grades: gradesToImport.map(s => ({ studentId: s.studentId, grade: s.grade !== undefined ? s.grade : s.score }))
            });

            saveDb('avaliacoes_db', avaliacoes);
            renderNotesView();
            importNotesModalOverlay.classList.add('hidden');
            showModal('Notas importadas com sucesso!');
        });

        recoveryBtn.addEventListener('click', () => {
            recoveryForm.reset();
            recoveryAssessmentSelection.classList.add('hidden');
            const institution = institutions.find(i => i.id === selectedInstitutionId);
            if (institution) recoveryTypeSelect.querySelector('option[value="period"]').textContent = `Recupera√ß√£o ${institution.periodType}`;
            recoveryModalOverlay.classList.remove('hidden');
        });

        cancelRecoveryBtn.addEventListener('click', () => recoveryModalOverlay.classList.add('hidden'));

        recoveryTypeSelect.addEventListener('change', () => {
            recoveryAssessmentSelection.classList.toggle('hidden', recoveryTypeSelect.value !== 'assessment');
            if (recoveryTypeSelect.value === 'assessment') {
                const assessments = avaliacoes.filter(av => av.classId === selectedClassId && av.period === selectedPeriod && !av.isRecovery);
                recoveryAssessmentSelect.innerHTML = '<option value="">-- Selecione --</option>';
                assessments.forEach(av => recoveryAssessmentSelect.insertAdjacentHTML('beforeend', `<option value="${av.id}">${av.name}</option>`));
            }
        });

        recoveryForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const type = recoveryTypeSelect.value;
            if (!type) { showModal('Selecione um tipo de recupera√ß√£o.'); return; }

            let newRecovery = {
                id: Date.now(),
                classId: selectedClassId,
                period: selectedPeriod,
                grades: [],
                isRecovery: true
            };

            if (type === 'assessment') {
                const originalId = parseInt(recoveryAssessmentSelect.value);
                if (!originalId) { showModal('Selecione uma avalia√ß√£o para recuperar.'); return; }
                const originalAssessment = avaliacoes.find(av => av.id === originalId);
                Object.assign(newRecovery, { name: `Rec. ${originalAssessment.name}`, value: originalAssessment.value, recoveryType: 'assessment', originalAssessmentId: originalId });
            } else {
                const institution = institutions.find(i => i.id === selectedInstitutionId);
                Object.assign(newRecovery, { name: `Recupera√ß√£o ${institution.periodType}`, value: 10.0, recoveryType: 'period' });
            }
            avaliacoes.push(newRecovery);
            saveDb('avaliacoes_db', avaliacoes);
            renderNotesView();
            recoveryModalOverlay.classList.add('hidden');
        });

        // --- EVENTOS DA TELA DE ATIVIDADES ---
        toggleVistosPanelBtn.addEventListener('click', () => {
            vistosPanel.classList.toggle('hidden');
            continuousAssessmentPanel.classList.add('hidden');
            if (!vistosPanel.classList.contains('hidden')) renderVistosView();
        });

        toggleContinuousAssessmentPanelBtn.addEventListener('click', () => {
            continuousAssessmentPanel.classList.toggle('hidden');
            vistosPanel.classList.add('hidden');
            if (!continuousAssessmentPanel.classList.contains('hidden')) renderContinuousAssessmentsView();
        });

        addVistoBtn.addEventListener('click', () => {
            vistoForm.reset();
            $('#visto-id').value = '';
            vistoFormPanel.classList.remove('hidden');
        });

        cancelVistoEditBtn.addEventListener('click', () => vistoFormPanel.classList.add('hidden'));

        vistoForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = parseInt($('#visto-id').value);
            const date = $('#visto-date').value;
            const description = $('#visto-description').value.trim();
            if (!date || !description) { showModal('Data e descri√ß√£o s√£o obrigat√≥rias.'); return; }

            vistosResults = vistosResults.filter(r => r.id !== `${selectedClassId}-${selectedPeriod}`);
            saveDb('vistos_results_db', vistosResults);

            if (id) {
                const index = vistos.findIndex(v => v.id === id);
                if (index > -1) Object.assign(vistos[index], { date, description });
            } else {
                vistos.push({ id: Date.now(), date, description, classId: selectedClassId, period: selectedPeriod, records: [] });
            }
            saveDb('vistos_db', vistos);
            renderVistosView();
            vistoFormPanel.classList.add('hidden');
        });

        activitiesView.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('table-filter-checkbox')) { handleTableFilter(target); return; }
            const button = target.closest('button');
            if (!button || !button.dataset.id) return;

            const vistoId = parseInt(button.dataset.id);
            if (button.classList.contains('edit-visto-btn')) {
                const visto = vistos.find(v => v.id === vistoId);
                if (visto) {
                    $('#visto-id').value = visto.id;
                    $('#visto-date').value = visto.date;
                    $('#visto-description').value = visto.description;
                    vistoFormPanel.classList.remove('hidden');
                }
            } else if (button.classList.contains('info-visto-btn')) {
                const visto = vistos.find(v => v.id === vistoId);
                if (visto) showModal(`Descri√ß√£o: ${visto.description}`);
            } else if (button.classList.contains('remove-visto-btn')) {
                if (await showModal('Remover este visto e seus registros?', true)) {
                    vistos = vistos.filter(v => v.id !== vistoId);
                    vistosResults = vistosResults.filter(r => r.id !== `${selectedClassId}-${selectedPeriod}`);
                    saveDb('vistos_db', vistos);
                    saveDb('vistos_results_db', vistosResults);
                    renderVistosView();
                }
            }
        });

        activitiesView.addEventListener('change', (event) => {
            const select = event.target;
            if (select.classList.contains('visto-select')) {
                const studentId = parseInt(select.dataset.studentId);
                const vistoId = parseInt(select.dataset.vistoId);
                const value = select.value;
                const visto = vistos.find(v => v.id === vistoId);
                if (!visto) return;
                const recordIndex = visto.records.findIndex(r => r.studentId === studentId);
                if (recordIndex > -1) {
                    if (value === '-') visto.records.splice(recordIndex, 1);
                    else visto.records[recordIndex].value = value;
                } else if (value !== '-') {
                    visto.records.push({ studentId, value });
                }
                saveDb('vistos_db', vistos);
            }
        });

        calculateVistosBtn.addEventListener('click', () => vistoCalcPanel.classList.remove('hidden'));
        cancelVistoCalcBtn.addEventListener('click', () => vistoCalcPanel.classList.add('hidden'));

        vistoCalcForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const totalValue = parseFloat($('#visto-calc-total-value').value.replace(',', '.'));
            if (isNaN(totalValue)) { showModal('Insira um valor total v√°lido.'); return; }
            const vistosDaTurma = vistos.filter(v => v.classId === selectedClassId && v.period === selectedPeriod);
            if (vistosDaTurma.length === 0) { showModal('N√£o h√° vistos para calcular.'); return; }

            const valuePerColumn = totalValue / vistosDaTurma.length;
            const multipliers = { 'C': 1, 'I': 0.5, 'AT': 0.8, 'F': 0, 'NFT': 0, 'NTM': 0, '-': 0 };
            const scores = alunos.filter(a => a.classId === selectedClassId && a.active !== false).map(aluno => {
                let totalScore = vistosDaTurma.reduce((total, visto) => {
                    const value = (visto.records.find(r => r.studentId === aluno.id) || {}).value || '-';
                    return total + (valuePerColumn * (multipliers[value] || 0));
                }, 0);
                return { studentId: aluno.id, score: roundToOneDecimal(totalScore) };
            });

            const resultId = `${selectedClassId}-${selectedPeriod}`;
            const resultIndex = vistosResults.findIndex(r => r.id === resultId);
            const newResult = { id: resultId, classId: selectedClassId, period: selectedPeriod, totalValue, scores };
            if (resultIndex > -1) vistosResults[resultIndex] = newResult;
            else vistosResults.push(newResult);
            
            saveDb('vistos_results_db', vistosResults);
            renderVistosView();
            vistoCalcPanel.classList.add('hidden');
        });

        // --- EVENTOS DE AVALIA√á√ïES CONT√çNUAS ---
        addContinuousAssessmentBtn.addEventListener('click', () => {
            continuousAssessmentForm.reset();
            $('#continuous-assessment-id').value = '';
            continuousAssessmentFormPanel.classList.remove('hidden');
        });

        cancelContinuousAssessmentEditBtn.addEventListener('click', () => continuousAssessmentFormPanel.classList.add('hidden'));

        continuousAssessmentForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const id = parseInt($('#continuous-assessment-id').value);
            const date = $('#continuous-assessment-date').value;
            if (!date) { showModal('A data √© obrigat√≥ria.'); return; }

            continuousAssessmentsResults = continuousAssessmentsResults.filter(r => r.id !== `ca-${selectedClassId}-${selectedPeriod}`);
            saveDb('continuous_assessments_results_db', continuousAssessmentsResults);

            if (id) {
                const index = continuousAssessments.findIndex(v => v.id === id);
                if (index > -1) continuousAssessments[index].date = date;
                saveDb('continuous_assessments_db', continuousAssessments);
                renderContinuousAssessmentsView();
            } else {
                continuousAssessments.push({ id: Date.now(), date, classId: selectedClassId, period: selectedPeriod, grades: [], maxValue: 10.0 });
                saveDb('continuous_assessments_db', continuousAssessments);
                renderContinuousAssessmentsView(Date.now());
            }
            continuousAssessmentFormPanel.classList.add('hidden');
        });

        function saveContinuousColumnNotes(assessmentId) {
            const assessment = continuousAssessments.find(av => av.id === assessmentId);
            if (!assessment) return;
            assessment.grades = [];
            $$(`#continuous-assessment-table .grade-input[data-assessment-id="${assessmentId}"]`).forEach(input => {
                const grade = input.value !== '' ? parseFloat(input.value.replace(',', '.')) : null;
                if (grade !== null && !isNaN(grade)) {
                    assessment.grades.push({ studentId: parseInt(input.dataset.studentId), grade });
                }
            });
            saveDb('continuous_assessments_db', continuousAssessments);
        }
        
        continuousAssessmentPanel.addEventListener('click', async (event) => {
            const button = event.target.closest('button');
            if (!button) return;
            if(button.id === 'convert-continuous-assessment-btn') {
                gradeConversionModalOverlay.classList.remove('hidden'); return;
            }
            const assessmentId = parseInt(button.dataset.id);
            if (isNaN(assessmentId)) return;

            if (button.classList.contains('edit-continuous-assessment-btn')) {
                const assessment = continuousAssessments.find(av => av.id === assessmentId);
                if (assessment) {
                    $('#continuous-assessment-id').value = assessment.id;
                    $('#continuous-assessment-date').value = assessment.date;
                    continuousAssessmentFormPanel.classList.remove('hidden');
                }
            } else if (button.classList.contains('edit-col-btn')) {
                renderContinuousAssessmentsView(assessmentId);
            } else if (button.classList.contains('save-col-btn')) {
                saveContinuousColumnNotes(assessmentId);
                renderContinuousAssessmentsView();
            } else if (button.classList.contains('remove-continuous-assessment-btn')) {
                if (await showModal('Remover esta avalia√ß√£o e suas notas?', true)) {
                    continuousAssessments = continuousAssessments.filter(av => av.id !== assessmentId);
                    continuousAssessmentsResults = continuousAssessmentsResults.filter(r => r.id !== `ca-${selectedClassId}-${selectedPeriod}`);
                    saveDb('continuous_assessments_db', continuousAssessments);
                    saveDb('continuous_assessments_results_db', continuousAssessmentsResults);
                    renderContinuousAssessmentsView();
                }
            }
        });

        calculateContinuousAssessmentBtn.addEventListener('click', () => {
            const assessments = continuousAssessments.filter(v => v.classId === selectedClassId && v.period === selectedPeriod);
            if (assessments.length === 0) { showModal('N√£o h√° avalia√ß√µes para calcular a m√©dia.'); return; }

            const scores = alunos.filter(a => a.classId === selectedClassId && a.active !== false).map(aluno => {
                let totalScore = 0;
                let count = 0;
                assessments.forEach(assessment => {
                    const grade = (assessment.grades.find(r => r.studentId === aluno.id) || {}).grade;
                    if (grade !== null && grade !== undefined) { totalScore += grade; count++; }
                });
                return { studentId: aluno.id, score: roundToOneDecimal(count > 0 ? totalScore / count : 0) };
            });

            const resultId = `ca-${selectedClassId}-${selectedPeriod}`;
            const resultIndex = continuousAssessmentsResults.findIndex(r => r.id === resultId);
            const newResult = { id: resultId, classId: selectedClassId, period: selectedPeriod, scores };
            if (resultIndex > -1) continuousAssessmentsResults[resultIndex] = newResult;
            else continuousAssessmentsResults.push(newResult);
            
            saveDb('continuous_assessments_results_db', continuousAssessmentsResults);
            renderContinuousAssessmentsView();
        });

        editAllContinuousAssessmentsBtn.addEventListener('click', () => {
            const isEditing = editAllContinuousAssessmentsBtn.dataset.editing === 'true';
            if (isEditing) {
                continuousAssessments.filter(av => av.classId === selectedClassId && av.period === selectedPeriod).forEach(av => saveContinuousColumnNotes(av.id));
                renderContinuousAssessmentsView(null, false);
                showModal('Todas as notas foram salvas.');
            } else {
                renderContinuousAssessmentsView(null, true);
            }
        });

        cancelGradeConversionBtn.addEventListener('click', () => gradeConversionModalOverlay.classList.add('hidden'));

        gradeConversionForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const newMaxValue = parseFloat($('#new-max-grade').value.replace(',', '.'));
            if (isNaN(newMaxValue) || newMaxValue <= 0) { showModal('Insira um valor m√°ximo v√°lido.'); return; }

            continuousAssessments.filter(v => v.classId === selectedClassId && v.period === selectedPeriod).forEach(assessment => {
                const originalMaxValue = assessment.maxValue || 10.0;
                assessment.grades.forEach(grade => {
                    if (grade.grade !== null) {
                        let convertedGrade = (grade.grade / originalMaxValue) * newMaxValue;
                        grade.grade = roundToOneDecimal(Math.min(convertedGrade, newMaxValue));
                    }
                });
                assessment.maxValue = newMaxValue;
            });

            saveDb('continuous_assessments_db', continuousAssessments);
            renderContinuousAssessmentsView();
            gradeConversionModalOverlay.classList.add('hidden');
            showModal('Notas convertidas com sucesso!');
        });

        // --- EVENTOS DA TELA DE FAVORITOS ---
        addFavoriteBtn.addEventListener('click', () => {
            favoriteFormPanel.classList.toggle('hidden');
            favoriteForm.reset();
            favoriteYearSelect.innerHTML = '<option value="">Selecione um Ano Letivo</option>';
            favoritePeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
            favoriteInstitutionSelect.innerHTML = '<option value="">Selecione uma Institui√ß√£o</option>';
            institutions.forEach(inst => favoriteInstitutionSelect.insertAdjacentHTML('beforeend', `<option value="${inst.id}">${inst.name}</option>`));
        });

        favoriteInstitutionSelect.addEventListener('change', () => {
            const instId = parseInt(favoriteInstitutionSelect.value);
            const institution = institutions.find(i => i.id === instId);
            favoriteYearSelect.innerHTML = '<option value="">Selecione um Ano Letivo</option>';
            anosLetivos.filter(y => y.institutionId === instId).forEach(year => favoriteYearSelect.insertAdjacentHTML('beforeend', `<option value="${year.id}">${year.year}</option>`));
            favoritePeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
            if (institution) {
                const periodMap = { 'Bimestral': ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre'], 'Trimestral': ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre'], 'Semestral': ['1¬∫ Semestre', '2¬∫ Semestre'] };
                (periodMap[institution.periodType] || []).concat('M√©dias Finais').forEach(opt => favoritePeriodSelect.insertAdjacentHTML('beforeend', `<option value="${opt}">${opt}</option>`));
            }
        });

        favoriteForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const name = $('#favorite-name-input').value.trim();
            const instId = parseInt(favoriteInstitutionSelect.value);
            const yearId = parseInt(favoriteYearSelect.value);
            const period = favoritePeriodSelect.value;
            if(!name || !instId || !yearId || !period) { showModal('Todos os campos s√£o obrigat√≥rios.'); return; }
            favorites.push({ id: Date.now(), name, institutionId: instId, yearId, period });
            saveDb('favorites_db', favorites);
            renderFavorites();
            favoriteFormPanel.classList.add('hidden');
        });

        favoriteListContainer.addEventListener('click', async (event) => {
            const button = event.target.closest('button');
            if (!button) return;
            const favId = parseInt(button.dataset.id);
            if (button.classList.contains('go-favorite-btn')) {
                const favorite = favorites.find(f => f.id === favId);
                if (favorite) {
                    selectedInstitutionId = favorite.institutionId;
                    selectedYearId = favorite.yearId;
                    selectedPeriod = favorite.period;
                    navigateTo('period-selection-view', { fromFavorite: true });
                }
            } else if (button.classList.contains('remove-favorite-btn')) {
                if (await showModal('Remover este favorito?', true)) {
                    favorites = favorites.filter(f => f.id !== favId);
                    saveDb('favorites_db', favorites);
                    renderFavorites();
                }
            }
        });

        // --- EVENTOS DA TELA DE RELAT√ìRIOS ---
        reportInstitutionSelect.addEventListener('change', () => {
            const instId = parseInt(reportInstitutionSelect.value);
            const institution = institutions.find(i => i.id === instId);
            reportYearSelect.innerHTML = '<option value="">Selecione um Ano Letivo</option>';
            anosLetivos.filter(y => y.institutionId === instId).sort((a,b) => b.year - a.year).forEach(year => reportYearSelect.insertAdjacentHTML('beforeend', `<option value="${year.id}">${year.year}</option>`));
            reportClassSelect.innerHTML = '<option value="">Selecione uma Turma</option>';
            reportPeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
            reportTypeSelect.innerHTML = '<option value="">Selecione um Tipo de Relat√≥rio</option>';
            if (institution) {
                const periodTypeName = institution.periodType;
                reportTypeSelect.insertAdjacentHTML('beforeend', `
                    <option value="complete">Relat√≥rio Completo</option>
                    <option value="recovery-students">Alunos em Recupera√ß√£o ${periodTypeName}</option>
                    <option value="recovery-grades">Notas da Recupera√ß√£o ${periodTypeName}</option>
                    <option value="final-grades">M√©dias Finais</option>
                    <option value="proof-record">Ata de Prova</option>`);
            }
        });

        reportYearSelect.addEventListener('change', () => {
            const yearId = parseInt(reportYearSelect.value);
            const turmasDoAno = turmas.filter(t => t.yearId === yearId);
            reportClassSelect.innerHTML = '<option value="">Selecione uma Turma</option>';
            if (turmasDoAno.length > 0) {
                reportClassSelect.insertAdjacentHTML('beforeend', '<option value="all">Todas as Turmas</option>');
                turmasDoAno.sort((a,b) => `${a.name} - ${a.subject}`.localeCompare(`${b.name} - ${b.subject}`));
                turmasDoAno.forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma.id;
                    option.textContent = `${turma.name} - ${turma.subject}`;
                    reportClassSelect.appendChild(option);
                });
            }
            reportPeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
        });

        reportClassSelect.addEventListener('change', () => {
            const instId = parseInt(reportInstitutionSelect.value);
            const institution = institutions.find(i => i.id === instId);
            reportPeriodSelect.innerHTML = '<option value="">Selecione um Per√≠odo</option>';
            if (institution) {
                const periodMap = { 'Bimestral': ['1¬∫ Bimestre', '2¬∫ Bimestre', '3¬∫ Bimestre', '4¬∫ Bimestre'], 'Trimestral': ['1¬∫ Trimestre', '2¬∫ Trimestre', '3¬∫ Trimestre'], 'Semestral': ['1¬∫ Semestre', '2¬∫ Semestre'] };
                (periodMap[institution.periodType] || []).concat('M√©dias Finais').forEach(opt => reportPeriodSelect.insertAdjacentHTML('beforeend', `<option value="${opt}">${opt}</option>`));
            }
        });
        
        // --- L√ìGICA DE GERA√á√ÉO DE RELAT√ìRIOS (Refatorada) ---
        function generateAndDisplayReport() {
            const instId = parseInt(reportInstitutionSelect.value);
            const yearId = parseInt(reportYearSelect.value);
            const classIdValue = reportClassSelect.value;
            const period = reportPeriodSelect.value;
            const type = reportTypeSelect.value;
            
            const isProofRecord = type === 'proof-record';
            if (!instId || !yearId || !classIdValue || (!period && !isProofRecord) || !type) {
                showModal('Preencha todos os filtros para gerar o relat√≥rio.');
                return;
            }
        
            const institution = institutions.find(i => i.id === instId);
            const year = anosLetivos.find(y => y.id === yearId);
            const classesToReport = classIdValue === 'all' ? turmas.filter(t => t.yearId === yearId) : [turmas.find(t => t.id === parseInt(classIdValue))];
        
            const reportGenerators = {
                'complete': generateCompleteReportHTML,
                'recovery-students': generateRecoveryStudentsReportHTML,
                'recovery-grades': generateRecoveryGradesReportHTML,
                'final-grades': generateFinalGradesReportHTML,
                'proof-record': generateProofRecordHTML
            };

            let reportHTML = classesToReport.map(turma => {
                if (!turma) return '';
                const title = `<h3>${institution.name}</h3><h4>Ano Letivo: ${year.year}</h4><h4>Turma: ${turma.name} - ${turma.subject}</h4>${!isProofRecord ? `<h4>Per√≠odo: ${period}</h4>` : ''}`;
                const tableHTML = reportGenerators[type](institution, turma.id, period);
                return `<div class="report-content"><div class="report-header">${title}</div>${tableHTML}</div>`;
            }).join('');
        
            if (reportHTML) {
                reportOutputContainer.innerHTML = reportHTML + `
                    <div class="report-controls">
                        <div class="align-controls">
                            <button class="align-btn" data-align="left">E</button>
                            <button class="align-btn active" data-align="center">C</button>
                            <button class="align-btn" data-align="right">D</button>
                        </div>
                        <button id="print-report-btn">Imprimir Relat√≥rio</button>
                    </div>`;
                $('#print-report-btn').addEventListener('click', () => window.print());
                reportOutputContainer.querySelector('.align-controls').addEventListener('click', (e) => {
                    if (e.target.classList.contains('align-btn')) {
                        const align = e.target.dataset.align;
                        $$('.table-wrapper').forEach(w => { w.className = `table-wrapper align-${align}`; });
                        $$('.align-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                    }
                });
            } else {
                reportOutputContainer.innerHTML = '<p>Nenhum dado encontrado para os filtros selecionados.</p>';
            }
        }
        
        function generateCompleteReportHTML(institution, classId, period) {
            const studentList = alunos.filter(a => a.classId === classId && a.active !== false).sort((a,b) => a.number - b.number);
            const assessments = avaliacoes.filter(av => av.classId === classId && av.period === period && !av.isRecovery);
            const recoveries = avaliacoes.filter(av => av.isRecovery && av.classId === classId && av.period === period);
            const periodResult = notesResults.find(r => r.id === `notes-${classId}-${period}`);
            const periodRecovery = recoveries.find(rec => rec.recoveryType === 'period');
        
            let headers = ['Aluno', ...assessments.flatMap(av => [av.name, ...(recoveries.some(r => r.originalAssessmentId === av.id) ? [`Rec. ${av.name}`] : [])])];
            if(periodRecovery) headers.push(`Rec. ${institution.periodType.replace('estral', '.')}`);
            if(periodResult) headers.push('M√©dia', 'Situa√ß√£o');
        
            const rows = studentList.map(student => {
                let rowData = [`${student.number}. ${student.name}`];
                assessments.forEach(av => {
                    const gradeObj = av.grades.find(g => g.studentId === student.id);
                    rowData.push(gradeObj ? gradeObj.grade.toFixed(1).replace('.',',') : '-');
                    const recovery = recoveries.find(rec => rec.originalAssessmentId === av.id);
                    if(recovery) {
                        const recGradeObj = recovery.grades.find(g => g.studentId === student.id);
                        rowData.push(recGradeObj ? recGradeObj.grade.toFixed(1).replace('.',',') : '-');
                    }
                });
                if(periodRecovery) {
                    const recGradeObj = periodRecovery.grades.find(g => g.studentId === student.id);
                    rowData.push(recGradeObj ? recGradeObj.grade.toFixed(1).replace('.',',') : '-');
                }
                if(periodResult) {
                    const studentScoreObj = periodResult.scores.find(s => s.studentId === student.id);
                    if(studentScoreObj) {
                        let finalScore = studentScoreObj.score;
                        const recGradeObj = periodRecovery ? periodRecovery.grades.find(g => g.studentId === student.id) : null;
                        if(recGradeObj && recGradeObj.grade !== null) finalScore = Math.max(finalScore, recGradeObj.grade);
                        
                        let situation;
                        if (recGradeObj && recGradeObj.grade !== null) {
                            situation = recGradeObj.grade >= 7.0 ? 'Recuperou' : 'N√£o Recuperou';
                        } else {
                            situation = finalScore >= institution.passingGrade ? 'Aprovado' : 'Recupera√ß√£o';
                        }
                        rowData.push(finalScore.toFixed(1).replace('.',','), situation);
                    } else { rowData.push('-', '-'); }
                }
                return `<tr>${rowData.map(d => `<td>${d}</td>`).join('')}</tr>`;
            }).join('');
            return `<div class="table-wrapper align-center"><table class="data-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table></div>`;
        }
        
        function generateRecoveryStudentsReportHTML(institution, classId, period) {
            const periodResult = notesResults.find(r => r.id === `notes-${classId}-${period}`);
            if (!periodResult) return '<p>As m√©dias deste per√≠odo ainda n√£o foram calculadas.</p>';
            const recoveryStudents = alunos.filter(a => a.classId === classId && a.active !== false)
                .map(student => ({ student, score: (periodResult.scores.find(s => s.studentId === student.id) || {}).score }))
                .filter(item => item.score < institution.passingGrade)
                .sort((a, b) => a.student.number - b.student.number);
            if (recoveryStudents.length === 0) return '<p>Nenhum aluno em recupera√ß√£o neste per√≠odo.</p>';
            const rows = recoveryStudents.map(item => `<tr><td>${item.student.number}. ${item.student.name}</td><td>${item.score.toFixed(1).replace('.', ',')}</td></tr>`).join('');
            return `<div class="table-wrapper align-center"><table class="data-table"><thead><tr><th>Aluno</th><th>M√©dia</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        }

        function generateRecoveryGradesReportHTML(institution, classId, period) {
            const recoveries = avaliacoes.filter(av => av.isRecovery && av.classId === classId && av.period === period);
            if(recoveries.length === 0) return '<p>Nenhuma avalia√ß√£o de recupera√ß√£o criada.</p>';
            const studentsWithRecGrades = alunos.filter(a => a.classId === classId && a.active !== false && recoveries.some(rec => rec.grades.some(g => g.studentId === a.id))).sort((a,b) => a.number - b.number);
            if(studentsWithRecGrades.length === 0) return '<p>Nenhuma nota de recupera√ß√£o lan√ßada.</p>';
            const headers = ['Aluno', ...recoveries.map(rec => rec.name)];
            const rows = studentsWithRecGrades.map(student => {
                const rowData = [`${student.number}. ${student.name}`, ...recoveries.map(rec => (rec.grades.find(g => g.studentId === student.id) || {}).grade?.toFixed(1).replace('.',',') || '-')];
                return `<tr>${rowData.map(d => `<td>${d}</td>`).join('')}</tr>`;
            }).join('');
            return `<div class="table-wrapper align-center"><table class="data-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table></div>`;
        }
        
        function generateFinalGradesReportHTML(institution, classId) {
            const studentList = alunos.filter(a => a.classId === classId && a.active !== false).sort((a,b) => a.number - b.number);
            const state = annualRecoveryState[classId] || { added: false, grades: [] };
            const periodMap = { 'Bimestral': { p: ['1¬∫B', '2¬∫B', '3¬∫B', '4¬∫B'], d: 4 }, 'Trimestral': { p: ['1¬∫T', '2¬∫T', '3¬∫T'], d: 3 }, 'Semestral': { p: ['1¬∫S', '2¬∫S'], d: 2 } };
            const { p: periodNames, d: divisor } = periodMap[institution.periodType];
            const periodFullNames = { 'B': 'Bimestre', 'T': 'Trimestre', 'S': 'Semestre' };
        
            let headers = ['Aluno', ...periodNames];
            if(state.added) headers.push('Rec. Anual');
            headers.push('M√©dia Final', 'Situa√ß√£o');
        
            const rows = studentList.map(student => {
                let totalScore = 0, periodCount = 0;
                let rowData = [`${student.number}. ${student.name}`];
                periodNames.forEach((name, i) => {
                    const period = `${i+1}¬∫ ${periodFullNames[name.slice(-1)]}`;
                    const result = notesResults.find(r => r.id === `notes-${classId}-${period}`);
                    let score = result ? (result.scores.find(s => s.studentId === student.id) || {}).score : null;
                    if (score !== null && score !== undefined) {
                        const periodRecovery = avaliacoes.find(av => av.classId === classId && av.period === period && av.recoveryType === 'period');
                        if (periodRecovery) score = Math.max(score, (periodRecovery.grades.find(g => g.studentId === student.id) || {}).grade || score);
                        totalScore += score;
                        periodCount++;
                    }
                    rowData.push((score !== null && score !== undefined) ? score.toFixed(1).replace('.',',') : '-');
                });
        
                let finalAverage = periodCount > 0 ? totalScore / divisor : 0;
                if (state.added) {
                    const recoveryGrade = (state.grades.find(g => g.studentId === student.id) || {}).grade;
                    if (recoveryGrade !== null && recoveryGrade !== undefined) {
                        if (recoveryGrade > finalAverage) finalAverage = recoveryGrade;
                        rowData.push(recoveryGrade.toFixed(1).replace('.',','));
                    } else { rowData.push('-'); }
                }
                const roundedAverage = roundToOneDecimal(finalAverage);
                const isApproved = roundedAverage >= institution.passingGrade;
                const situation = periodCount < divisor ? 'Cursando' : (isApproved ? 'Aprovado' : 'Reprovado');
                rowData.push(roundedAverage.toFixed(1).replace('.',','), situation);
                return `<tr>${rowData.map(d => `<td>${d}</td>`).join('')}</tr>`;
            }).join('');
            return `<div class="table-wrapper align-center"><table class="data-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table></div>`;
        }

        function generateProofRecordHTML(institution, classId, period) {
            const studentList = alunos.filter(a => a.classId === classId && a.active !== false).sort((a,b) => a.number - b.number);
            if (studentList.length === 0) return '<p>Nenhum aluno ativo na turma para gerar a ata.</p>';

            const rows = studentList.map(student => `
                <tr>
                    <td class="col-student">${student.number}. ${student.name}</td>
                    <td class="col-sign"></td>
                    <td class="col-sign"></td>
                </tr>`).join('');
            
            const extraInfo = `
                <div class="report-extra-info">
                    <p>Data: _______/_______/_______</p>
                    <p>Prova: ( &nbsp; &nbsp; ) P1 &nbsp; &nbsp; ( &nbsp; &nbsp; ) P2</p>
                </div>`;

            const table = `
                <div class="table-wrapper align-center">
                    <table class="data-table proof-record-table">
                        <thead>
                            <tr>
                                <th class="col-student">Aluno</th>
                                <th class="col-sign">Assinatura</th>
                                <th class="col-sign">Assinatura de Devolutiva</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;

            return extraInfo + table;
        }
        
        reportFiltersForm.addEventListener('submit', (event) => {
            event.preventDefault();
            generateAndDisplayReport();
        });

        // --- EVENTOS DE BACKUP ---
        exportBackupBtn.addEventListener('click', () => {
            const exportTimestamp = new Date().toISOString();
            const backupData = {
                backupTimestamp: exportTimestamp,
                institutions, anosLetivos, turmas, alunos, avaliacoes, vistos, vistosResults,
                continuousAssessments, continuousAssessmentsResults, notesResults, favorites, annualRecoveryState
            };
            const dataStr = JSON.stringify(backupData, null, 2);
            const link = document.createElement('a');
            const now = new Date();
            const timestamp = `${now.getDate().toString().padStart(2,'0')}_${(now.getMonth()+1).toString().padStart(2,'0')}_${now.getFullYear().toString().slice(-2)}-${now.getHours().toString().padStart(2,'0')}_${now.getMinutes().toString().padStart(2,'0')}`;
            link.href = URL.createObjectURL(new Blob([dataStr], { type: 'application/json' }));
            link.download = `diario_professor_backup_${timestamp}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
            
            localStorage.setItem('backup_export_timestamp_db', exportTimestamp);
            renderFooterStatus();
            showModal('Backup exportado com sucesso!');
        });

        importBackupBtn.addEventListener('click', () => importFileInput.click());

        importFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!await showModal('Importar este backup? TODOS os dados atuais ser√£o substitu√≠dos.', true)) {
                importFileInput.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!['institutions', 'anosLetivos', 'turmas', 'alunos', 'avaliacoes'].every(key => key in data)) {
                        throw new Error('Arquivo de backup inv√°lido.');
                    }
                    // CORRE√á√ÉO: Atribuir diretamente √†s vari√°veis locais, n√£o ao objeto window
                    institutions = data.institutions || [];
                    anosLetivos = data.anosLetivos || [];
                    turmas = data.turmas || [];
                    alunos = data.alunos || [];
                    avaliacoes = data.avaliacoes || [];
                    vistos = data.vistos || [];
                    vistosResults = data.vistosResults || [];
                    continuousAssessments = data.continuousAssessments || [];
                    continuousAssessmentsResults = data.continuousAssessmentsResults || [];
                    notesResults = data.notesResults || [];
                    favorites = data.favorites || [];
                    annualRecoveryState = data.annualRecoveryState || {};
                    
                    saveAllDbs();
                    if (data.backupTimestamp) {
                        localStorage.setItem('backup_import_origin_timestamp_db', data.backupTimestamp);
                    }
                    localStorage.setItem('backup_import_action_timestamp_db', new Date().toISOString());
                    showModal('Backup importado! A aplica√ß√£o ser√° recarregada.').then(() => location.reload());
                } catch (error) {
                    showModal(`Erro ao importar: ${error.message}`);
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.readAsText(file);
        });

        function renderFooterStatus() {
            const importActionTimestampStr = localStorage.getItem('backup_import_action_timestamp_db');
            const exportActionTimestampStr = localStorage.getItem('backup_export_timestamp_db');
            const importOriginTimestampStr = localStorage.getItem('backup_import_origin_timestamp_db');
            const footer = $('#sync-footer');

            const importActionDate = importActionTimestampStr ? new Date(importActionTimestampStr) : null;
            const exportActionDate = exportActionTimestampStr ? new Date(exportActionTimestampStr) : null;

            let message = "Dados locais. Nenhuma opera√ß√£o de backup registrada.";

            if (importActionDate && (!exportActionDate || importActionDate > exportActionDate)) {
                // Last action was an import
                const originDate = importOriginTimestampStr ? new Date(importOriginTimestampStr) : null;
                if (originDate) {
                     message = `√öltima atividade: Restaura√ß√£o (dados de ${originDate.toLocaleDateString('pt-BR')} √†s ${originDate.toLocaleTimeString('pt-BR')})`;
                } else {
                     message = `√öltima atividade: Restaura√ß√£o realizada em ${importActionDate.toLocaleDateString('pt-BR')} √†s ${importActionDate.toLocaleTimeString('pt-BR')}`;
                }
            } else if (exportActionDate) {
                // Last action was an export or it's the only action
                message = `√öltima atividade: Exporta√ß√£o em ${exportActionDate.toLocaleDateString('pt-BR')} √†s ${exportActionDate.toLocaleTimeString('pt-BR')}`;
            }

            footer.textContent = message;
        }

        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
        renderFooterStatus();
        navigateTo('dashboard-view');
    });
    </script>
    <!-- FIM DO JAVASCRIPT -->
</body>
</html>
 
